(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[6],{104:function(e,n,r){"use strict";r.d(n,"a",(function(){return t}));var t=function(e){return new Promise((function(n){return setTimeout(n,e)}))}},162:function(e,n,r){"use strict";r.d(n,"b",(function(){return s})),r.d(n,"a",(function(){return u}));var t=r(1),a=r.n(t),c=r(2),i=r(104),o=new WeakMap,s=function(e,n){if(o.has(e))return e;o.set(e,!0);var r=function(){var r=Object(c.a)(a.a.mark((function r(){var t;return a.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,Object(i.a)(5e3);case 2:!(t=n.getTransceivers().find((function(n){return n.receiver.track===e})))||"inactive"!==t.currentDirection&&"sendonly"!==t.currentDirection||(e.stop(),e.dispatchEvent(new Event("ended")));case 4:case"end":return r.stop()}}),r)})));return function(){return r.apply(this,arguments)}}();return e.addEventListener("mute",r),e},u=function(e){return new Promise(function(){var n=Object(c.a)(a.a.mark((function n(r,t){var c,i,o,s;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,c=new RTCPeerConnection,i=new RTCPeerConnection,c.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&i.addIceCandidate(n)})),i.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&c.addIceCandidate(n)})),i.addEventListener("track",(function(e){r(e.track)})),e.addEventListener("ended",(function(){c.close(),i.close()})),c.addTrack(e),n.next=10,c.createOffer();case 10:return o=n.sent,n.next=13,c.setLocalDescription(o);case 13:return n.next=15,i.setRemoteDescription(o);case 15:return n.next=17,i.createAnswer();case 17:return s=n.sent,n.next=20,i.setLocalDescription(s);case 20:return n.next=22,c.setRemoteDescription(s);case 22:n.next=27;break;case 24:n.prev=24,n.t0=n.catch(0),t(n.t0);case 27:case"end":return n.stop()}}),n,null,[[0,24]])})));return function(e,r){return n.apply(this,arguments)}}())}},188:function(e,n){},291:function(e,n,r){"use strict";r.d(n,"a",(function(){return i}));var t=r(97),a=0,c={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:0.peerjs.com:3478",username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},i=function(){var e=new Map,n=function(n,r,t){var a,c=e.get(n.peer);c&&t.split(/[\r\n]+/).forEach((function(e){if(e.startsWith("a=mid:"))a=e.slice("a=mid:".length);else if(e.startsWith("a=msid:")){e.slice("a=msid:".length).split(" ").forEach((function(e){var n=r[e];"string"===typeof n&&(c.remoteMediaTypes[a]=n)}))}}))};return{setAcceptingMediaTypes:function(n,r){var t=e.get(n.peer);t&&(t.acceptingMediaTypes=r)},getAcceptingMediaTypes:function(n){var r=e.get(n.peer);return r?r.acceptingMediaTypes:[]},addConn:function(n,r){if(e.get(n))throw new Error("addConn: already exists");var t={peerIndex:a+=1,peer:n,userId:r,sendPc:new RTCPeerConnection(c),recvPc:new RTCPeerConnection(c)};return e.set(t.peer,{conn:t,acceptingMediaTypes:[],remoteMediaTypes:{}}),t},getConn:function(n){var r=e.get(n);return r?r.conn:null},findConn:function(n){var r=Array.from(e.values()).find((function(e){return e.conn.peerIndex===n}));return r?r.conn:null},delConn:function(n){var r=e.get(n.peer);if(!r||r.conn!==n)throw new Error("delConn: does not exist");e.delete(n.peer),n.sendPc.close(),n.recvPc.close()},getPeerIndexList:function(){return Array.from(e.values()).map((function(e){return e.conn.peerIndex}))},forEachConns:function(n){Array.from(e.values()).forEach((function(e){n(e.conn)}))},forEachConnsAcceptingMedia:function(n,r){Array.from(e.values()).forEach((function(e){e.acceptingMediaTypes.includes(n)&&r(e.conn)}))},size:function(){return e.size},getRemoteMediaType:function(n,r){var t=e.get(n.peer);return t&&t.remoteMediaTypes[r]||null},registerRemoteMediaType:function(e,r){Object(t.a)(r,"msid2mediaType")&&(Object(t.a)(r,"offer")&&Object(t.b)(r.offer,"sdp")&&n(e,r.msid2mediaType,r.offer.sdp),Object(t.a)(r,"answer")&&Object(t.b)(r.answer,"sdp")&&n(e,r.msid2mediaType,r.answer.sdp))}}}},296:function(e,n){},312:function(e,n){},315:function(e,n){},355:function(e,n){},370:function(e,n){},374:function(e,n){},375:function(e,n){},406:function(e,n){},417:function(e,n){},430:function(e,n){},431:function(e,n){},444:function(e,n){},53:function(e,n,r){"use strict";r.r(n),r.d(n,"createRoom",(function(){return m}));var t=r(108),a=r(1),c=r.n(a),i=r(2),o=r(218),s=r(295),u=r.n(s),d=r(1136),f=r.n(d),p=r(104),v=r(7),l=r(97),b=r(14),x=r(291),h=r(162),m=function(){var e=Object(i.a)(c.a.mark((function e(n,r,a,s,d,m){var y,w,k,g,O,j,I,T,P,E,C,M,D,A,S,L,R,N,J,W,z,_,G,Z,q,B,F,H,K,Q,U,V,X,Y;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return y=!1,w=null,k=null,g=null,O=Object(x.a)(),j=[],I=n.slice(0,b.a),e.next=10,Object(v.h)(n.slice(b.a));case 10:return T=e.sent,P=function(){if(!y){var e=O.getPeerIndexList();a({type:"CONNECTED_PEERS",peerIndexList:e})}},E=function(){var e=Object(i.a)(c.a.mark((function e(n){var r,t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(v.c)(n,T);case 3:if(null!==(r=e.sent)){e.next=6;break}return e.abrupt("return",void 0);case 6:return t=JSON.parse(r),console.log("decrypted payload",t),e.abrupt("return",t);case 11:return e.prev=11,e.t0=e.catch(0),console.info("Error in parsePayload",e.t0,n),e.abrupt("return",void 0);case 15:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(n){return e.apply(this,arguments)}}(),C=function(){var e=Object(i.a)(c.a.mark((function e(n,r){var t,a,i,s,u,d,f;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,console.log("payload to encrypt",n,r),t=!0,a=!1,e.prev=4,s=Object(o.a)(Object(v.f)(JSON.stringify(r),T));case 6:return e.next=8,s.next();case 8:return u=e.sent,t=u.done,e.next=12,u.value;case 12:if(d=e.sent,t){e.next=22;break}if(f=d,w){e.next=18;break}return console.warn("no myIpfs initialized"),e.abrupt("return");case 18:g&&g.broadcast(f);case 19:t=!0,e.next=6;break;case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(4),a=!0,i=e.t0;case 28:if(e.prev=28,e.prev=29,t||null==s.return){e.next=33;break}return e.next=33,s.return();case 33:if(e.prev=33,!a){e.next=36;break}throw i;case 36:return e.finish(33);case 37:return e.finish(28);case 38:e.next=43;break;case 40:e.prev=40,e.t1=e.catch(0),console.error("sendPayload",e.t1);case 43:case"end":return e.stop()}}),e,null,[[0,40],[4,24,28,38],[29,,33,37]])})));return function(n,r){return e.apply(this,arguments)}}(),M=function(){var e=Object(i.a)(c.a.mark((function e(n,r){var t,a,i,s,u,d,f;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=!0,a=!1,e.prev=3,s=Object(o.a)(Object(v.f)(JSON.stringify(r),T));case 5:return e.next=7,s.next();case 7:return u=e.sent,t=u.done,e.next=11,u.value;case 11:if(d=e.sent,t){e.next=18;break}f=d,g&&g.sendTo(n.peer,f);case 15:t=!0,e.next=5;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(3),a=!0,i=e.t0;case 24:if(e.prev=24,e.prev=25,t||null==s.return){e.next=29;break}return e.next=29,s.return();case 29:if(e.prev=29,!a){e.next=32;break}throw i;case 32:return e.finish(29);case 33:return e.finish(24);case 34:e.next=39;break;case 36:e.prev=36,e.t1=e.catch(0),console.error("sendPayloadDirectly",e.t1);case 39:case"end":return e.stop()}}),e,null,[[0,36],[3,20,24,34],[25,,29,33]])})));return function(n,r){return e.apply(this,arguments)}}(),D=function(){var e=Object(i.a)(c.a.mark((function e(n){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y){e.next=2;break}return e.abrupt("return");case 2:return t={userId:r,data:n,mediaTypes:j},e.next=5,C(I,t);case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),A=function(){var e=Object(i.a)(c.a.mark((function e(n,t){var a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y){e.next=2;break}return e.abrupt("return");case 2:if(a=O.findConn(t)){e.next=5;break}return e.abrupt("return");case 5:return i={userId:r,data:n,mediaTypes:j},e.next=8,M(a,i);case 8:case"end":return e.stop()}}),e)})));return function(n,r){return e.apply(this,arguments)}}(),S=function(e){e.length!==j.length&&O.forEachConns((function(n){var r={userId:n.userId,peerIndex:n.peerIndex,mediaTypes:O.getAcceptingMediaTypes(n)},t=n.recvPc.getTransceivers();n.recvPc.getReceivers().forEach((function(a){var c=t.find((function(e){return e.receiver===a})),i=null===c||void 0===c?void 0:c.mid,o=i&&O.getRemoteMediaType(n,i);o?"live"===a.track.readyState&&!j.includes(o)&&e.includes(o)&&m(o,Object(h.b)(a.track,n.recvPc),r):console.warn("failed to find media type from mid")}))})),j=e,D(null)},L=function(){var e=Object(i.a)(c.a.mark((function e(n,r){var a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Q(),e.next=3,M(n,{SDP:Object(t.a)(Object(t.a)({},r),{},{msid2mediaType:a})});case 3:case"end":return e.stop()}}),e)})));return function(n,r){return e.apply(this,arguments)}}(),R=function(){var e=Object(i.a)(c.a.mark((function e(n,r){var t,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(l.c)(r)){e.next=2;break}return e.abrupt("return");case 2:if(Object(l.b)(r,"negotiationId")){e.next=5;break}return console.warn("negotiationId not found in SDP"),e.abrupt("return");case 5:if(t=r.negotiationId,O.registerRemoteMediaType(n,r),!Object(l.a)(r,"offer")){e.next=24;break}return e.prev=8,e.next=11,n.recvPc.setRemoteDescription(r.offer);case 11:return e.next=13,n.recvPc.createAnswer();case 13:return a=e.sent,e.next=16,n.recvPc.setLocalDescription(a);case 16:L(n,{negotiationId:t,answer:a}),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(8),console.info("handleSDP offer failed",e.t0);case 22:e.next=37;break;case 24:if(!Object(l.a)(r,"answer")){e.next=36;break}return N.get(n)===t&&N.delete(n),e.prev=26,e.next=29,n.sendPc.setRemoteDescription(r.answer);case 29:e.next=34;break;case 31:e.prev=31,e.t1=e.catch(26),console.info("handleSDP answer failed",e.t1);case 34:e.next=37;break;case 36:console.warn("unknown SDP",r);case 37:case"end":return e.stop()}}),e,null,[[8,19],[26,31]])})));return function(n,r){return e.apply(this,arguments)}}(),N=new WeakMap,J=function(e){var n=N.has(e);if(N.set(e,Object(v.j)()),!n){var r=function(){var n=Object(i.a)(c.a.mark((function n(){var t,a;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(t=N.get(e)){n.next=3;break}return n.abrupt("return");case 3:return n.next=5,e.sendPc.createOffer();case 5:return a=n.sent,n.next=8,e.sendPc.setLocalDescription(a);case 8:return n.next=10,L(e,{negotiationId:t,offer:a});case 10:return n.next=12,Object(p.a)(5e3);case 12:r();case 13:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();r()}},W=function(e,n){M(e,{ICE:n})},z=function(e,n){if(Object(l.c)(n))if(Object(l.b)(n,"direction"))if(Object(l.a)(n,"candidate"))try{"send"===n.direction?e.recvPc.addIceCandidate(n.candidate):"recv"===n.direction&&e.sendPc.addIceCandidate(n.candidate)}catch(r){console.info("handleCandidate failed",r)}else console.warn("candidate not found in ICE");else console.warn("direction not found in ICE")},_=function(){var e=Object(i.a)(c.a.mark((function e(n,r){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(r)||!r.every((function(e){return"string"===typeof e}))){e.next=5;break}return O.setAcceptingMediaTypes(n,r),e.next=4,Object(p.a)(5e3);case 4:X(n);case 5:case"end":return e.stop()}}),e)})));return function(n,r){return e.apply(this,arguments)}}(),G=function(e,n){var r={userId:e.userId,peerIndex:e.peerIndex,mediaTypes:O.getAcceptingMediaTypes(e)};try{d(n,r)}catch(t){console.warn("receiveData",t)}},Z=function(){var e=Object(i.a)(c.a.mark((function e(n,r){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y){e.next=2;break}return e.abrupt("return");case 2:if(e.prev=2,Object(l.c)(r)){e.next=5;break}return e.abrupt("return");case 5:R(n,r.SDP),z(n,r.ICE),_(n,r.mediaTypes),G(n,r.data),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(2),console.info("Error in handlePayload",e.t0,r);case 14:case"end":return e.stop()}}),e,null,[[2,11]])})));return function(n,r){return e.apply(this,arguments)}}(),q=function(e,n){var r=O.addConn(e,n);return r.sendPc.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&W(r,{direction:"send",candidate:n})})),r.recvPc.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&W(r,{direction:"recv",candidate:n})})),r.recvPc.addEventListener("track",(function(e){var n=e.transceiver.mid,t=n&&O.getRemoteMediaType(r,n);if(t){var a={userId:r.userId,peerIndex:r.peerIndex,mediaTypes:O.getAcceptingMediaTypes(r)};m(t,Object(h.b)(e.track,r.recvPc),a)}else console.warn("failed to find media type from mid")})),s(r.peerIndex),a({type:"NEW_CONNECTION",peerIndex:r.peerIndex}),r},B=function(e){if(!Object(l.c)(e))return null;var n=e.userId;return"string"!==typeof n?null:n},F=function(){var e=Object(i.a)(c.a.mark((function e(n){var r,t,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.from!==k){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,E(n.data);case 4:if(void 0!==(r=e.sent)){e.next=7;break}return e.abrupt("return");case 7:if(t=B(r),(a=O.getConn(n.from))||(t?a=q(n.from,t):console.warn("cannot initialize conn without user id")),!a){e.next=13;break}return e.next=13,Z(a,r);case 13:P();case 14:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),function(){var e=Object(i.a)(c.a.mark((function e(){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a({type:"INITIALIZING_PEER",peerIndex:0}),e.next=3,u.a.create({repo:Object(v.j)(),config:{Addresses:{Swarm:["/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star/"]}}});case 3:return n=e.sent,e.next=6,n.id();case 6:k=e.sent.id,(g=new f.a(n,I)).on("message",F),g.on("peer joined",(function(){D(null)})),g.on("peer left",(function(e){var n=O.getConn(e);n&&(O.delConn(n),a({type:"CONNECTION_CLOSED",peerIndex:n.peerIndex}))})),w=n;case 13:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()(),H=function(){var e=Object(i.a)(c.a.mark((function e(n,r){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.leave();case 2:return e.next=4,n.stop();case 4:case"end":return e.stop()}}),e)})));return function(n,r){return e.apply(this,arguments)}}(),K=new Map,Q=function(){var e={};return K.forEach((function(n,r){var t=n.stream;e[t.id]=r})),e},U=function(e,n){if(K.has(e))throw new Error("track is already added for ".concat(e));var r=new MediaStream([n]);K.set(e,{stream:r,track:n}),O.forEachConnsAcceptingMedia(e,(function(e){try{e.sendPc.addTrack(n,r),J(e)}catch(t){if("InvalidAccessError"!==t.name)throw t}}))},V=function(e){var n=K.get(e);if(n){var r=n.track;K.delete(e),O.forEachConnsAcceptingMedia(e,(function(e){var n=e.sendPc.getSenders().find((function(e){return e.track===r}));n&&(e.sendPc.removeTrack(n),J(e))}))}else console.log("track is already removed for",e)},X=function(e){var n=e.sendPc.getSenders(),r=O.getAcceptingMediaTypes(e);r.forEach((function(r){var t=K.get(r);if(t){var a=t.stream,c=t.track;n.every((function(e){return e.track!==c}))&&(e.sendPc.addTrack(c,a),J(e))}})),n.forEach((function(n){n.track&&(r.some((function(e){var r;return(null===(r=K.get(e))||void 0===r?void 0:r.track)===n.track}))||(e.sendPc.removeTrack(n),J(e)))}))},Y=function(){var e=Object(i.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:y=!0,w&&H(w,g);case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{broadcastData:D,sendData:A,acceptMediaTypes:S,addTrack:U,removeTrack:V,dispose:Y});case 41:case"end":return e.stop()}}),e)})));return function(n,r,t,a,c,i){return e.apply(this,arguments)}}()},97:function(e,n,r){"use strict";r.d(n,"c",(function(){return t})),r.d(n,"b",(function(){return a})),r.d(n,"a",(function(){return c}));var t=function(e){return"object"===typeof e&&null!==e},a=function(e,n){return"string"===typeof e[n]},c=function(e,n){return t(e[n])}}}]);
//# sourceMappingURL=6.e4688b46.chunk.js.map