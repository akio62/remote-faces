{"version":3,"sources":["components/RegionEditor.tsx","components/GatherArea.tsx","hooks/useGatherArea.ts"],"names":["RegionEditor","React","memo","roomId","userId","useState","regionId","setRegionId","isMeeting","setIsMeeting","left","setLeft","top","setTop","width","setWidth","height","setHeight","zIndex","setZIndex","background","setBackground","iframe","setIframe","className","value","onChange","e","target","type","checked","p","Number","max","onClick","data","position","size","getRoomState","ydoc","getMap","set","addRegion","disabled","Region","id","highlight","boxShadow","undefined","style","title","src","frameBorder","Avatar","nickname","statusMesg","image","setPosition","registerOnMouseDrag","stream","muted","isMyself","role","tabIndex","onMouseDown","preventDefault","currentTarget","offset","clientX","clientY","FaceCard","obsoleted","liveMode","micOn","speakerOn","GatherArea","avatar","suspended","videoDeviceId","audioDeviceId","useFaceImages","myImage","roomImages","uid","avatarMap","setAvatarMap","parseInt","slice","myAvatar","setMyAvatar","useEffect","roomState","map","listener","prev","copied","changed","forEach","a","b","userIdMap","x","obj","isAvatarData","Object","keys","observe","unsub","subscribe","unobserve","dataToBroadcast","useRef","current","setTimeout","regionMap","setRegionMap","next","isRegionData","updateRegion","useCallback","useGatherArea","onMouseDragRef","onMouseMove","activeMeetingRegionId","sort","find","useFaceVideos","faceStream","faceStreamMap","showRegionEditor","setShowRegionEditor","onMouseUp","entries","regionData","avatarData","imageData","info","message"],"mappings":"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","file":"static/js/20.4d404b29.chunk.js","sourcesContent":["import React, { useState } from \"react\";\n\nimport { getRoomState } from \"../states/roomMap\";\nimport { RegionData } from \"../hooks/useGatherArea\";\n\nexport const RegionEditor = React.memo<{\n  roomId: string;\n  userId: string;\n}>(({ roomId, userId }) => {\n  const [regionId, setRegionId] = useState(\"\");\n  const [isMeeting, setIsMeeting] = useState(false);\n  const [left, setLeft] = useState(100);\n  const [top, setTop] = useState(100);\n  const [width, setWidth] = useState(100);\n  const [height, setHeight] = useState(100);\n  const [zIndex, setZIndex] = useState(0);\n  const [background, setBackground] = useState(\"\");\n  const [iframe, setIframe] = useState(\"\");\n\n  const addRegion = () => {\n    const data: RegionData = {\n      isMeeting,\n      position: [left, top],\n      size: [width, height],\n      zIndex,\n      background,\n      iframe,\n    };\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(\"gatherRegionMap\");\n    map.set(regionId, data);\n  };\n\n  return (\n    <div className=\"RegionEditor-container\">\n      <h3>Region Editor</h3>\n      <label>\n        Region ID:{\" \"}\n        <input value={regionId} onChange={(e) => setRegionId(e.target.value)} />\n      </label>\n      <hr />\n      <label>\n        Is Meeting:{\" \"}\n        <input\n          type=\"checkbox\"\n          checked={isMeeting}\n          onChange={() => setIsMeeting((p) => !p)}\n        />\n      </label>\n      <hr />\n      <label>\n        Left:{\" \"}\n        <input\n          type=\"number\"\n          value={left}\n          onChange={(e) => setLeft(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        Top:{\" \"}\n        <input\n          type=\"number\"\n          value={top}\n          onChange={(e) => setTop(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        Width:{\" \"}\n        <input\n          type=\"number\"\n          value={width}\n          onChange={(e) => setWidth(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        Height:{\" \"}\n        <input\n          type=\"number\"\n          value={height}\n          onChange={(e) => setHeight(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        zIndex:{\" \"}\n        <input\n          type=\"number\"\n          value={zIndex}\n          max={0}\n          onChange={(e) => setZIndex(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        Background:{\" \"}\n        <input\n          value={background}\n          onChange={(e) => setBackground(e.target.value)}\n        />\n      </label>\n      <hr />\n      <label>\n        Iframe:{\" \"}\n        <input value={iframe} onChange={(e) => setIframe(e.target.value)} />\n      </label>\n      <hr />\n      <button type=\"button\" onClick={() => addRegion()} disabled={!regionId}>\n        Add Region\n      </button>\n    </div>\n  );\n});\n","import React, { useCallback, useRef, useState } from \"react\";\n\nimport \"./GatherArea.css\";\nimport { useGatherArea, RegionData } from \"../hooks/useGatherArea\";\nimport { useFaceImages } from \"../hooks/useFaceImages\";\nimport { useFaceVideos } from \"../hooks/useFaceVideos\";\nimport { RegionEditor } from \"./RegionEditor\";\nimport { FaceCard } from \"./FaceCard\";\n\ntype OnMouseMove = (e: React.MouseEvent<HTMLDivElement, MouseEvent>) => void;\n\nconst Region = React.memo<{\n  id: string;\n  data: RegionData;\n  highlight?: boolean;\n}>(({ id, data, highlight }) => {\n  const boxShadow =\n    (data.isMeeting && (highlight ? \"0 0 0 5px pink\" : \"0 0 0 1px pink\")) ||\n    undefined;\n  return (\n    <div\n      className=\"GatherArea-region\"\n      style={{\n        left: `${data.position[0]}px`,\n        top: `${data.position[1]}px`,\n        width: `${data.size[0]}px`,\n        height: `${data.size[1]}px`,\n        boxShadow,\n        zIndex: data.zIndex,\n        background: data.background,\n      }}\n    >\n      {data.iframe && <iframe title={id} src={data.iframe} frameBorder=\"0\" />}\n    </div>\n  );\n});\n\nconst Avatar = React.memo<{\n  nickname: string;\n  statusMesg: string;\n  image?: string;\n  position: [left: number, top: number];\n  setPosition?: (nextPosition: [number, number]) => void;\n  registerOnMouseDrag: (onMouseMove?: OnMouseMove) => void;\n  stream?: MediaStream;\n  muted?: boolean;\n}>(\n  ({\n    nickname,\n    statusMesg,\n    image,\n    position,\n    setPosition,\n    registerOnMouseDrag,\n    stream,\n    muted,\n  }) => {\n    const isMyself = !!setPosition;\n    return (\n      <div\n        className=\"GatherArea-avatar\"\n        style={{\n          left: `${position[0]}px`,\n          top: `${position[1]}px`,\n        }}\n        role=\"button\"\n        tabIndex={-1}\n        onMouseDown={(e) => {\n          e.preventDefault();\n          if (isMyself) {\n            const target = e.currentTarget;\n            const offset = [e.clientX - position[0], e.clientY - position[1]];\n            registerOnMouseDrag((e) => {\n              const left = e.clientX - offset[0];\n              const top = e.clientY - offset[1];\n              target.style.left = `${left}px`;\n              target.style.top = `${top}px`;\n              setPosition?.([left, top]);\n            });\n          }\n        }}\n      >\n        <FaceCard\n          image={image}\n          nickname={nickname}\n          statusMesg={statusMesg}\n          obsoleted={false}\n          liveMode={!!stream}\n          stream={stream}\n          muted={!!muted}\n          micOn={!!stream}\n          speakerOn={!!stream}\n        />\n      </div>\n    );\n  }\n);\n\nexport const GatherArea = React.memo<{\n  roomId: string;\n  userId: string;\n  avatar: string;\n  nickname: string;\n  statusMesg: string;\n  suspended: boolean;\n  videoDeviceId?: string;\n  audioDeviceId?: string;\n}>(\n  ({\n    roomId,\n    userId,\n    avatar,\n    nickname,\n    statusMesg,\n    suspended,\n    videoDeviceId,\n    audioDeviceId,\n  }) => {\n    const { myImage, roomImages } = useFaceImages(\n      roomId,\n      userId,\n      avatar,\n      nickname,\n      statusMesg,\n      suspended,\n      false,\n      false,\n      false,\n      videoDeviceId\n    );\n    const { avatarMap, myAvatar, setMyAvatar, regionMap } = useGatherArea(\n      roomId,\n      userId\n    );\n\n    const onMouseDragRef = useRef<OnMouseMove>();\n    const registerOnMouseDrag = useCallback((onMouseMove?: OnMouseMove) => {\n      onMouseDragRef.current = onMouseMove;\n    }, []);\n\n    const regionIdList = Object.keys(regionMap).sort(\n      (a, b) => (regionMap[b].zIndex ?? 0) - (regionMap[a].zIndex ?? 0)\n    );\n    const activeMeetingRegionId = regionIdList.find((id) => {\n      const { isMeeting, position, size } = regionMap[id] as RegionData;\n      return (\n        isMeeting &&\n        position[0] <= myAvatar.position[0] &&\n        position[1] <= myAvatar.position[1] &&\n        myAvatar.position[0] + 36 <= position[0] + size[0] &&\n        myAvatar.position[1] + 36 <= position[1] + size[1]\n      );\n    });\n\n    const { faceStream, faceStreamMap } = useFaceVideos(\n      roomId,\n      userId,\n      !!activeMeetingRegionId,\n      !!activeMeetingRegionId,\n      true,\n      videoDeviceId,\n      audioDeviceId,\n      `gatherArea/meeting/${activeMeetingRegionId}/`\n    );\n\n    const [showRegionEditor, setShowRegionEditor] = useState(false);\n\n    return (\n      <div className=\"GatherArea-container\">\n        <div\n          className=\"GatherArea-body\"\n          role=\"button\"\n          tabIndex={-1}\n          onMouseDown={(e) => {\n            e.preventDefault();\n          }}\n          onMouseMove={(e) => {\n            if (onMouseDragRef.current) {\n              onMouseDragRef.current(e);\n            }\n          }}\n          onMouseUp={() => {\n            registerOnMouseDrag();\n          }}\n        >\n          {Object.entries(regionMap).map(([regionId, regionData]) => (\n            <Region\n              key={regionId}\n              id={regionId}\n              data={regionData}\n              highlight={regionId === activeMeetingRegionId}\n            />\n          ))}\n          {Object.entries(avatarMap).map(([uid, avatarData]) => {\n            if (uid === userId) {\n              return null;\n            }\n            const imageData = roomImages.find((data) => data.userId === uid);\n            if (!imageData) {\n              return null;\n            }\n            return (\n              <Avatar\n                key={uid}\n                nickname={imageData.info.nickname}\n                statusMesg={imageData.info.message}\n                image={imageData.image}\n                position={avatarData.position}\n                registerOnMouseDrag={registerOnMouseDrag}\n                stream={faceStreamMap[uid]}\n              />\n            );\n          })}\n          <Avatar\n            nickname={nickname}\n            statusMesg={statusMesg}\n            image={myImage}\n            position={myAvatar.position}\n            setPosition={(position) =>\n              setMyAvatar((prev) => ({ ...prev, position }))\n            }\n            registerOnMouseDrag={registerOnMouseDrag}\n            stream={faceStream || undefined}\n            muted\n          />\n        </div>\n        <div className=\"GatherArea-toolbar\">\n          <div>\n            <button\n              type=\"button\"\n              onClick={() => setShowRegionEditor((p) => !p)}\n            >\n              {showRegionEditor ? \"Close Region Editor\" : \"Open Region Editor\"}\n            </button>\n            {showRegionEditor && (\n              <div className=\"GatherArea-region-editor\">\n                <RegionEditor roomId={roomId} userId={userId} />\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    );\n  }\n);\n\nexport default GatherArea;\n","import { useCallback, useState, useRef, useEffect } from \"react\";\nimport { subscribe } from \"valtio\";\n\nimport { getRoomState } from \"../states/roomMap\";\n\nconst getInitialPosition = (uid: string): [number, number] => [\n  parseInt(uid.slice(0, 2), 16) / 2 + 20,\n  parseInt(uid.slice(2, 4), 16) / 2 + 20,\n];\n\nexport type AvatarData = {\n  position: [left: number, top: number];\n};\n\nconst isAvatarData = (x: unknown): x is AvatarData => {\n  try {\n    const obj = x as AvatarData;\n    if (\n      typeof obj.position[0] === \"number\" &&\n      typeof obj.position[1] === \"number\"\n    ) {\n      return true;\n    }\n    return false;\n  } catch (e) {\n    return false;\n  }\n};\n\nconst isEqualAvatarData = (a: AvatarData, b: AvatarData) =>\n  a.position[0] === b.position[0] && a.position[1] === b.position[1];\n\nexport type RegionData = {\n  isMeeting: boolean;\n  position: [left: number, top: number];\n  size: [width: number, height: number];\n  zIndex?: number;\n  background?: string;\n  iframe?: string;\n};\n\nconst isRegionData = (x: unknown): x is RegionData => {\n  try {\n    const obj = x as RegionData;\n    if (\n      typeof obj.isMeeting === \"boolean\" &&\n      typeof obj.position[0] === \"number\" &&\n      typeof obj.position[1] === \"number\" &&\n      typeof obj.size[0] === \"number\" &&\n      typeof obj.size[1] === \"number\" &&\n      (typeof obj.zIndex === \"undefined\" || typeof obj.zIndex === \"number\") &&\n      (typeof obj.background === \"undefined\" ||\n        typeof obj.background === \"string\") &&\n      (typeof obj.iframe === \"undefined\" || typeof obj.iframe === \"string\")\n    ) {\n      return true;\n    }\n    return false;\n  } catch (e) {\n    return false;\n  }\n};\n\nconst isEqualRegionData = (a: RegionData, b: RegionData) =>\n  a.isMeeting === b.isMeeting &&\n  a.position[0] === b.position[0] &&\n  a.position[1] === b.position[1] &&\n  a.size[0] === b.size[0] &&\n  a.size[1] === b.size[1] &&\n  a.zIndex === b.zIndex &&\n  a.background === b.background &&\n  a.iframe === b.iframe;\n\nexport type AvatarMap = {\n  [userId: string]: AvatarData;\n};\n\nexport type RegionMap = {\n  [regionId: string]: RegionData;\n};\n\nexport const useGatherArea = (roomId: string, userId: string) => {\n  const [avatarMap, setAvatarMap] = useState<AvatarMap>({});\n  const [myAvatar, setMyAvatar] = useState<AvatarData>({\n    position: getInitialPosition(userId),\n  });\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(\"gatherAvatarMap\");\n    const listener = () => {\n      setAvatarMap((prev) => {\n        const copied = { ...prev };\n        let changed = false;\n        map.forEach((data, uid) => {\n          if (uid === userId) return;\n          if (!roomState.userIdMap[uid]) return;\n          if (!isAvatarData(data)) return;\n          if (!copied[uid]) {\n            copied[uid] = data;\n            changed = true;\n          } else if (!isEqualAvatarData(data, copied[uid])) {\n            copied[uid] = data;\n            changed = true;\n          }\n        });\n        Object.keys(copied).forEach((uid) => {\n          if (!roomState.userIdMap[uid]) {\n            delete copied[uid];\n            changed = true;\n          }\n        });\n        if (changed) {\n          return copied;\n        }\n        return prev;\n      });\n    };\n    map.observe(listener);\n    const unsub = subscribe(roomState.userIdMap, listener);\n    listener();\n    return () => {\n      unsub();\n      map.unobserve(listener);\n    };\n  }, [roomId, userId]);\n\n  const dataToBroadcast = useRef<AvatarData>();\n  useEffect(() => {\n    if (!myAvatar) return;\n    if (dataToBroadcast.current) {\n      dataToBroadcast.current = myAvatar;\n    } else {\n      dataToBroadcast.current = myAvatar;\n      setTimeout(() => {\n        const roomState = getRoomState(roomId, userId);\n        const map = roomState.ydoc.getMap(\"gatherAvatarMap\");\n        map.set(userId, dataToBroadcast.current);\n        dataToBroadcast.current = undefined;\n      }, 500);\n    }\n  }, [roomId, userId, myAvatar]);\n\n  const [regionMap, setRegionMap] = useState<RegionMap>({});\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(\"gatherRegionMap\");\n    const listener = () => {\n      setRegionMap((prev) => {\n        const next: RegionMap = {};\n        map.forEach((data, id) => {\n          if (!isRegionData(data)) return;\n          if (prev[id] && isEqualRegionData(prev[id], data)) {\n            next[id] = prev[id];\n          } else {\n            next[id] = data;\n          }\n        });\n        return next;\n      });\n    };\n    map.observe(listener);\n    listener();\n    return () => {\n      map.unobserve(listener);\n    };\n  }, [roomId, userId]);\n\n  const updateRegion = useCallback(\n    (id: string, data: RegionData) => {\n      const roomState = getRoomState(roomId, userId);\n      const map = roomState.ydoc.getMap(\"gatherRegionMap\");\n      map.set(id, data);\n    },\n    [roomId, userId]\n  );\n\n  return {\n    avatarMap,\n    myAvatar,\n    setMyAvatar,\n    regionMap,\n    updateRegion,\n  };\n};\n"],"sourceRoot":""}