(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[7],{104:function(e,n,t){"use strict";t.d(n,"a",(function(){return r}));var r=function(e){return new Promise((function(n){return setTimeout(n,e)}))}},162:function(e,n,t){"use strict";t.d(n,"c",(function(){return i})),t.d(n,"b",(function(){return f})),t.d(n,"d",(function(){return p})),t.d(n,"a",(function(){return b}));var r=t(5),a=t(1),c=t.n(a),u=t(2),s=t(104),o=new WeakMap,i=function(e,n){if(o.has(e))return e;o.set(e,!0);var t=function(){var t=Object(u.a)(c.a.mark((function t(){var r;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Object(s.a)(5e3);case 2:!(r=n.getTransceivers().find((function(n){return n.receiver.track===e})))||"inactive"!==r.currentDirection&&"sendonly"!==r.currentDirection||(e.stop(),e.dispatchEvent(new Event("ended")));case 4:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();return e.addEventListener("mute",t),e},f=function(e){return new Promise(function(){var n=Object(u.a)(c.a.mark((function n(t,r){var a,u,s,o;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,a=new RTCPeerConnection,u=new RTCPeerConnection,a.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&u.addIceCandidate(n)})),u.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&a.addIceCandidate(n)})),u.addEventListener("track",(function(e){t(e.track)})),e.addEventListener("ended",(function(){a.close(),u.close()})),a.addTrack(e),n.next=10,a.createOffer();case 10:return s=n.sent,n.next=13,a.setLocalDescription(s);case 13:return n.next=15,u.setRemoteDescription(s);case 15:return n.next=17,u.createAnswer();case 17:return o=n.sent,n.next=20,u.setLocalDescription(o);case 20:return n.next=22,a.setRemoteDescription(o);case 22:n.next=27;break;case 24:n.prev=24,n.t0=n.catch(0),r(n.t0);case 27:case"end":return n.stop()}}),n,null,[[0,24]])})));return function(e,t){return n.apply(this,arguments)}}())},p=function(){var e=Object(u.a)(c.a.mark((function e(n){var t,r,a,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("video"===n.kind){e.next=2;break}throw new Error("track kind is not video");case 2:return t=document.createElement("canvas"),r=t.getContext("2d"),a=new ImageCapture(n),s=function(){var e=Object(u.a)(c.a.mark((function e(){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.grabFrame();case 3:return n=e.sent,t.width=n.width,t.height=n.height,r.drawImage(n,0,0),e.abrupt("return",t.toDataURL("image/jpeg"));case 10:return e.prev=10,e.t0=e.catch(0),console.log("failed to grab frame from viedeo track",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{getImage:s});case 7:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),d=function(e){return new Promise((function(n,t){var r=new Image;r.onload=function(){return n(r)},r.onerror=t,r.src=e}))},b=function(){var e=document.createElement("canvas"),n=e.getContext("2d"),t=e.captureStream().getVideoTracks();return{videoTrack:Object(r.a)(t,1)[0],setImage:function(){var t=Object(u.a)(c.a.mark((function t(r){var a;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,d(r);case 2:a=t.sent,e.width=a.width,e.height=a.height,n.drawImage(a,0,0);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}}},188:function(e,n){},295:function(e,n){},311:function(e,n){},314:function(e,n){},354:function(e,n){},369:function(e,n){},373:function(e,n){},374:function(e,n){},405:function(e,n){},416:function(e,n){},429:function(e,n){},430:function(e,n){},443:function(e,n){},53:function(e,n,t){"use strict";t.r(n),t.d(n,"createRoom",(function(){return w}));var r=t(1),a=t.n(r),c=t(2),u=t(218),s=t(294),o=t.n(s),i=t(104),f=t(7),p=t(99),d=t(14),b=0,v=function(){var e=new Map;return{setAcceptingMediaTypes:function(n,t){var r=e.get(n.peer);r&&(r.acceptingMediaTypes=t)},getAcceptingMediaTypes:function(n){var t=e.get(n.peer);return t?t.acceptingMediaTypes:[]},addConn:function(n,t){if(e.get(n))throw new Error("addConn: already exists");var r={peerIndex:b+=1,peer:n,userId:t,audioWorkers:new Map,vidoeSetImages:new Map};return e.set(r.peer,{conn:r,acceptingMediaTypes:[]}),r},getConn:function(n){var t=e.get(n);return t?t.conn:null},findConn:function(n){var t=Array.from(e.values()).find((function(e){return e.conn.peerIndex===n}));return t?t.conn:null},delConn:function(n){var t=e.get(n.peer);if(!t||t.conn!==n)throw new Error("delConn: does not exist");e.delete(n.peer)},getPeerIndexList:function(){return Array.from(e.values()).map((function(e){return e.conn.peerIndex}))},forEachConns:function(n){Array.from(e.values()).forEach((function(e){n(e.conn)}))},size:function(){return e.size}}},x=t(162),l=new Map,h=function(){var e=Object(c.a)(a.a.mark((function e(n,t){var r,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r="".concat(n," ").concat(t),c=l.get(r)){e.next=7;break}return e.next=5,Object(f.k)(r);case 5:c=e.sent.slice(0,d.a),l.set(r,c);case 7:return e.abrupt("return",c);case 8:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),w=function(){var e=Object(c.a)(a.a.mark((function e(n,t,r,s,b,l){var w,k,m,y,g,O,j,I,E,T,C,A,M,S,N,W,D,L,P,R,_,V,z,J,B,F,G,U,Z,q,H;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w=!1,k=v(),m=[],y=n.slice(0,d.a),e.next=7,Object(f.h)(n.slice(d.a));case 7:return g=e.sent,r({type:"INITIALIZING_PEER",peerIndex:0}),e.next=11,o.a.create({repo:Object(f.j)(),config:{Addresses:{Swarm:["/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star/"]}}});case 11:return O=e.sent,e.next=14,O.id();case 14:return j=e.sent.id,e.next=17,O.pubsub.subscribe(y,(function(e){return V(e)}));case 17:return e.next=19,O.pubsub.subscribe("".concat(y," ").concat(j),(function(e){return V(e)}));case 19:return I=function(){var e=Object(c.a)(a.a.mark((function e(n){var t,r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(f.c)(n,g);case 3:if(null!==(t=e.sent)){e.next=6;break}return e.abrupt("return",void 0);case 6:return r=JSON.parse(t),console.log("decrypted payload",r),e.abrupt("return",r);case 11:return e.prev=11,e.t0=e.catch(0),console.info("Error in parsePayload",e.t0,n),e.abrupt("return",void 0);case 15:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(n){return e.apply(this,arguments)}}(),E=function(){var e=Object(c.a)(a.a.mark((function e(n,t){var r,c,s,o,i,p,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,console.log("payload to encrypt",n,t),r=!0,c=!1,e.prev=4,o=Object(u.a)(Object(f.f)(JSON.stringify(t),g));case 6:return e.next=8,o.next();case 8:return i=e.sent,r=i.done,e.next=12,i.value;case 12:if(p=e.sent,r){e.next=20;break}return d=p,e.next=17,O.pubsub.publish(n,d);case 17:r=!0,e.next=6;break;case 20:e.next=26;break;case 22:e.prev=22,e.t0=e.catch(4),c=!0,s=e.t0;case 26:if(e.prev=26,e.prev=27,r||null==o.return){e.next=31;break}return e.next=31,o.return();case 31:if(e.prev=31,!c){e.next=34;break}throw s;case 34:return e.finish(31);case 35:return e.finish(26);case 36:e.next=41;break;case 38:e.prev=38,e.t1=e.catch(0),console.error("sendPayload",e.t1);case 41:case"end":return e.stop()}}),e,null,[[0,38],[4,22,26,36],[27,,31,35]])})));return function(n,t){return e.apply(this,arguments)}}(),T=function(){var e=Object(c.a)(a.a.mark((function e(n,t){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="".concat(y," ").concat(n.peer),e.next=3,E(r,t);case 3:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),C=function(){var e=Object(c.a)(a.a.mark((function e(n){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!w){e.next=2;break}return e.abrupt("return");case 2:return r={userId:t,data:n,mediaTypes:m},e.next=5,E(y,r);case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),A=function(){var e=Object(c.a)(a.a.mark((function e(n,r){var c,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!w){e.next=2;break}return e.abrupt("return");case 2:if(c=k.findConn(r)){e.next=5;break}return e.abrupt("return");case 5:return u={userId:t,data:n,mediaTypes:m},e.next=8,T(c,u);case 8:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),M=new Map,S=function(){var e=Object(c.a)(a.a.mark((function e(t){var r,u,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],M.set(t,r),e.next=4,h(n,t);case 4:u=e.sent,s=function(){var e=Object(c.a)(a.a.mark((function e(n){var c,u,s,o,i,p,d,b,v,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.from!==j){e.next=2;break}return e.abrupt("return");case 2:if(c=k.getConn(n.from)){e.next=6;break}return console.warn("conn not ready"),e.abrupt("return");case 6:if(u={userId:c.userId,peerIndex:c.peerIndex,mediaTypes:k.getAcceptingMediaTypes(c)},c.audioWorkers.has(t)){e.next=24;break}return s=new AudioContext,o=s.createMediaStreamDestination(),i=0,p=0,(d=new Worker("audio-decoder.js",{type:"module"})).onmessage=function(e){var n=new Float32Array(e.data);p||(i=s.currentTime),i+=.06,p+=1;var t=s.createBuffer(1,2880,48e3);t.copyToChannel(n,0);var r=s.createBufferSource();r.buffer=t,r.connect(o),r.onended=function(){p-=1},r.start(i)},c.audioWorkers.set(t,d),b=o.stream.getAudioTracks()[0],e.t0=l,e.t1=t,e.next=20,Object(x.b)(b);case 20:e.t2=e.sent,e.t3=u,(0,e.t0)(e.t1,e.t2,e.t3),r.push((function(){s.close(),b.dispatchEvent(new Event("ended")),d.terminate(),c.audioWorkers.delete(t)}));case 24:return e.next=26,Object(f.a)(n.data.buffer,n.data.byteOffset,n.data.byteLength,g);case 26:v=e.sent,(h=c.audioWorkers.get(t))&&v.forEach((function(e){h.postMessage([e],[e])}));case 29:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),O.pubsub.subscribe(u,s),r.unshift((function(){O.pubsub.unsubscribe(u,s)}));case 8:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),N=function(){var e=Object(c.a)(a.a.mark((function e(t){var r,u,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],M.set(t,r),e.next=4,h(n,t);case 4:u=e.sent,s=function(){var e=Object(c.a)(a.a.mark((function e(n){var c,u,s,o,i,p,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.from!==j){e.next=2;break}return e.abrupt("return");case 2:if(c=k.getConn(n.from)){e.next=6;break}return console.warn("conn not ready"),e.abrupt("return");case 6:return u={userId:c.userId,peerIndex:c.peerIndex,mediaTypes:k.getAcceptingMediaTypes(c)},c.vidoeSetImages.has(t)||(s=Object(x.a)(),o=s.videoTrack,i=s.setImage,c.vidoeSetImages.set(t,i),l(t,o,u),r.push((function(){o.dispatchEvent(new Event("ended")),c.vidoeSetImages.delete(t)}))),p=c.vidoeSetImages.get(t),e.prev=9,e.next=12,Object(f.c)(n.data,g);case 12:d=e.sent,p&&d&&p(d),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(9),console.info("Error in parse for video media",e.t0);case 19:case"end":return e.stop()}}),e,null,[[9,16]])})));return function(n){return e.apply(this,arguments)}}(),O.pubsub.subscribe(u,s),r.unshift((function(){O.pubsub.unsubscribe(u,s)}));case 8:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),W=function(e){w||(M.forEach((function(n,t){e.includes(t)||(n.forEach((function(e){return e()})),M.delete(t))})),e.forEach((function(e){if(!M.has(e))if(e.endsWith("Audio"))S(e);else{if(!e.endsWith("Video"))throw new Error("pubsubRoom: cannot guess mediaType (Audio/Video)");N(e)}})),m=e,C(null))},D=function(){var e=Object(c.a)(a.a.mark((function e(n,t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Array.isArray(t)&&t.every((function(e){return"string"===typeof e}))&&k.setAcceptingMediaTypes(n,t);case 1:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),L=function(e,n){var t={userId:e.userId,peerIndex:e.peerIndex,mediaTypes:k.getAcceptingMediaTypes(e)};try{b(n,t)}catch(r){console.warn("receiveData",r)}},P=function(){var e=Object(c.a)(a.a.mark((function e(n,t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,Object(p.c)(t)){e.next=3;break}return e.abrupt("return");case 3:D(n,t.mediaTypes),L(n,t.data),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),console.info("Error in handlePayload",e.t0,t);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(n,t){return e.apply(this,arguments)}}(),R=function(e,n){var t=k.addConn(e,n);return s(t.peerIndex),r({type:"NEW_CONNECTION",peerIndex:t.peerIndex}),t},_=function(e){if(!Object(p.c)(e))return null;var n=e.userId;return"string"!==typeof n?null:n},V=function(){var e=Object(c.a)(a.a.mark((function e(n){var t,c,u,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!w){e.next=2;break}return e.abrupt("return");case 2:if(n.from!==j){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,I(n.data);case 6:if(void 0!==(t=e.sent)){e.next=9;break}return e.abrupt("return");case 9:if(c=_(t),(u=k.getConn(n.from))||(c?u=R(n.from,c):console.warn("cannot initialize conn without user id")),!u){e.next=15;break}return e.next=15,P(u,t);case 15:s=k.getPeerIndexList(),r({type:"CONNECTED_PEERS",peerIndexList:s});case 17:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),(z=function(){var e=Object(c.a)(a.a.mark((function e(){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!w){e.next=2;break}return e.abrupt("return");case 2:if(n=O.pubsub.peers(y),k.forEachConns((function(e){n.includes(e.peer)||(k.delConn(e),r({type:"CONNECTION_CLOSED",peerIndex:e.peerIndex}))})),n.length){e.next=10;break}return r({type:"CONNECTING_SEED_PEERS"}),e.next=8,Object(i.a)(1e3);case 8:return z(),e.abrupt("return");case 10:if(k.size()){e.next=13;break}return e.next=13,C(null);case 13:return e.next=15,Object(i.a)(5e3);case 15:z();case 16:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}())(),J=new WeakMap,B=function(e){e&&e()},F=function(){var e=Object(c.a)(a.a.mark((function e(t,r){var u,s,o,i,p,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return B(J.get(r)),u=new MediaStream([r]),s=new AudioContext,o=s.createMediaStreamSource(u),e.next=6,s.audioWorklet.addModule("audio-encoder.js");case 6:return i=new AudioWorkletNode(s,"audio-encoder"),e.next=9,h(n,t);case 9:p=e.sent,d=[],i.port.onmessage=function(){var e=Object(c.a)(a.a.mark((function e(n){var t;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(d.push(n.data),!(d.length<40)){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,Object(f.d)(d.splice(0,d.length),g);case 5:t=e.sent,O.pubsub.publish(p,t);case 7:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),o.connect(i),J.set(r,(function(){s.close()}));case 14:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),G=function(){var e=Object(c.a)(a.a.mark((function e(t,r){var s,o,p,d,b;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return B(J.get(r)),e.next=3,h(n,t);case 3:return s=e.sent,e.next=6,Object(x.d)(r);case 6:o=e.sent,p=o.getImage,d=!1,(b=function(){var e=Object(c.a)(a.a.mark((function e(){var n,t,r,c,o,v,x,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!d){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,p();case 4:if(!(n=e.sent)){e.next=46;break}t=!0,r=!1,e.prev=8,o=Object(u.a)(Object(f.f)(n,g));case 10:return e.next=12,o.next();case 12:return v=e.sent,t=v.done,e.next=16,v.value;case 16:if(x=e.sent,t){e.next=28;break}if(l=x,!d){e.next=21;break}return e.abrupt("return");case 21:return e.next=23,O.pubsub.publish(s,l);case 23:return e.next=25,Object(i.a)(1e3);case 25:t=!0,e.next=10;break;case 28:e.next=34;break;case 30:e.prev=30,e.t0=e.catch(8),r=!0,c=e.t0;case 34:if(e.prev=34,e.prev=35,t||null==o.return){e.next=39;break}return e.next=39,o.return();case 39:if(e.prev=39,!r){e.next=42;break}throw c;case 42:return e.finish(39);case 43:return e.finish(34);case 44:e.next=48;break;case 46:return e.next=48,Object(i.a)(5e3);case 48:b();case 49:case"end":return e.stop()}}),e,null,[[8,30,34,44],[35,,39,43]])})));return function(){return e.apply(this,arguments)}}())(),J.set(r,(function(){d=!0}));case 12:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),U=new Map,Z=function(){var e=Object(c.a)(a.a.mark((function e(n,t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!w){e.next=2;break}return e.abrupt("return");case 2:if(!U.has(n)){e.next=4;break}throw new Error("track is already added for ".concat(n));case 4:if(U.set(n,t),!n.endsWith("Audio")){e.next=9;break}F(n,t),e.next=14;break;case 9:if(!n.endsWith("Video")){e.next=13;break}G(n,t),e.next=14;break;case 13:throw new Error("pubsubRoom: cannot guess mediaType (Audio/Video)");case 14:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),q=function(e){if(!w){var n=U.get(e);n?(U.delete(e),B(J.get(n))):console.log("track is already removed for",e)}},H=function(){var e=Object(c.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w=!0,e.next=3,O.pubsub.unsubscribe("".concat(y," ").concat(j),V);case 3:return e.next=5,O.pubsub.unsubscribe(y,V);case 5:return e.next=7,O.stop();case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{broadcastData:C,sendData:A,acceptMediaTypes:W,addTrack:Z,removeTrack:q,dispose:H});case 47:case"end":return e.stop()}}),e)})));return function(n,t,r,a,c,u){return e.apply(this,arguments)}}()},99:function(e,n,t){"use strict";t.d(n,"c",(function(){return r})),t.d(n,"b",(function(){return a})),t.d(n,"a",(function(){return c}));var r=function(e){return"object"===typeof e&&null!==e},a=function(e,n){return"string"===typeof e[n]},c=function(e,n){return r(e[n])}}}]);
//# sourceMappingURL=7.a558a454.chunk.js.map