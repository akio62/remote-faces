(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[16],{1234:function(e,t,a){},1255:function(e,t,a){"use strict";a.r(t),a.d(t,"SpatialArea",(function(){return g}));var n=a(1),r=a.n(n),c=a(2),i=a(5),u=a(0),o=a.n(u),s=a(332),l=a(1248),p=a(1246),f=(a(1234),a(524)),v=a(525),m=a(112),b=a(119),j=a(108),O=a(125),d=function(e){try{var t=e;return"number"===typeof t.position[0]&&"number"===typeof t.position[1]&&"number"===typeof t.position[2]}catch(a){return!1}},y=function(e){return Object(j.c)(e)&&function(e){return Object(j.c)(e)&&Object.values(e).every(d)}(e.avatarMap)&&"number"===typeof e.updatedAt},E=function(e,t){var a=Object(u.useState)({}),n=Object(i.a)(a,2),r=n[0],c=n[1],o=Object(u.useState)(),s=Object(i.a)(o,2),l=s[0],p=s[1],d=Object(u.useRef)();Object(u.useEffect)((function(){d.current={avatarMap:Object(b.a)(Object(b.a)({},r),l&&Object(m.a)({},t,l)),updatedAt:Date.now()}}),[t,r,l]);var E=Object(O.a)(e,t),k=Object(u.useRef)();return Object(u.useEffect)((function(){if(d.current){var e={spatialArea:"sync",areaData:d.current};k.current?k.current=e:(k.current=e,setTimeout((function(){E(e),k.current=void 0}),200))}}),[E,t,l]),Object(O.b)(e,t,Object(u.useCallback)((function(e){var a;if(a=e,Object(j.c)(a)&&("init"===a.spatialArea||"sync"===a.spatialArea&&y(a.areaData)))if("init"!==e.spatialArea){var n=e.areaData;if(!(n.updatedAt<Date.now()-1e3)){var r=n.avatarMap,i=(r[t],Object(f.a)(r,[t].map(v.a)));c((function(e){var t=Object.keys(e),a=Object.keys(i);return t.length===a.length&&t.every((function(t){return a=e[t],(n=i[t])&&a.position[0]===n.position[0]&&a.position[1]===n.position[1]&&a.position[2]===n.position[2];var a,n}))?e:Object(b.a)(Object(b.a)({},e),i)}))}}else d.current&&E({spatialArea:"sync",areaData:d.current})}),[t,E])),Object(u.useEffect)((function(){E({spatialArea:"init"})}),[E]),{avatarMap:r,myAvatar:l,setMyAvatar:p}},k=a(333),A=a(523),S=a(206),h=o.a.memo((function(e){var t=e.nickname,a=e.faceStream,n=e.position,f=e.setPosition,v=Object(l.b)(),m=v.size,b=v.viewport,j=m.width/b.width,O=Object(u.useRef)(),d=Object(p.a)((function(e){var t=e.first,a=Object(i.a)(e.initial,2),r=a[0],c=a[1],u=Object(i.a)(e.xy,2),o=u[0],s=u[1];t&&(O.current=n);var l=O.current,p=Object(i.a)(l,2),v=p[0],m=p[1];f&&f([v+(o-r)/j,m-(s-c)/j,0])})),y=Object(u.useState)(),E=Object(i.a)(y,2),k=E[0],A=E[1];return Object(u.useEffect)((function(){var e=null===a||void 0===a?void 0:a.getVideoTracks()[0];if(e){var n=document.createElement("canvas"),i=new s.CanvasTexture(n);A(i);var u=new ImageCapture(e),o=n.getContext("2d"),l=setInterval(Object(c.a)(r.a.mark((function e(){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u.grabFrame();case 3:a=e.sent,n.width=a.width,n.height=a.height,o.drawImage(a,0,0),o.font="18px selif",o.textBaseline="top",o.fillStyle="blue",o.fillText(t,2,2),i.needsUpdate=!0,e.next=16;break;case 14:e.prev=14,e.t0=e.catch(0);case 16:case"end":return e.stop()}}),e,null,[[0,14]])}))),1e3/7.5);return function(){clearInterval(l)}}}),[t,a]),k?o.a.createElement("sprite",Object.assign({},f&&d(),{position:n}),o.a.createElement("spriteMaterial",{map:k})):null})),M=function(e){return[parseInt(e.slice(0,2),16)/128-1,parseInt(e.slice(2,4),16)/128-1,0]},w=o.a.memo((function(e){var t=e.userId,a=e.nickname,n=e.faceStream,r=e.nicknameMap,c=e.faceStreamMap,i=e.avatarMap,s=e.myAvatar,p=e.setMyAvatar,f=function(e){var t;return(null===(t=i[e])||void 0===t?void 0:t.position)||M(e)};return o.a.createElement(l.a,null,o.a.createElement(u.Suspense,{fallback:null},o.a.createElement("ambientLight",null),Object.keys(c).map((function(e){return e!==t&&o.a.createElement(h,{key:e,nickname:r[e]||"",faceStream:c[e]||null,position:f(e)})})),o.a.createElement(h,{nickname:a,faceStream:n,position:(null===s||void 0===s?void 0:s.position)||M(t),setPosition:function(e){p({position:e})}})))})),g=o.a.memo((function(e){var t=e.roomId,a=e.userId,n=e.nickname,r=Object(k.b)(),c=Object(u.useState)(""),s=Object(i.a)(c,2),l=s[0],p=s[1],f=Object(k.a)(),v=Object(u.useState)(""),m=Object(i.a)(v,2),b=m[0],j=m[1],O=Object(A.a)(t,a,!!l,!!b,!!b,l,b,"spatialArea"),d=O.faceStream,y=O.faceStreamMap,h=Object(S.a)(t,a),M=E(t,a),g=M.avatarMap,I=M.myAvatar,x=M.setMyAvatar;return o.a.createElement("div",{className:"SpatialArea-container"},o.a.createElement("div",null,"Select Camera:"," ",o.a.createElement("select",{value:l,onChange:function(e){return p(e.target.value)}},o.a.createElement("option",{value:""},"None"),r.map((function(e){return o.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),o.a.createElement("div",null,"Select Mic:"," ",o.a.createElement("select",{value:b,onChange:function(e){j(e.target.value)}},o.a.createElement("option",{value:""},"None"),f.map((function(e){return o.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),o.a.createElement("div",{className:"SpatialArea-body"},o.a.createElement(w,{userId:a,nickname:n,faceStream:d,nicknameMap:h,faceStreamMap:y,avatarMap:g,myAvatar:I,setMyAvatar:x})))}));t.default=g}}]);
//# sourceMappingURL=16.ba022627.chunk.js.map