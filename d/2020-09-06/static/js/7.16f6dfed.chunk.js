(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[7],{104:function(e,n,t){"use strict";t.d(n,"a",(function(){return r}));var r=function(e){return new Promise((function(n){return setTimeout(n,e)}))}},162:function(e,n,t){"use strict";t.d(n,"c",(function(){return o})),t.d(n,"b",(function(){return f})),t.d(n,"d",(function(){return d})),t.d(n,"a",(function(){return b}));var r=t(5),a=t(1),c=t.n(a),u=t(2),i=t(104),s=new WeakMap,o=function(e,n){if(s.has(e))return e;s.set(e,!0);var t=function(){var t=Object(u.a)(c.a.mark((function t(){var r;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Object(i.a)(5e3);case 2:!(r=n.getTransceivers().find((function(n){return n.receiver.track===e})))||"inactive"!==r.currentDirection&&"sendonly"!==r.currentDirection||(e.stop(),e.dispatchEvent(new Event("ended")));case 4:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();return e.addEventListener("mute",t),e},f=function(e){return new Promise(function(){var n=Object(u.a)(c.a.mark((function n(t,r){var a,u,i,s;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,a=new RTCPeerConnection,u=new RTCPeerConnection,a.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&u.addIceCandidate(n)})),u.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&a.addIceCandidate(n)})),u.addEventListener("track",(function(e){t(e.track)})),e.addEventListener("ended",(function(){a.close(),u.close()})),a.addTrack(e),n.next=10,a.createOffer();case 10:return i=n.sent,n.next=13,a.setLocalDescription(i);case 13:return n.next=15,u.setRemoteDescription(i);case 15:return n.next=17,u.createAnswer();case 17:return s=n.sent,n.next=20,u.setLocalDescription(s);case 20:return n.next=22,a.setRemoteDescription(s);case 22:n.next=27;break;case 24:n.prev=24,n.t0=n.catch(0),r(n.t0);case 27:case"end":return n.stop()}}),n,null,[[0,24]])})));return function(e,t){return n.apply(this,arguments)}}())},d=function(){var e=Object(u.a)(c.a.mark((function e(n){var t,r,a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("video"===n.kind){e.next=2;break}throw new Error("track kind is not video");case 2:return t=new ImageCapture(n),r=document.createElement("canvas"),a=r.getContext("2d"),i=function(){var e=Object(u.a)(c.a.mark((function e(){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.grabFrame();case 3:return n=e.sent,r.width=n.width,r.height=n.height,a.drawImage(n,0,0),e.abrupt("return",r.toDataURL("image/jpeg"));case 10:return e.prev=10,e.t0=e.catch(0),console.log("failed to grab frame from viedeo track",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{getImage:i});case 7:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),p=function(e){return new Promise((function(n,t){var r=new Image;r.onload=function(){return n(r)},r.onerror=t,r.src=e}))},b=function(){var e=document.createElement("canvas"),n=e.getContext("2d"),t=e.captureStream().getVideoTracks();return{videoTrack:Object(r.a)(t,1)[0],setImage:function(){var t=Object(u.a)(c.a.mark((function t(r){var a;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p(r);case 2:a=t.sent,e.width=a.width,e.height=a.height,n.drawImage(a,0,0);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}}},188:function(e,n){},291:function(e,n,t){"use strict";t.d(n,"a",(function(){return u}));var r=t(97),a=0,c={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:0.peerjs.com:3478",username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},u=function(){var e=new Map,n=function(n,t,r){var a,c=e.get(n.peer);c&&r.split(/[\r\n]+/).forEach((function(e){if(e.startsWith("a=mid:"))a=e.slice("a=mid:".length);else if(e.startsWith("a=msid:")){e.slice("a=msid:".length).split(" ").forEach((function(e){var n=t[e];"string"===typeof n&&(c.remoteMediaTypes[a]=n)}))}}))};return{setAcceptingMediaTypes:function(n,t){var r=e.get(n.peer);r&&(r.acceptingMediaTypes=t)},getAcceptingMediaTypes:function(n){var t=e.get(n.peer);return t?t.acceptingMediaTypes:[]},addConn:function(n,t){if(e.get(n))throw new Error("addConn: already exists");var r={peerIndex:a+=1,peer:n,userId:t,sendPc:new RTCPeerConnection(c),recvPc:new RTCPeerConnection(c)};return e.set(r.peer,{conn:r,acceptingMediaTypes:[],remoteMediaTypes:{}}),r},getConn:function(n){var t=e.get(n);return t?t.conn:null},findConn:function(n){var t=Array.from(e.values()).find((function(e){return e.conn.peerIndex===n}));return t?t.conn:null},delConn:function(n){var t=e.get(n.peer);if(!t||t.conn!==n)throw new Error("delConn: does not exist");e.delete(n.peer),n.sendPc.close(),n.recvPc.close()},getPeerIndexList:function(){return Array.from(e.values()).map((function(e){return e.conn.peerIndex}))},forEachConns:function(n){Array.from(e.values()).forEach((function(e){n(e.conn)}))},forEachConnsAcceptingMedia:function(n,t){Array.from(e.values()).forEach((function(e){e.acceptingMediaTypes.includes(n)&&t(e.conn)}))},size:function(){return e.size},getRemoteMediaType:function(n,t){var r=e.get(n.peer);return r&&r.remoteMediaTypes[t]||null},registerRemoteMediaType:function(e,t){Object(r.a)(t,"msid2mediaType")&&(Object(r.a)(t,"offer")&&Object(r.b)(t.offer,"sdp")&&n(e,t.msid2mediaType,t.offer.sdp),Object(r.a)(t,"answer")&&Object(r.b)(t.answer,"sdp")&&n(e,t.msid2mediaType,t.answer.sdp))}}}},296:function(e,n){},312:function(e,n){},315:function(e,n){},355:function(e,n){},370:function(e,n){},374:function(e,n){},375:function(e,n){},406:function(e,n){},417:function(e,n){},430:function(e,n){},431:function(e,n){},444:function(e,n){},52:function(e,n,t){"use strict";t.r(n),t.d(n,"createRoom",(function(){return w}));var r=t(108),a=t(1),c=t.n(a),u=t(2),i=t(218),s=t(295),o=t.n(s),f=t(104),d=t(7),p=t(97),b=t(14),v=t(291),l=t(162),x=new Map,h=function(){var e=Object(u.a)(c.a.mark((function e(n,t){var r,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r="".concat(n," ").concat(t),a=x.get(r)){e.next=7;break}return e.next=5,Object(d.k)(r);case 5:a=e.sent.slice(0,b.a),x.set(r,a);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),w=function(){var e=Object(u.a)(c.a.mark((function e(n,t,a,s,x,w){var k,m,g,y,O,j,I,E,T,C,P,A,M,D,S,L,R,N,V,W,z,J,_,U,B,F,G,Z,q,H,K,Q,X,Y,$,ee,ne,te,re,ae;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return k=!1,m=null,g=null,y=Object(v.a)(),O=[],j=n.slice(0,b.a),e.next=9,Object(d.h)(n.slice(b.a));case 9:return I=e.sent,E=function(){if(!k){var e=y.getPeerIndexList();a({type:"CONNECTED_PEERS",peerIndexList:e})}},T=function(){var e=Object(u.a)(c.a.mark((function e(n){var t,r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(d.c)(n,I);case 3:if(null!==(t=e.sent)){e.next=6;break}return e.abrupt("return",void 0);case 6:return r=JSON.parse(t),console.log("decrypted payload",r),e.abrupt("return",r);case 11:return e.prev=11,e.t0=e.catch(0),console.info("Error in parsePayload",e.t0,n),e.abrupt("return",void 0);case 15:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(n){return e.apply(this,arguments)}}(),C=function(){var e=Object(u.a)(c.a.mark((function e(n,t){var r,a,u,s,o,f,p;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,console.log("payload to encrypt",n,t),r=!0,a=!1,e.prev=4,s=Object(i.a)(Object(d.f)(JSON.stringify(t),I));case 6:return e.next=8,s.next();case 8:return o=e.sent,r=o.done,e.next=12,o.value;case 12:if(f=e.sent,r){e.next=23;break}if(p=f,m){e.next=18;break}return console.warn("no myIpfs initialized"),e.abrupt("return");case 18:return e.next=20,m.pubsub.publish(n,p);case 20:r=!0,e.next=6;break;case 23:e.next=29;break;case 25:e.prev=25,e.t0=e.catch(4),a=!0,u=e.t0;case 29:if(e.prev=29,e.prev=30,r||null==s.return){e.next=34;break}return e.next=34,s.return();case 34:if(e.prev=34,!a){e.next=37;break}throw u;case 37:return e.finish(34);case 38:return e.finish(29);case 39:e.next=44;break;case 41:e.prev=41,e.t1=e.catch(0),console.error("sendPayload",e.t1);case 44:case"end":return e.stop()}}),e,null,[[0,41],[4,25,29,39],[30,,34,38]])})));return function(n,t){return e.apply(this,arguments)}}(),P=function(){var e=Object(u.a)(c.a.mark((function e(n,t){var r,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r="".concat(j," ").concat(n.peer),!m){e.next=7;break}return a=function(){return null},e.next=5,m.pubsub.subscribe(r,a);case 5:return e.next=7,m.pubsub.unsubscribe(r,a);case 7:return e.next=9,C(r,t);case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),A=function(){var e=Object(u.a)(c.a.mark((function e(n){var r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!k){e.next=2;break}return e.abrupt("return");case 2:return r={userId:t,data:n,mediaTypes:O},e.next=5,C(j,r);case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),M=function(){var e=Object(u.a)(c.a.mark((function e(n,r){var a,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!k){e.next=2;break}return e.abrupt("return");case 2:if(a=y.findConn(r)){e.next=5;break}return e.abrupt("return");case 5:return u={userId:t,data:n,mediaTypes:O},e.next=8,P(a,u);case 8:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),D=[],S=[],L=function(){var e=Object(u.a)(c.a.mark((function e(t){var r,a,i,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.includes("faceAudio")||D.length){e.next=10;break}if(!m){e.next=8;break}return e.next=4,h(n,"faceAudio");case 4:r=e.sent,a=function(){var e=Object(u.a)(c.a.mark((function e(n){var t,r,a,u,i,s,o,f,p,b;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.from!==g){e.next=2;break}return e.abrupt("return");case 2:if(t=y.getConn(n.from)){e.next=6;break}return console.warn("conn not ready"),e.abrupt("return");case 6:if(r={userId:t.userId,peerIndex:t.peerIndex,mediaTypes:y.getAcceptingMediaTypes(t)},(a=t).worker){e.next=24;break}return u=new AudioContext,i=u.createMediaStreamDestination(),s=0,o=0,(f=new Worker("audio-decoder.js",{type:"module"})).onmessage=function(e){var n=new Float32Array(e.data);o||(s=u.currentTime),s+=.06,o+=1;var t=u.createBuffer(1,2880,48e3);t.copyToChannel(n,0);var r=u.createBufferSource();r.buffer=t,r.connect(i),r.onended=function(){o-=1},r.start(s)},a.worker=f,p=i.stream.getAudioTracks()[0],e.t0=w,e.next=20,Object(l.b)(p);case 20:e.t1=e.sent,e.t2=r,(0,e.t0)("faceAudio",e.t1,e.t2),D.push((function(){u.close(),p.dispatchEvent(new Event("ended")),f.terminate(),a.worker===f&&delete a.worker}));case 24:return e.next=26,Object(d.a)(n.data.buffer,n.data.byteOffset,n.data.byteLength,I);case 26:b=e.sent,a.worker&&b.forEach((function(e){a.worker.postMessage([e],[e])}));case 28:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),m.pubsub.subscribe(r,a),D.push((function(){m&&m.pubsub.unsubscribe(r,a)}));case 8:e.next=11;break;case 10:!t.includes("faceAudio")&&D.length&&(D.forEach((function(e){return e()})),D.splice(0,D.length));case 11:if(!t.includes("faceVideo")||S.length){e.next=21;break}if(!m){e.next=19;break}return e.next=15,h(n,"faceVideo");case 15:i=e.sent,s=function(){var e=Object(u.a)(c.a.mark((function e(n){var t,r,a,u,i,s,o,f;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.from!==g){e.next=2;break}return e.abrupt("return");case 2:if(t=y.getConn(n.from)){e.next=6;break}return console.warn("conn not ready"),e.abrupt("return");case 6:return r={userId:t.userId,peerIndex:t.peerIndex,mediaTypes:y.getAcceptingMediaTypes(t)},(a=t).setImage||(u=Object(l.a)(),i=u.videoTrack,s=u.setImage,a.setImage=s,w("faceVideo",i,r),S.push((function(){i.dispatchEvent(new Event("ended"))}))),e.prev=9,e.next=12,Object(d.b)(n.data,I);case 12:o=e.sent,f=JSON.parse(o),Object(p.b)(f,"dataURL")&&a.setImage(f.dataURL),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(9),console.info("Error in parse for face video",e.t0);case 20:case"end":return e.stop()}}),e,null,[[9,17]])})));return function(n){return e.apply(this,arguments)}}(),m.pubsub.subscribe(i,s),S.push((function(){m&&m.pubsub.unsubscribe(i,s)}));case 19:e.next=22;break;case 21:!t.includes("faceVideo")&&S.length&&(S.forEach((function(e){return e()})),S.splice(0,S.length));case 22:(t=t.filter((function(e){return"faceAudio"!==e&&"faceVideo"!==e}))).length!==O.length&&y.forEachConns((function(e){var n={userId:e.userId,peerIndex:e.peerIndex,mediaTypes:y.getAcceptingMediaTypes(e)},r=e.recvPc.getTransceivers();e.recvPc.getReceivers().forEach((function(a){var c=r.find((function(e){return e.receiver===a})),u=null===c||void 0===c?void 0:c.mid,i=u&&y.getRemoteMediaType(e,u);i?"live"===a.track.readyState&&!O.includes(i)&&t.includes(i)&&w(i,Object(l.c)(a.track,e.recvPc),n):console.warn("failed to find media type from mid")}))})),O=t,A(null);case 26:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),R=function(){var e=Object(u.a)(c.a.mark((function e(n,t){var a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=ee(),e.next=3,P(n,{SDP:Object(r.a)(Object(r.a)({},t),{},{msid2mediaType:a})});case 3:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),N=function(){var e=Object(u.a)(c.a.mark((function e(n,t){var r,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(p.c)(t)){e.next=2;break}return e.abrupt("return");case 2:if(Object(p.b)(t,"negotiationId")){e.next=5;break}return console.warn("negotiationId not found in SDP"),e.abrupt("return");case 5:if(r=t.negotiationId,!Object(p.a)(t,"offer")){e.next=23;break}return e.prev=7,e.next=10,n.recvPc.setRemoteDescription(t.offer);case 10:return e.next=12,n.recvPc.createAnswer();case 12:return a=e.sent,e.next=15,n.recvPc.setLocalDescription(a);case 15:R(n,{negotiationId:r,answer:a}),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(7),console.info("handleSDP offer failed",e.t0);case 21:e.next=36;break;case 23:if(!Object(p.a)(t,"answer")){e.next=35;break}return V.get(n)===r&&V.delete(n),e.prev=25,e.next=28,n.sendPc.setRemoteDescription(t.answer);case 28:e.next=33;break;case 30:e.prev=30,e.t1=e.catch(25),console.info("handleSDP answer failed",e.t1);case 33:e.next=36;break;case 35:console.warn("unknown SDP",t);case 36:case"end":return e.stop()}}),e,null,[[7,18],[25,30]])})));return function(n,t){return e.apply(this,arguments)}}(),V=new WeakMap,W=function(e){var n=V.has(e);if(V.set(e,Object(d.j)()),!n){var t=function(){var n=Object(u.a)(c.a.mark((function n(){var r,a;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=V.get(e)){n.next=3;break}return n.abrupt("return");case 3:return n.next=5,e.sendPc.createOffer();case 5:return a=n.sent,n.next=8,e.sendPc.setLocalDescription(a);case 8:return n.next=10,R(e,{negotiationId:r,offer:a});case 10:return n.next=12,Object(f.a)(5e3);case 12:t();case 13:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();t()}},z=function(e,n){P(e,{ICE:n})},J=function(e,n){if(Object(p.c)(n))if(Object(p.b)(n,"direction"))if(Object(p.a)(n,"candidate"))try{"send"===n.direction?e.recvPc.addIceCandidate(n.candidate):"recv"===n.direction&&e.sendPc.addIceCandidate(n.candidate)}catch(t){console.info("handleCandidate failed",t)}else console.warn("candidate not found in ICE");else console.warn("direction not found in ICE")},_=function(){var e=Object(u.a)(c.a.mark((function e(n,t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(t)||!t.every((function(e){return"string"===typeof e}))){e.next=5;break}return y.setAcceptingMediaTypes(n,t),e.next=4,Object(f.a)(5e3);case 4:re(n);case 5:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),U=function(e,n){var t={userId:e.userId,peerIndex:e.peerIndex,mediaTypes:y.getAcceptingMediaTypes(e)};try{x(n,t)}catch(r){console.warn("receiveData",r)}},B=function(){var e=Object(u.a)(c.a.mark((function e(n,t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!k){e.next=2;break}return e.abrupt("return");case 2:if(e.prev=2,Object(p.c)(t)){e.next=5;break}return e.abrupt("return");case 5:N(n,t.SDP),J(n,t.ICE),_(n,t.mediaTypes),U(n,t.data),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(2),console.info("Error in handlePayload",e.t0,t);case 14:case"end":return e.stop()}}),e,null,[[2,11]])})));return function(n,t){return e.apply(this,arguments)}}(),F=function(e,n){var t=y.addConn(e,n);return t.sendPc.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&z(t,{direction:"send",candidate:n})})),t.recvPc.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&z(t,{direction:"recv",candidate:n})})),t.recvPc.addEventListener("track",(function(e){var n={userId:t.userId,peerIndex:t.peerIndex,mediaTypes:y.getAcceptingMediaTypes(t)};w("TODO",Object(l.c)(e.track,t.recvPc),n)})),s(t.peerIndex),a({type:"NEW_CONNECTION",peerIndex:t.peerIndex}),t},G=function(e){if(!Object(p.c)(e))return null;var n=e.userId;return"string"!==typeof n?null:n},Z=function(){var e=Object(u.a)(c.a.mark((function e(n){var t,r,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.from!==g){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,T(n.data);case 4:if(void 0!==(t=e.sent)){e.next=7;break}return e.abrupt("return");case 7:if(r=G(t),(a=y.getConn(n.from))||(r?a=F(n.from,r):console.warn("cannot initialize conn without user id")),!a){e.next=13;break}return e.next=13,B(a,t);case 13:E();case 14:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),q=function(){var e=Object(u.a)(c.a.mark((function e(){var n,t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!k){e.next=2;break}return e.abrupt("return");case 2:if(n=m?m.pubsub.peers(j):[],y.forEachConns((function(e){n.includes(e.peer)||(y.delConn(e),a({type:"CONNECTION_CLOSED",peerIndex:e.peerIndex}))})),!(m&&0===y.size()&&H+18e4<Date.now())){e.next=15;break}return t=m,m=null,g=null,e.next=10,Q(t);case 10:return e.next=12,Object(f.a)(2e4);case 12:return e.next=14,K();case 14:return e.abrupt("return");case 15:if(n.length){e.next=21;break}return a({type:"CONNECTING_SEED_PEERS"}),e.next=19,Object(f.a)(1e3);case 19:return q(),e.abrupt("return");case 21:if(y.size()){e.next=24;break}return e.next=24,A(null);case 24:return e.next=26,Object(f.a)(5e3);case 26:q();case 27:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),H=0,(K=function(){var e=Object(u.a)(c.a.mark((function e(){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return H=Date.now(),a({type:"INITIALIZING_PEER",peerIndex:0}),e.next=4,o.a.create({repo:Object(d.j)(),config:{Addresses:{Swarm:["/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star/"]}}});case 4:return n=e.sent,e.next=7,n.id();case 7:return g=e.sent.id,e.next=10,n.pubsub.subscribe(j,Z);case 10:return e.next=12,n.pubsub.subscribe("".concat(j," ").concat(g),Z);case 12:m=n,q();case 15:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}())(),Q=function(){var e=Object(u.a)(c.a.mark((function e(n){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.pubsub.unsubscribe("".concat(j," ").concat(g),Z);case 2:return e.next=4,n.pubsub.unsubscribe(j,Z);case 4:return e.next=6,n.stop();case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),X=new WeakMap,Y=function(e){e&&e()},$=new Map,ee=function(){var e={};return $.forEach((function(n,t){var r=n.stream;e[r.id]=t})),e},ne=function(){var e=Object(u.a)(c.a.mark((function e(t,r){var a,i,s,o,f,p,b,v,x,w;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!$.has(t)){e.next=2;break}throw new Error("track is already added for ".concat(t));case 2:if(a=new MediaStream([r]),$.set(t,{stream:a,track:r}),"faceAudio"!==t){e.next=19;break}return Y(X.get(r)),i=new AudioContext,s=i.createMediaStreamSource(a),e.next=10,i.audioWorklet.addModule("audio-encoder.js");case 10:return o=new AudioWorkletNode(i,"audio-encoder"),e.next=13,h(n,"faceAudio");case 13:return f=e.sent,p=[],o.port.onmessage=function(){var e=Object(u.a)(c.a.mark((function e(n){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(p.push(n.data),!(p.length<40)){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,Object(d.d)(p.splice(0,p.length),I);case 5:t=e.sent,m&&m.pubsub.publish(f,t);case 7:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),s.connect(o),X.set(r,(function(){i.close()})),e.abrupt("return");case 19:if("faceVideo"!==t){e.next=31;break}return Y(X.get(r)),e.next=23,h(n,"faceVideo");case 23:return b=e.sent,e.next=26,Object(l.d)(r);case 26:return v=e.sent,x=v.getImage,w=setInterval(Object(u.a)(c.a.mark((function e(){var n,t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x();case 2:if(!(n=e.sent)){e.next=8;break}return e.next=6,Object(d.e)(JSON.stringify({dataURL:n}),I);case 6:t=e.sent,m&&m.pubsub.publish(b,t);case 8:case"end":return e.stop()}}),e)}))),1e3),X.set(r,(function(){clearInterval(w)})),e.abrupt("return");case 31:y.forEachConnsAcceptingMedia(t,(function(e){try{e.sendPc.addTrack(r,a),W(e)}catch(n){if("InvalidAccessError"!==n.name)throw n}}));case 32:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),te=function(e){var n=$.get(e);if(n){var t=n.track;$.delete(e),"faceAudio"!==e&&"faceVideo"!==e?y.forEachConnsAcceptingMedia(e,(function(e){var n=e.sendPc.getSenders().find((function(e){return e.track===t}));n&&(e.sendPc.removeTrack(n),W(e))})):Y(X.get(t))}else console.log("track is already removed for",e)},re=function(e){var n=e.sendPc.getSenders(),t=y.getAcceptingMediaTypes(e);t.forEach((function(t){var r=$.get(t);if(r){var a=r.stream,c=r.track;n.every((function(e){return e.track!==c}))&&(e.sendPc.addTrack(c,a),W(e))}})),n.forEach((function(n){n.track&&(t.some((function(e){var t;return(null===(t=$.get(e))||void 0===t?void 0:t.track)===n.track}))||(e.sendPc.removeTrack(n),W(e)))}))},ae=function(){var e=Object(u.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:k=!0,m&&Q(m);case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{broadcastData:A,sendData:M,acceptMediaTypes:L,addTrack:ne,removeTrack:te,dispose:ae});case 46:case"end":return e.stop()}}),e)})));return function(n,t,r,a,c,u){return e.apply(this,arguments)}}()},97:function(e,n,t){"use strict";t.d(n,"c",(function(){return r})),t.d(n,"b",(function(){return a})),t.d(n,"a",(function(){return c}));var r=function(e){return"object"===typeof e&&null!==e},a=function(e,n){return"string"===typeof e[n]},c=function(e,n){return r(e[n])}}}]);
//# sourceMappingURL=7.16f6dfed.chunk.js.map