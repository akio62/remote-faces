(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[11],{1229:function(e,t,n){},1248:function(e,t,n){"use strict";n.r(t),n.d(t,"SpatialArea",(function(){return S}));var a=n(97),r=n(1),c=n.n(r),i=n(3),u=n(5),s=n(0),o=n(2),d=n.n(o),f=n(316),l=n(1242),v=n(1237),p=(n(1229),n(100)),b=n(95),j=n(111),m=function(e,t){var n=Object(o.useState)({}),r=Object(u.a)(n,2),c=r[0],i=r[1],s=Object(o.useState)(),d=Object(u.a)(s,2),f=d[0],l=d[1],v=Object(o.useRef)();Object(o.useEffect)((function(){v.current=f}),[f]);var m=Object(j.a)(e,t),O=Object(o.useRef)();return Object(o.useEffect)((function(){if(f){var e={spatialArea:"avatar",userId:t,avatarData:f};O.current?O.current=e:(O.current=e,setTimeout((function(){m(O.current),O.current=void 0}),200))}}),[m,t,f]),Object(j.b)(e,t,Object(o.useCallback)((function(e){var t;if(t=e,Object(b.c)(t)&&("init"===t.spatialArea||"avatar"===t.spatialArea&&function(e){try{var t=e;return"number"===typeof t.position[0]&&"number"===typeof t.position[1]&&"number"===typeof t.position[2]}catch(n){return!1}}(t.avatarData)))if("init"===e.spatialArea)v.current&&m({spatialArea:"avatar",avatarData:v.current});else if("avatar"===e.spatialArea){var n=e.userId,r=e.avatarData;i((function(e){return Object(a.a)(Object(a.a)({},e),{},Object(p.a)({},n,r))}))}}),[m])),Object(o.useEffect)((function(){m({spatialArea:"init"})}),[m]),{avatarMap:c,myAvatar:f,setMyAvatar:l}},O=n(317),h=n(513),x=n(190),w=n(126),k=d.a.memo((function(e){var t=e.nickname,n=e.faceStream,r=e.position,d=e.setPosition,p=e.distance,b=e.muted,j=Object(l.b)(),m=j.size,O=j.viewport,h=m.width/O.width,x=Object(o.useRef)(),k=Object(v.a)((function(e){var t=e.first,n=Object(u.a)(e.initial,2),a=n[0],c=n[1],i=Object(u.a)(e.xy,2),s=i[0],o=i[1];t&&(x.current=r);var f=x.current,l=Object(u.a)(f,2),v=l[0],p=l[1];d&&d([v+(s-a)/h,p-(o-c)/h,0])})),g=Object(o.useState)(),y=Object(u.a)(g,2),S=y[0],E=y[1],A=function(e){var t=Object(o.useState)(),n=Object(u.a)(t,2),a=n[0],r=n[1],c=Object(o.useState)(),i=Object(u.a)(c,2),s=i[0],d=i[1];return Object(o.useEffect)((function(){if(e){var t=e,n=function(){r(t.getVideoTracks()[0]),d(t.getAudioTracks()[0])};return e.addEventListener("addtrack",n),n(),function(){return e.removeEventListener("addtrack",n)}}}),[e]),Object(o.useEffect)((function(){a&&a.addEventListener("ended",(function(){r(void 0)}))}),[a]),Object(o.useEffect)((function(){s&&s.addEventListener("ended",(function(){d(void 0)}))}),[s]),{videoTrack:a,audioTrack:s}}(n),I=A.videoTrack,M=A.audioTrack,C=!!d,T=Object(o.useRef)(null);Object(o.useEffect)((function(){if(I){var e=document.createElement("canvas"),n=new f.CanvasTexture(e);E(n);var a=new ImageCapture(I),r=e.getContext("2d"),u=setInterval(Object(i.a)(c.a.mark((function i(){var u;return c.a.wrap((function(c){for(;;)switch(c.prev=c.next){case 0:return c.prev=0,c.next=3,a.grabFrame();case 3:u=c.sent,e.width=u.width,e.height=u.height,r.drawImage(u,0,0),r.font="18px selif",r.textBaseline="top",r.fillStyle="blue",r.fillText(t,2,2),C||null===T.current||(r.fillStyle="red",r.fillText(T.current.toFixed(2),2,54)),n.needsUpdate=!0,c.next=17;break;case 15:c.prev=15,c.t0=c.catch(0);case 17:case"end":return c.stop()}}),i,null,[[0,15]])}))),1e3/7.5);return function(){clearInterval(u)}}}),[t,C,I]);var L=Object(o.useRef)(null);return Object(o.useEffect)((function(){if(!C&&M){var e=new AudioContext,t=e.createMediaStreamDestination(),n=e.createMediaStreamSource(new MediaStream([M])),a=e.createGain();a.gain.value=.5,T.current=.5,L.current=function(t){a.gain.setValueAtTime(t,e.currentTime),T.current=t},n.connect(a),a.connect(t);var r=t.stream.getAudioTracks()[0],u=document.createElement("video");return u.autoplay=!0,u.style.display="block",u.style.width="1px",u.style.height="1px",u.style.position="absolute",u.style.bottom="0px",document.body.appendChild(u),Object(i.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=MediaStream,e.next=3,Object(w.b)(r);case 3:e.t1=e.sent,e.t2=[e.t1],u.srcObject=new e.t0(e.t2);case 6:case"end":return e.stop()}}),e)})))(),function(){L.current=null,T.current=null,e.close(),r.dispatchEvent(new Event("ended")),document.body.removeChild(u)}}}),[C,M]),Object(o.useEffect)((function(){L.current&&(void 0===p||b?L.current(0):L.current(Math.min(1,Math.max(0,(5-p)/4))))}),[b,p]),S?Object(s.jsx)("sprite",Object(a.a)(Object(a.a)({},d&&k()),{},{position:r,children:Object(s.jsx)("spriteMaterial",{map:S})})):null})),g=function(e){return[parseInt(e.slice(0,2),16)/128-1,parseInt(e.slice(2,4),16)/128-1,0]},y=d.a.memo((function(e){var t=e.userId,n=e.nickname,a=e.faceStream,r=e.nicknameMap,c=e.faceStreamMap,i=e.avatarMap,u=e.myAvatar,d=e.setMyAvatar,f=function(e){var t;return(null===(t=i[e])||void 0===t?void 0:t.position)||g(e)},v=(null===u||void 0===u?void 0:u.position)||g(t);return Object(s.jsx)(l.a,{children:Object(s.jsxs)(o.Suspense,{fallback:null,children:[Object(s.jsx)("ambientLight",{}),Object.keys(c).map((function(e){if(e===t)return null;var n=f(e),a=Math.hypot(n[0]-v[0],n[1]-v[1],n[2]-v[2]);return Object(s.jsx)(k,{nickname:r[e]||"",faceStream:c[e]||null,position:f(e),distance:a},e)})),Object(s.jsx)(k,{nickname:n,faceStream:a,position:v,setPosition:function(e){d({position:e})},muted:!0})]})})})),S=d.a.memo((function(e){var t=e.roomId,n=e.userId,a=e.nickname,r=Object(O.b)(),c=Object(o.useState)(""),i=Object(u.a)(c,2),d=i[0],f=i[1],l=Object(O.a)(),v=Object(o.useState)(""),p=Object(u.a)(v,2),b=p[0],j=p[1],w=Object(h.a)(t,n,!!d,!!b,!!b,d,b,"spatialArea"),k=w.faceStream,g=w.faceStreamMap,S=Object(x.a)(t,n),E=m(t,n),A=E.avatarMap,I=E.myAvatar,M=E.setMyAvatar;return Object(s.jsxs)("div",{className:"SpatialArea-container",children:[Object(s.jsxs)("div",{children:["Select Camera:"," ",Object(s.jsxs)("select",{value:d,onChange:function(e){return f(e.target.value)},children:[Object(s.jsx)("option",{value:"",children:"None"}),r.map((function(e){return Object(s.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId)}))]})]}),Object(s.jsxs)("div",{children:["Select Mic:"," ",Object(s.jsxs)("select",{value:b,onChange:function(e){j(e.target.value)},children:[Object(s.jsx)("option",{value:"",children:"None"}),l.map((function(e){return Object(s.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId)}))]})]}),Object(s.jsx)("div",{className:"SpatialArea-body",children:Object(s.jsx)(y,{userId:n,nickname:a,faceStream:k,nicknameMap:S,faceStreamMap:g,avatarMap:A,myAvatar:I,setMyAvatar:M})})]})}));t.default=S},126:function(e,t,n){"use strict";n.d(t,"c",(function(){return o})),n.d(t,"b",(function(){return d})),n.d(t,"d",(function(){return f})),n.d(t,"a",(function(){return v}));var a=n(5),r=n(1),c=n.n(r),i=n(3),u=n(98),s=new WeakMap,o=function(e,t){if(s.has(e))return e;s.set(e,!0);var n=function(){var n=Object(i.a)(c.a.mark((function n(){var a;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,Object(u.a)(5e3);case 2:!(a=t.getTransceivers().find((function(t){return t.receiver.track===e})))||"inactive"!==a.currentDirection&&"sendonly"!==a.currentDirection||(e.stop(),e.dispatchEvent(new Event("ended")));case 4:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();return e.addEventListener("mute",n),e},d=function(e){return new Promise(function(){var t=Object(i.a)(c.a.mark((function t(n,a){var r,i,u,s;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=new RTCPeerConnection,i=new RTCPeerConnection,r.addEventListener("icecandidate",(function(e){var t=e.candidate;t&&i.addIceCandidate(t)})),i.addEventListener("icecandidate",(function(e){var t=e.candidate;t&&r.addIceCandidate(t)})),i.addEventListener("track",(function(e){n(e.track)})),e.addEventListener("ended",(function(){r.close(),i.close()})),r.addTrack(e),t.next=10,r.createOffer();case 10:return u=t.sent,t.next=13,r.setLocalDescription(u);case 13:return t.next=15,i.setRemoteDescription(u);case 15:return t.next=17,i.createAnswer();case 17:return s=t.sent,t.next=20,i.setLocalDescription(s);case 20:return t.next=22,r.setRemoteDescription(s);case 22:t.next=27;break;case 24:t.prev=24,t.t0=t.catch(0),a(t.t0);case 27:case"end":return t.stop()}}),t,null,[[0,24]])})));return function(e,n){return t.apply(this,arguments)}}())},f=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,a,r,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("video"===t.kind){e.next=2;break}throw new Error("track kind is not video");case 2:return n=document.createElement("canvas"),a=n.getContext("2d"),r=new ImageCapture(t),u=function(){var e=Object(i.a)(c.a.mark((function e(){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.grabFrame();case 3:return t=e.sent,n.width=t.width,n.height=t.height,a.drawImage(t,0,0),e.abrupt("return",n.toDataURL("image/jpeg"));case 10:return e.prev=10,e.t0=e.catch(0),console.log("failed to grab frame from viedeo track",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{getImage:u});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),l=function(e){return new Promise((function(t,n){var a=new Image;a.onload=function(){return t(a)},a.onerror=n,a.src=e}))},v=function(){var e=document.createElement("canvas"),t=e.getContext("2d"),n=e.captureStream().getVideoTracks();return{videoTrack:Object(a.a)(n,1)[0],setImage:function(){var n=Object(i.a)(c.a.mark((function n(a){var r;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,l(a);case 2:r=n.sent,e.width=r.width,e.height=r.height,t.drawImage(r,0,0);case 6:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}()}}}}]);
//# sourceMappingURL=11.9b6e5359.chunk.js.map