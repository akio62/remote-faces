{"version":3,"sources":["hooks/useGatherArea.ts","components/RegionEditor.tsx","components/LinkOpener.tsx","components/GatherArea.tsx","utils/excalidraw.ts"],"names":["ROOM_STATE_KEY","RegionEditor","React","memo","roomId","userId","useState","regionId","setRegionId","type","setType","left","setLeft","top","setTop","width","setWidth","height","setHeight","zIndex","setZIndex","background","setBackground","border","setBorder","iframe","setIframe","allRegionData","setAllRegionData","className","value","onChange","e","target","Number","max","onClick","data","position","size","getRoomState","ydoc","getMap","set","addRegion","disabled","map","JSON","stringify","toJSON","loadAllRegionData","Object","entries","parse","forEach","key","console","log","LinkOpener","excalidrawUrl","setExcalidrawUrl","useEffect","a","generateExcalidrawURL","appLink","window","location","href","replace","title","readOnly","rel","MomentaryChat","lazy","MediaShare","Region","nickname","id","highlight","boxShadow","undefined","style","src","frameBorder","fallback","SuspenseFallback","uniqueId","Avatar","statusMesg","image","obsoleted","setPosition","registerOnMouseDrag","stream","muted","isMyself","onMouseDown","preventDefault","currentTarget","offset","clientX","clientY","FaceCard","liveMode","micOn","speakerOn","GatherArea","avatar","suspended","videoDeviceId","audioDeviceId","useFaceImages","myImage","roomImages","uid","avatarMap","setAvatarMap","parseInt","slice","myAvatar","setMyAvatar","roomState","listener","prev","copied","changed","b","userIdMap","x","obj","isAvatarData","keys","observe","unsub","subscribe","unobserve","dataToBroadcast","useRef","current","setTimeout","regionMap","setRegionMap","next","includes","isRegionData","updateRegion","useCallback","useGatherArea","onMouseDragRef","onMouseMove","activeMeetingRegionId","sort","find","useFaceVideos","faceStream","faceStreamMap","showModal","setShowModal","twoMinAgo","Date","now","onMouseUp","regionData","avatarData","imageData","info","message","updated","importCryptoKey","ROOM_ID_PREFIX_LEN","imported","crypto","subtle","exportKey","k"],"mappings":"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","file":"static/js/14.07a34582.chunk.js","sourcesContent":["import { useCallback, useState, useRef, useEffect } from \"react\";\nimport { subscribe } from \"valtio\";\n\nimport { getRoomState } from \"../states/roomMap\";\n\nconst getInitialPosition = (uid: string): [number, number] => [\n  parseInt(uid.slice(0, 2), 16) / 2 + 20,\n  parseInt(uid.slice(2, 4), 16) / 2 + 20,\n];\n\nexport type AvatarData = {\n  position: [left: number, top: number];\n};\n\nconst isAvatarData = (x: unknown): x is AvatarData => {\n  try {\n    const obj = x as AvatarData;\n    if (\n      typeof obj.position[0] === \"number\" &&\n      typeof obj.position[1] === \"number\"\n    ) {\n      return true;\n    }\n    return false;\n  } catch (e) {\n    return false;\n  }\n};\n\nconst isEqualAvatarData = (a: AvatarData, b: AvatarData) =>\n  a.position[0] === b.position[0] && a.position[1] === b.position[1];\n\nexport type RegionData = {\n  type: \"background\" | \"meeting\" | \"chat\" | \"media\";\n  position: [left: number, top: number];\n  size: [width: number, height: number];\n  zIndex?: number;\n  background?: string;\n  border?: string;\n  iframe?: string;\n};\n\nconst isRegionData = (x: unknown): x is RegionData => {\n  try {\n    const obj = x as RegionData;\n    if (\n      [\"background\", \"meeting\", \"chat\", \"media\"].includes(obj.type) &&\n      typeof obj.position[0] === \"number\" &&\n      typeof obj.position[1] === \"number\" &&\n      typeof obj.size[0] === \"number\" &&\n      typeof obj.size[1] === \"number\" &&\n      (typeof obj.zIndex === \"undefined\" || typeof obj.zIndex === \"number\") &&\n      (typeof obj.background === \"undefined\" ||\n        typeof obj.background === \"string\") &&\n      (typeof obj.border === \"undefined\" || typeof obj.border === \"string\") &&\n      (typeof obj.iframe === \"undefined\" || typeof obj.iframe === \"string\")\n    ) {\n      return true;\n    }\n    return false;\n  } catch (e) {\n    return false;\n  }\n};\n\nconst isEqualRegionData = (a: RegionData, b: RegionData) =>\n  a.type === b.type &&\n  a.position[0] === b.position[0] &&\n  a.position[1] === b.position[1] &&\n  a.size[0] === b.size[0] &&\n  a.size[1] === b.size[1] &&\n  a.zIndex === b.zIndex &&\n  a.background === b.background &&\n  a.border === b.border &&\n  a.iframe === b.iframe;\n\nexport type AvatarMap = {\n  [userId: string]: AvatarData;\n};\n\nexport type RegionMap = {\n  [regionId: string]: RegionData;\n};\n\nexport const ROOM_STATE_KEY = \"gatherRegionMap\";\n\nexport const useGatherArea = (roomId: string, userId: string) => {\n  const [avatarMap, setAvatarMap] = useState<AvatarMap>({});\n  const [myAvatar, setMyAvatar] = useState<AvatarData>({\n    position: getInitialPosition(userId),\n  });\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(\"gatherAvatarMap\");\n    const listener = () => {\n      setAvatarMap((prev) => {\n        const copied = { ...prev };\n        let changed = false;\n        map.forEach((data, uid) => {\n          if (uid === userId) return;\n          if (!roomState.userIdMap[uid]) return;\n          if (!isAvatarData(data)) return;\n          if (!copied[uid]) {\n            copied[uid] = data;\n            changed = true;\n          } else if (!isEqualAvatarData(data, copied[uid])) {\n            copied[uid] = data;\n            changed = true;\n          }\n        });\n        Object.keys(copied).forEach((uid) => {\n          if (!roomState.userIdMap[uid]) {\n            delete copied[uid];\n            changed = true;\n          }\n        });\n        if (changed) {\n          return copied;\n        }\n        return prev;\n      });\n    };\n    map.observe(listener);\n    const unsub = subscribe(roomState.userIdMap, listener);\n    listener();\n    return () => {\n      unsub();\n      map.unobserve(listener);\n    };\n  }, [roomId, userId]);\n\n  const dataToBroadcast = useRef<AvatarData>();\n  useEffect(() => {\n    if (!myAvatar) return;\n    if (dataToBroadcast.current) {\n      dataToBroadcast.current = myAvatar;\n    } else {\n      dataToBroadcast.current = myAvatar;\n      setTimeout(() => {\n        const roomState = getRoomState(roomId, userId);\n        const map = roomState.ydoc.getMap(\"gatherAvatarMap\");\n        map.set(userId, dataToBroadcast.current);\n        dataToBroadcast.current = undefined;\n      }, 500);\n    }\n  }, [roomId, userId, myAvatar]);\n\n  const [regionMap, setRegionMap] = useState<RegionMap>({});\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(ROOM_STATE_KEY);\n    const listener = () => {\n      setRegionMap((prev) => {\n        const next: RegionMap = {};\n        map.forEach((data, id) => {\n          if (!isRegionData(data)) return;\n          if (prev[id] && isEqualRegionData(prev[id], data)) {\n            next[id] = prev[id];\n          } else {\n            next[id] = data;\n          }\n        });\n        return next;\n      });\n    };\n    map.observe(listener);\n    listener();\n    return () => {\n      map.unobserve(listener);\n    };\n  }, [roomId, userId]);\n\n  const updateRegion = useCallback(\n    (id: string, data: RegionData) => {\n      const roomState = getRoomState(roomId, userId);\n      const map = roomState.ydoc.getMap(ROOM_STATE_KEY);\n      map.set(id, data);\n    },\n    [roomId, userId]\n  );\n\n  return {\n    avatarMap,\n    myAvatar,\n    setMyAvatar,\n    regionMap,\n    updateRegion,\n  };\n};\n","import React, { useState } from \"react\";\n\nimport \"./RegionEditor.css\";\nimport { getRoomState } from \"../states/roomMap\";\nimport { ROOM_STATE_KEY, RegionData } from \"../hooks/useGatherArea\";\n\nexport const RegionEditor = React.memo<{\n  roomId: string;\n  userId: string;\n}>(({ roomId, userId }) => {\n  const [regionId, setRegionId] = useState(\"\");\n  const [type, setType] = useState<RegionData[\"type\"]>(\"background\");\n  const [left, setLeft] = useState(100);\n  const [top, setTop] = useState(100);\n  const [width, setWidth] = useState(100);\n  const [height, setHeight] = useState(100);\n  const [zIndex, setZIndex] = useState(0);\n  const [background, setBackground] = useState(\"\");\n  const [border, setBorder] = useState(\"\");\n  const [iframe, setIframe] = useState(\"\");\n\n  const addRegion = () => {\n    const data: RegionData = {\n      type,\n      position: [left, top],\n      size: [width, height],\n      zIndex,\n      background,\n      border,\n      iframe,\n    };\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(ROOM_STATE_KEY);\n    map.set(regionId, data);\n  };\n\n  const [allRegionData, setAllRegionData] = useState<string | null>(null);\n\n  const loadAllRegionData = () => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(ROOM_STATE_KEY);\n    setAllRegionData(JSON.stringify(map.toJSON()));\n  };\n\n  const saveAllRegionData = () => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(ROOM_STATE_KEY);\n    try {\n      Object.entries(JSON.parse(allRegionData || \"\")).forEach(\n        ([key, value]) => {\n          map.set(key, value);\n        }\n      );\n      setAllRegionData(null);\n    } catch (e) {\n      console.log(\"failed to save all region data\", e);\n    }\n  };\n\n  return (\n    <div className=\"RegionEditor-container\">\n      <h3>Region Editor</h3>\n      <label>\n        Region ID:{\" \"}\n        <input value={regionId} onChange={(e) => setRegionId(e.target.value)} />\n      </label>\n      <hr />\n      <label>\n        Type:{\" \"}\n        <select\n          value={type}\n          onChange={(e) => setType(e.target.value as RegionData[\"type\"])}\n        >\n          <option value=\"background\">Background</option>\n          <option value=\"meeting\">Meeting</option>\n          <option value=\"chat\">Chat</option>\n          <option value=\"media\">Media</option>\n        </select>\n      </label>\n      <hr />\n      <label>\n        Left:{\" \"}\n        <input\n          type=\"number\"\n          value={left}\n          onChange={(e) => setLeft(Number(e.target.value))}\n        />\n      </label>\n      <label>\n        Top:{\" \"}\n        <input\n          type=\"number\"\n          value={top}\n          onChange={(e) => setTop(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        Width:{\" \"}\n        <input\n          type=\"number\"\n          value={width}\n          onChange={(e) => setWidth(Number(e.target.value))}\n        />\n      </label>\n      <label>\n        Height:{\" \"}\n        <input\n          type=\"number\"\n          value={height}\n          onChange={(e) => setHeight(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      {type !== \"chat\" && (\n        <label>\n          zIndex:{\" \"}\n          <input\n            type=\"number\"\n            value={zIndex}\n            max={0}\n            onChange={(e) => setZIndex(Number(e.target.value))}\n          />\n        </label>\n      )}\n      <hr />\n      <label>\n        Background:{\" \"}\n        <input\n          value={background}\n          onChange={(e) => setBackground(e.target.value)}\n        />\n      </label>\n      <label>\n        Border:{\" \"}\n        <input value={border} onChange={(e) => setBorder(e.target.value)} />\n      </label>\n      <hr />\n      <label>\n        Iframe:{\" \"}\n        <input value={iframe} onChange={(e) => setIframe(e.target.value)} />\n      </label>\n      <hr />\n      <button type=\"button\" onClick={() => addRegion()} disabled={!regionId}>\n        Add Region\n      </button>\n      <hr />\n      <button\n        type=\"button\"\n        className=\"RegionEditor-toggle\"\n        onClick={() => {\n          if (allRegionData) {\n            setAllRegionData(null);\n          } else {\n            loadAllRegionData();\n          }\n        }}\n      >\n        Import/Export {allRegionData ? <>&#9660;</> : <>&#9654;</>}\n      </button>\n      {!!allRegionData && (\n        <div>\n          <label>\n            All Region Data:{\" \"}\n            <textarea\n              value={allRegionData}\n              onChange={(e) => setAllRegionData(e.target.value)}\n            />\n          </label>\n          <button type=\"button\" onClick={saveAllRegionData}>\n            Replace (Be careful)\n          </button>\n        </div>\n      )}\n    </div>\n  );\n});\n","import React, { useEffect, useState } from \"react\";\n\nimport \"./LinkOpener.css\";\nimport { generateExcalidrawURL } from \"../utils/excalidraw\";\n\nexport const LinkOpener = React.memo<{\n  roomId: string;\n}>(({ roomId }) => {\n  const [excalidrawUrl, setExcalidrawUrl] = useState<string>();\n  useEffect(() => {\n    (async () => {\n      setExcalidrawUrl(await generateExcalidrawURL(roomId));\n    })();\n  }, [roomId]);\n\n  const appLink = `remote-faces://${window.location.href.replace(\n    /^https:\\/\\//,\n    \"\"\n  )}`;\n\n  return (\n    <div className=\"LinkOpener-container\">\n      <div>\n        <span title=\"Share this link with your colleagues\">Room Link: </span>\n        <input value={window.location.href} readOnly />\n      </div>\n      <div>\n        <a href={appLink} title=\"Open this link in the desktop app\">\n          Open App\n        </a>\n      </div>\n      <div>\n        <a href={excalidrawUrl} target=\"_blank\" rel=\"noreferrer\">\n          Open Excalidraw\n        </a>\n      </div>\n    </div>\n  );\n});\n","/* eslint jsx-a11y/no-static-element-interactions: off */\n\nimport React, { Suspense, useCallback, useRef, useState } from \"react\";\n\nimport \"./GatherArea.css\";\nimport { useGatherArea, RegionData } from \"../hooks/useGatherArea\";\nimport { useFaceImages } from \"../hooks/useFaceImages\";\nimport { useFaceVideos } from \"../hooks/useFaceVideos\";\nimport { RegionEditor } from \"./RegionEditor\";\nimport { LinkOpener } from \"./LinkOpener\";\nimport { FaceCard } from \"./FaceCard\";\nimport { SuspenseFallback } from \"./SuspenseFallback\";\n\nconst MomentaryChat = React.lazy(() => import(\"./MomentaryChat\"));\nconst MediaShare = React.lazy(() => import(\"./MediaShare\"));\n\ntype OnMouseMove = (e: React.MouseEvent<HTMLDivElement, MouseEvent>) => void;\n\nconst Region = React.memo<{\n  roomId: string;\n  userId: string;\n  nickname: string;\n  id: string;\n  data: RegionData;\n  highlight?: boolean;\n}>(({ roomId, userId, nickname, id, data, highlight }) => {\n  const boxShadow =\n    (data.type === \"meeting\" &&\n      (highlight ? \"0 0 0 5px pink\" : \"0 0 0 1px pink\")) ||\n    undefined;\n  return (\n    <div\n      className=\"GatherArea-region\"\n      style={{\n        left: `${data.position[0]}px`,\n        top: `${data.position[1]}px`,\n        width: `${data.size[0]}px`,\n        height: `${data.size[1]}px`,\n        boxShadow,\n        zIndex: data.type !== \"chat\" ? data.zIndex : undefined,\n        background: data.background,\n        border: data.border,\n      }}\n    >\n      {data.iframe && <iframe title={id} src={data.iframe} frameBorder=\"0\" />}\n      {data.type === \"chat\" && (\n        <Suspense fallback={<SuspenseFallback />}>\n          <MomentaryChat\n            roomId={roomId}\n            userId={userId}\n            nickname={nickname}\n            uniqueId={id}\n          />\n        </Suspense>\n      )}\n      {data.type === \"media\" && (\n        <Suspense fallback={<SuspenseFallback />}>\n          <MediaShare\n            roomId={roomId}\n            userId={userId}\n            nickname={nickname}\n            uniqueId={id}\n          />\n        </Suspense>\n      )}\n    </div>\n  );\n});\n\nconst Avatar = React.memo<{\n  nickname: string;\n  statusMesg: string;\n  image?: string;\n  obsoleted?: boolean;\n  position: [left: number, top: number];\n  setPosition?: (nextPosition: [number, number]) => void;\n  registerOnMouseDrag: (onMouseMove?: OnMouseMove) => void;\n  stream?: MediaStream;\n  muted?: boolean;\n}>(\n  ({\n    nickname,\n    statusMesg,\n    image,\n    obsoleted,\n    position,\n    setPosition,\n    registerOnMouseDrag,\n    stream,\n    muted,\n  }) => {\n    const isMyself = !!setPosition;\n    return (\n      <div\n        className=\"GatherArea-avatar\"\n        style={{\n          left: `${position[0]}px`,\n          top: `${position[1]}px`,\n        }}\n        onMouseDown={(e) => {\n          e.preventDefault();\n          if (isMyself) {\n            const target = e.currentTarget;\n            const offset = [e.clientX - position[0], e.clientY - position[1]];\n            registerOnMouseDrag((e) => {\n              const left = e.clientX - offset[0];\n              const top = e.clientY - offset[1];\n              target.style.left = `${left}px`;\n              target.style.top = `${top}px`;\n              setPosition?.([left, top]);\n            });\n          }\n        }}\n      >\n        <FaceCard\n          image={image}\n          nickname={nickname}\n          statusMesg={statusMesg}\n          obsoleted={!!obsoleted}\n          liveMode={!!stream}\n          stream={stream}\n          muted={!!muted}\n          micOn={!!stream}\n          speakerOn={!!stream}\n        />\n      </div>\n    );\n  }\n);\n\nexport const GatherArea = React.memo<{\n  roomId: string;\n  userId: string;\n  avatar: string;\n  nickname: string;\n  statusMesg: string;\n  suspended: boolean;\n  videoDeviceId?: string;\n  audioDeviceId?: string;\n}>(\n  ({\n    roomId,\n    userId,\n    avatar,\n    nickname,\n    statusMesg,\n    suspended,\n    videoDeviceId,\n    audioDeviceId,\n  }) => {\n    const { myImage, roomImages } = useFaceImages(\n      roomId,\n      userId,\n      avatar,\n      nickname,\n      statusMesg,\n      suspended,\n      false,\n      false,\n      false,\n      videoDeviceId\n    );\n    const { avatarMap, myAvatar, setMyAvatar, regionMap } = useGatherArea(\n      roomId,\n      userId\n    );\n\n    const onMouseDragRef = useRef<OnMouseMove>();\n    const registerOnMouseDrag = useCallback((onMouseMove?: OnMouseMove) => {\n      onMouseDragRef.current = onMouseMove;\n    }, []);\n\n    const regionIdList = Object.keys(regionMap).sort(\n      (a, b) => (regionMap[b].zIndex ?? 0) - (regionMap[a].zIndex ?? 0)\n    );\n    const activeMeetingRegionId = regionIdList.find((id) => {\n      const { type, position, size } = regionMap[id] as RegionData;\n      return (\n        type === \"meeting\" &&\n        position[0] <= myAvatar.position[0] &&\n        position[1] <= myAvatar.position[1] &&\n        myAvatar.position[0] + 36 <= position[0] + size[0] &&\n        myAvatar.position[1] + 36 <= position[1] + size[1]\n      );\n    });\n\n    const { faceStream, faceStreamMap } = useFaceVideos(\n      roomId,\n      userId,\n      !!activeMeetingRegionId,\n      !!activeMeetingRegionId,\n      true,\n      videoDeviceId,\n      audioDeviceId,\n      `gatherArea/meeting/${activeMeetingRegionId}/`\n    );\n\n    const [showModal, setShowModal] = useState<\n      null | \"region-editor\" | \"link-opener\"\n    >(null);\n\n    const twoMinAgo = Date.now() - 2 * 60 * 1000;\n\n    return (\n      <div className=\"GatherArea-container\">\n        <div\n          className=\"GatherArea-body\"\n          onMouseMove={(e) => {\n            if (onMouseDragRef.current) {\n              onMouseDragRef.current(e);\n            }\n          }}\n          onMouseUp={() => {\n            registerOnMouseDrag();\n          }}\n        >\n          {Object.entries(regionMap).map(([regionId, regionData]) => (\n            <Region\n              key={regionId}\n              roomId={roomId}\n              userId={userId}\n              nickname={nickname}\n              id={regionId}\n              data={regionData}\n              highlight={regionId === activeMeetingRegionId}\n            />\n          ))}\n          {Object.entries(avatarMap).map(([uid, avatarData]) => {\n            if (uid === userId) {\n              return null;\n            }\n            const imageData = roomImages.find((data) => data.userId === uid);\n            if (!imageData) {\n              return null;\n            }\n            return (\n              <Avatar\n                key={uid}\n                nickname={imageData.info.nickname}\n                statusMesg={imageData.info.message}\n                image={imageData.image}\n                obsoleted={imageData.updated < twoMinAgo}\n                position={avatarData.position}\n                registerOnMouseDrag={registerOnMouseDrag}\n                stream={faceStreamMap[uid]}\n              />\n            );\n          })}\n          <Avatar\n            nickname={nickname}\n            statusMesg={statusMesg}\n            image={myImage}\n            position={myAvatar.position}\n            setPosition={(position) =>\n              setMyAvatar((prev) => ({ ...prev, position }))\n            }\n            registerOnMouseDrag={registerOnMouseDrag}\n            stream={faceStream || undefined}\n            muted\n          />\n        </div>\n        <div className=\"GatherArea-toolbar\">\n          <div>\n            <button\n              type=\"button\"\n              onClick={() =>\n                setShowModal(\n                  showModal === \"region-editor\" ? null : \"region-editor\"\n                )\n              }\n            >\n              {showModal === \"region-editor\"\n                ? \"Close Region Editor\"\n                : \"Open Region Editor\"}\n            </button>\n            {showModal === \"region-editor\" && (\n              <div className=\"GatherArea-region-editor\">\n                <RegionEditor roomId={roomId} userId={userId} />\n              </div>\n            )}\n          </div>\n          <div>\n            <button\n              type=\"button\"\n              onClick={() =>\n                setShowModal(showModal === \"link-opener\" ? null : \"link-opener\")\n              }\n            >\n              {showModal === \"link-opener\"\n                ? \"Close Link Opener\"\n                : \"Open Link Opener\"}\n            </button>\n            {showModal === \"link-opener\" && (\n              <div className=\"GatherArea-link-opener\">\n                <LinkOpener roomId={roomId} />\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    );\n  }\n);\n\nexport default GatherArea;\n","import { ROOM_ID_PREFIX_LEN } from \"../network/room\";\nimport { importCryptoKey } from \"./crypto\";\n\nexport const generateExcalidrawURL = async (roomId: string) => {\n  const id = roomId.slice(0, 20);\n  const imported = await importCryptoKey(roomId.slice(ROOM_ID_PREFIX_LEN));\n  const key = (await window.crypto.subtle.exportKey(\"jwk\", imported)).k;\n  return `https://excalidraw.com/#room=${id},${key}`;\n};\n"],"sourceRoot":""}