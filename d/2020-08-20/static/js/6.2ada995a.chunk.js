(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[6],{101:function(e,n,t){"use strict";t.d(n,"a",(function(){return r}));var r=function(e){return new Promise((function(n){return setTimeout(n,e)}))}},158:function(e,n,t){"use strict";t.d(n,"b",(function(){return s})),t.d(n,"a",(function(){return o}));var r=t(1),a=t.n(r),c=t(2),i=t(101),u=new WeakMap,s=function(e,n){if(u.has(e))return e;u.set(e,!0);var t=function(){var t=Object(c.a)(a.a.mark((function t(){var r;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Object(i.a)(5e3);case 2:!(r=n.getTransceivers().find((function(n){return n.receiver.track===e})))||"inactive"!==r.currentDirection&&"sendonly"!==r.currentDirection||(e.stop(),e.dispatchEvent(new Event("ended")));case 4:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();return e.addEventListener("mute",t),e},o=function(e){return new Promise(function(){var n=Object(c.a)(a.a.mark((function n(t,r){var c,i,u,s;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,c=new RTCPeerConnection,i=new RTCPeerConnection,c.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&i.addIceCandidate(n)})),i.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&c.addIceCandidate(n)})),i.addEventListener("track",(function(e){t(e.track)})),e.addEventListener("ended",(function(){c.close(),i.close()})),c.addTrack(e),n.next=10,c.createOffer();case 10:return u=n.sent,n.next=13,c.setLocalDescription(u);case 13:return n.next=15,i.setRemoteDescription(u);case 15:return n.next=17,i.createAnswer();case 17:return s=n.sent,n.next=20,i.setLocalDescription(s);case 20:return n.next=22,c.setRemoteDescription(s);case 22:n.next=27;break;case 24:n.prev=24,n.t0=n.catch(0),r(n.t0);case 27:case"end":return n.stop()}}),n,null,[[0,24]])})));return function(e,t){return n.apply(this,arguments)}}())}},184:function(e,n){},287:function(e,n,t){"use strict";t.d(n,"a",(function(){return i}));var r=t(94),a=0,c={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:0.peerjs.com:3478",username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},i=function(){var e=new Map,n=function(n,t,r){var a,c=e.get(n.peer);c&&r.split(/[\r\n]+/).forEach((function(e){if(e.startsWith("a=mid:"))a=e.slice("a=mid:".length);else if(e.startsWith("a=msid:")){e.slice("a=msid:".length).split(" ").forEach((function(e){var n=t[e];"string"===typeof n&&(c.remoteMediaTypes[a]=n)}))}}))};return{setAcceptingMediaTypes:function(n,t){var r=e.get(n.peer);r&&(r.acceptingMediaTypes=t)},getAcceptingMediaTypes:function(n){var t=e.get(n.peer);return t?t.acceptingMediaTypes:[]},addConn:function(n,t){if(e.get(n))throw new Error("addConn: already exists");var r={peerIndex:a+=1,peer:n,userId:t,sendPc:new RTCPeerConnection(c),recvPc:new RTCPeerConnection(c)};return e.set(r.peer,{conn:r,acceptingMediaTypes:[],remoteMediaTypes:{}}),r},getConn:function(n){var t=e.get(n);return t?t.conn:null},findConn:function(n){var t=Array.from(e.values()).find((function(e){return e.conn.peerIndex===n}));return t?t.conn:null},delConn:function(n){var t=e.get(n.peer);if(!t||t.conn!==n)throw new Error("delConn: does not exist");e.delete(n.peer),n.sendPc.close(),n.recvPc.close()},getPeerIndexList:function(){return Array.from(e.values()).map((function(e){return e.conn.peerIndex}))},forEachConns:function(n){Array.from(e.values()).forEach((function(e){n(e.conn)}))},forEachConnsAcceptingMedia:function(n,t){Array.from(e.values()).forEach((function(e){e.acceptingMediaTypes.includes(n)&&t(e.conn)}))},size:function(){return e.size},getRemoteMediaType:function(n,t){var r=e.get(n.peer);return r&&r.remoteMediaTypes[t]||null},registerRemoteMediaType:function(e,t){Object(r.a)(t,"msid2mediaType")&&(Object(r.a)(t,"offer")&&Object(r.b)(t.offer,"sdp")&&n(e,t.msid2mediaType,t.offer.sdp),Object(r.a)(t,"answer")&&Object(r.b)(t.answer,"sdp")&&n(e,t.msid2mediaType,t.answer.sdp))}}}},292:function(e,n){},308:function(e,n){},311:function(e,n){},351:function(e,n){},366:function(e,n){},370:function(e,n){},371:function(e,n){},402:function(e,n){},413:function(e,n){},426:function(e,n){},427:function(e,n){},440:function(e,n){},50:function(e,n,t){"use strict";t.r(n),t.d(n,"createRoom",(function(){return b}));var r=t(105),a=t(1),c=t.n(a),i=t(2),u=t(291),s=t.n(u),o=t(101),d=t(6),f=t(94),p=t(13),l=t(287),v=t(158),b=function(){var e=Object(i.a)(c.a.mark((function e(n,t,a,u,b,x){var y,m,h,w,k,g,O,j,I,E,T,P,C,M,D,A,L,S,R,N,z,_,W,J,G,Z,q,B,F,H,K,Q,U,V,X,Y;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return y=!1,m=null,h=null,w=Object(l.a)(),k=[],g=n.slice(0,p.a),e.next=9,Object(d.f)(n.slice(p.a));case 9:return O=e.sent,j=function(){if(!y){var e=w.getPeerIndexList();a({type:"CONNECTED_PEERS",peerIndexList:e})}},I=function(){var e=Object(i.a)(c.a.mark((function e(n){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=JSON,e.next=4,Object(d.a)(n,O);case 4:return e.t1=e.sent,t=e.t0.parse.call(e.t0,e.t1),console.log("decrypted payload",t),e.abrupt("return",t);case 10:return e.prev=10,e.t2=e.catch(0),console.info("Error in parsePayload",e.t2,n),e.abrupt("return",void 0);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(n){return e.apply(this,arguments)}}(),E=function(){var e=Object(i.a)(c.a.mark((function e(n,t){var r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("payload to encrypt",n,t),e.next=4,Object(d.c)(JSON.stringify(t),O);case 4:if(r=e.sent,console.log("sending encrypted",r.byteLength),!(r.byteLength>262144)){e.next=9;break}return console.warn("encrypted message too large, aborting"),e.abrupt("return");case 9:if(m){e.next=12;break}return console.warn("no myIpfs initialized"),e.abrupt("return");case 12:return e.next=14,m.pubsub.publish(n,r);case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("sendPayload",e.t0);case 19:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(n,t){return e.apply(this,arguments)}}(),T=function(){var e=Object(i.a)(c.a.mark((function e(n,t){var r,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r="".concat(g," ").concat(n.peer),!m){e.next=7;break}return a=function(){return null},e.next=5,m.pubsub.subscribe(r,a);case 5:return e.next=7,m.pubsub.unsubscribe(r,a);case 7:return e.next=9,E(r,t);case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),P=function(){var e=Object(i.a)(c.a.mark((function e(n){var r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y){e.next=2;break}return e.abrupt("return");case 2:return r={userId:t,data:n,mediaTypes:k},e.next=5,E(g,r);case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),C=function(){var e=Object(i.a)(c.a.mark((function e(n,r){var a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y){e.next=2;break}return e.abrupt("return");case 2:if(a=w.findConn(r)){e.next=5;break}return e.abrupt("return");case 5:return i={userId:t,data:n,mediaTypes:k},e.next=8,T(a,i);case 8:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),M=function(e){e.length!==k.length&&w.forEachConns((function(n){var t={userId:n.userId,peerIndex:n.peerIndex,mediaTypes:w.getAcceptingMediaTypes(n)},r=n.recvPc.getTransceivers();n.recvPc.getReceivers().forEach((function(a){var c=r.find((function(e){return e.receiver===a})),i=null===c||void 0===c?void 0:c.mid,u=i&&w.getRemoteMediaType(n,i);u?"live"===a.track.readyState&&!k.includes(u)&&e.includes(u)&&x(u,Object(v.b)(a.track,n.recvPc),t):console.warn("failed to find media type from mid")}))})),k=e,P(null)},D=function(){var e=Object(i.a)(c.a.mark((function e(n,t){var a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Q(),e.next=3,T(n,{SDP:Object(r.a)(Object(r.a)({},t),{},{msid2mediaType:a})});case 3:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),A=function(){var e=Object(i.a)(c.a.mark((function e(n,t){var r,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(f.c)(t)){e.next=2;break}return e.abrupt("return");case 2:if(Object(f.b)(t,"negotiationId")){e.next=5;break}return console.warn("negotiationId not found in SDP"),e.abrupt("return");case 5:if(r=t.negotiationId,w.registerRemoteMediaType(n,t),!Object(f.a)(t,"offer")){e.next=24;break}return e.prev=8,e.next=11,n.recvPc.setRemoteDescription(t.offer);case 11:return e.next=13,n.recvPc.createAnswer();case 13:return a=e.sent,e.next=16,n.recvPc.setLocalDescription(a);case 16:D(n,{negotiationId:r,answer:a}),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(8),console.info("handleSDP offer failed",e.t0);case 22:e.next=37;break;case 24:if(!Object(f.a)(t,"answer")){e.next=36;break}return L.get(n)===r&&L.delete(n),e.prev=26,e.next=29,n.sendPc.setRemoteDescription(t.answer);case 29:e.next=34;break;case 31:e.prev=31,e.t1=e.catch(26),console.info("handleSDP answer failed",e.t1);case 34:e.next=37;break;case 36:console.warn("unknown SDP",t);case 37:case"end":return e.stop()}}),e,null,[[8,19],[26,31]])})));return function(n,t){return e.apply(this,arguments)}}(),L=new WeakMap,S=function(e){var n=L.has(e);if(L.set(e,Object(d.h)()),!n){var t=function(){var n=Object(i.a)(c.a.mark((function n(){var r,a;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=L.get(e)){n.next=3;break}return n.abrupt("return");case 3:return n.next=5,e.sendPc.createOffer();case 5:return a=n.sent,n.next=8,e.sendPc.setLocalDescription(a);case 8:return n.next=10,D(e,{negotiationId:r,offer:a});case 10:return n.next=12,Object(o.a)(5e3);case 12:t();case 13:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();t()}},R=function(e,n){T(e,{ICE:n})},N=function(e,n){if(Object(f.c)(n))if(Object(f.b)(n,"direction"))if(Object(f.a)(n,"candidate"))try{"send"===n.direction?e.recvPc.addIceCandidate(n.candidate):"recv"===n.direction&&e.sendPc.addIceCandidate(n.candidate)}catch(t){console.info("handleCandidate failed",t)}else console.warn("candidate not found in ICE");else console.warn("direction not found in ICE")},z=function(){var e=Object(i.a)(c.a.mark((function e(n,t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(t)||!t.every((function(e){return"string"===typeof e}))){e.next=5;break}return w.setAcceptingMediaTypes(n,t),e.next=4,Object(o.a)(5e3);case 4:X(n);case 5:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),_=function(e,n){var t={userId:e.userId,peerIndex:e.peerIndex,mediaTypes:w.getAcceptingMediaTypes(e)};try{b(n,t)}catch(r){console.warn("receiveData",r)}},W=function(){var e=Object(i.a)(c.a.mark((function e(n,t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y){e.next=2;break}return e.abrupt("return");case 2:if(e.prev=2,Object(f.c)(t)){e.next=5;break}return e.abrupt("return");case 5:A(n,t.SDP),N(n,t.ICE),z(n,t.mediaTypes),_(n,t.data),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(2),console.info("Error in handlePayload",e.t0,t);case 14:case"end":return e.stop()}}),e,null,[[2,11]])})));return function(n,t){return e.apply(this,arguments)}}(),J=function(e,n){var t=w.addConn(e,n);return t.sendPc.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&R(t,{direction:"send",candidate:n})})),t.recvPc.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&R(t,{direction:"recv",candidate:n})})),t.recvPc.addEventListener("track",(function(e){var n=e.transceiver.mid,r=n&&w.getRemoteMediaType(t,n);if(r){var a={userId:t.userId,peerIndex:t.peerIndex,mediaTypes:w.getAcceptingMediaTypes(t)};x(r,Object(v.b)(e.track,t.recvPc),a)}else console.warn("failed to find media type from mid")})),u(t.peerIndex),a({type:"NEW_CONNECTION",peerIndex:t.peerIndex}),t},G=function(e){if(!Object(f.c)(e))return null;var n=e.userId;return"string"!==typeof n?null:n},Z=function(){var e=Object(i.a)(c.a.mark((function e(n){var t,r,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.from!==h){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,I(n.data);case 4:if(t=e.sent,r=G(t),(a=w.getConn(n.from))||(r?a=J(n.from,r):console.warn("cannot initialize conn without user id")),!a){e.next=11;break}return e.next=11,W(a,t);case 11:j();case 12:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),q=function(){var e=Object(i.a)(c.a.mark((function e(){var n,t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y){e.next=2;break}return e.abrupt("return");case 2:if(n=m?m.pubsub.peers(g):[],w.forEachConns((function(e){n.includes(e.peer)||(w.delConn(e),a({type:"CONNECTION_CLOSED",peerIndex:e.peerIndex}))})),!(m&&0===w.size()&&B+18e4<Date.now())){e.next=15;break}return t=m,m=null,h=null,e.next=10,H(t);case 10:return e.next=12,Object(o.a)(2e4);case 12:return e.next=14,F();case 14:return e.abrupt("return");case 15:if(n.length){e.next=21;break}return a({type:"CONNECTING_SEED_PEERS"}),e.next=19,Object(o.a)(1e3);case 19:return q(),e.abrupt("return");case 21:if(w.size()){e.next=24;break}return e.next=24,P(null);case 24:return e.next=26,Object(o.a)(5e3);case 26:q();case 27:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),B=0,(F=function(){var e=Object(i.a)(c.a.mark((function e(){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return B=Date.now(),a({type:"INITIALIZING_PEER",peerIndex:0}),e.next=4,s.a.create({repo:Object(d.h)(),config:{Addresses:{Swarm:["/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star/"]}}});case 4:return n=e.sent,e.next=7,n.id();case 7:return h=e.sent.id,e.next=10,n.pubsub.subscribe(g,Z);case 10:return e.next=12,n.pubsub.subscribe("".concat(g," ").concat(h),Z);case 12:m=n,q();case 15:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}())(),H=function(){var e=Object(i.a)(c.a.mark((function e(n){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.pubsub.unsubscribe("".concat(g," ").concat(h),Z);case 2:return e.next=4,n.pubsub.unsubscribe(g,Z);case 4:return e.next=6,n.stop();case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),K=new Map,Q=function(){var e={};return K.forEach((function(n,t){var r=n.stream;e[r.id]=t})),e},U=function(e,n){if(K.has(e))throw new Error("track is already added for ".concat(e));var t=new MediaStream([n]);K.set(e,{stream:t,track:n}),w.forEachConnsAcceptingMedia(e,(function(e){try{e.sendPc.addTrack(n,t),S(e)}catch(r){if("InvalidAccessError"!==r.name)throw r}}))},V=function(e){var n=K.get(e);if(n){var t=n.track;K.delete(e),w.forEachConnsAcceptingMedia(e,(function(e){var n=e.sendPc.getSenders().find((function(e){return e.track===t}));n&&(e.sendPc.removeTrack(n),S(e))}))}else console.log("track is already removed for",e)},X=function(e){var n=e.sendPc.getSenders(),t=w.getAcceptingMediaTypes(e);t.forEach((function(t){var r=K.get(t);if(r){var a=r.stream,c=r.track;n.every((function(e){return e.track!==c}))&&(e.sendPc.addTrack(c,a),S(e))}})),n.forEach((function(n){n.track&&(t.some((function(e){var t;return(null===(t=K.get(e))||void 0===t?void 0:t.track)===n.track}))||(e.sendPc.removeTrack(n),S(e)))}))},Y=function(){var e=Object(i.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:y=!0,m&&H(m);case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{broadcastData:P,sendData:C,acceptMediaTypes:M,addTrack:U,removeTrack:V,dispose:Y});case 42:case"end":return e.stop()}}),e)})));return function(n,t,r,a,c,i){return e.apply(this,arguments)}}()},94:function(e,n,t){"use strict";t.d(n,"c",(function(){return r})),t.d(n,"b",(function(){return a})),t.d(n,"a",(function(){return c}));var r=function(e){return"object"===typeof e&&null!==e},a=function(e,n){return"string"===typeof e[n]},c=function(e,n){return r(e[n])}}}]);
//# sourceMappingURL=6.2ada995a.chunk.js.map