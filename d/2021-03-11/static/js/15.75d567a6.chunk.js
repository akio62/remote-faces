(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[15],{1248:function(e,t,n){},1271:function(e,t,n){"use strict";n.r(t),n.d(t,"SpatialArea",(function(){return w}));var r=n(103),a=n(2),c=n.n(a),i=n(3),o=n(4),u=n(0),s=n(1),f=n.n(s),d=n(201),v=n(529),l=n(1256),b=n(1263),p=(n(1248),n(14)),j=n(110),m=n(19),O=n(530),h=n(202),g=n(133),x=f.a.memo((function(e){var t=e.nickname,n=e.faceStream,a=e.statusMesg,f=e.position,p=e.setPosition,j=e.distance,m=e.muted,O=!!p,h=Object(v.b)(),x=h.size,k=h.viewport,w=x.width/k.width,M=Object(s.useRef)(),y=Object(l.a)((function(e){var t=e.first,n=Object(o.a)(e.initial,2),r=n[0],a=n[1],c=Object(o.a)(e.xy,2),i=c[0],u=c[1];t&&(M.current=f);var s=M.current,d=Object(o.a)(s,2),v=d[0],l=d[1];p&&p([v+(i-r)/w,l-(u-a)/w,0])})),S=function(e){var t=Object(s.useState)(),n=Object(o.a)(t,2),r=n[0],a=n[1];Object(s.useEffect)((function(){if(e){var t=e,n=function(){a(t.getVideoTracks()[0])};return e.addEventListener("addtrack",n),n(),function(){return e.removeEventListener("addtrack",n)}}}),[e]),Object(s.useEffect)((function(){r&&r.addEventListener("ended",(function(){a(void 0)}))}),[r]);var c=Object(s.useState)(),i=Object(o.a)(c,2),u=i[0],f=i[1];return Object(s.useEffect)((function(){if(r){var e=document.createElement("video");e.autoplay=!0,e.srcObject=new MediaStream([r]);var t=new d.VideoTexture(e);f(t)}}),[r]),u}(n),E=function(e,t){var n=Object(s.useState)(),r=Object(o.a)(n,2),a=r[0],u=r[1];Object(s.useEffect)((function(){if(e){var t=e,n=function(){u(t.getAudioTracks()[0])};return e.addEventListener("addtrack",n),n(),function(){return e.removeEventListener("addtrack",n)}}}),[e]),Object(s.useEffect)((function(){a&&a.addEventListener("ended",(function(){u(void 0)}))}),[a]);var f=Object(s.useRef)(null),d=Object(s.useRef)(.5),v=Object(s.useState)(null),l=Object(o.a)(v,2),b=l[0],p=l[1],j=Object(s.useCallback)((function(e){f.current?(p(e),f.current(e)):(p(null),d.current=e)}),[]);return Object(s.useEffect)((function(){if(!t&&a){var e=new AudioContext,n=e.createMediaStreamDestination(),r=e.createMediaStreamSource(new MediaStream([a])),o=e.createGain();o.gain.value=d.current,p(d.current),f.current=function(t){o.gain.setValueAtTime(t,e.currentTime)},r.connect(o),o.connect(n);var u=n.stream.getAudioTracks()[0],s=document.createElement("video");return s.autoplay=!0,s.setAttribute("playsinline",""),s.style.display="block",s.style.width="1px",s.style.height="1px",s.style.position="absolute",s.style.bottom="0px",document.body.appendChild(s),Object(i.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=MediaStream,e.next=3,Object(g.b)(u);case 3:e.t1=e.sent,e.t2=[e.t1],s.srcObject=new e.t0(e.t2);case 6:case"end":return e.stop()}}),e)})))(),function(){f.current=null,p(null),e.close(),u.dispatchEvent(new Event("ended")),document.body.removeChild(s)}}}),[t,a]),[b,j]}(n,O),I=Object(o.a)(E,2),A=I[0],C=I[1];return Object(s.useEffect)((function(){if(void 0===j||m)C(0);else{var e=Math.max(0,j-.2);C(Math.min(1,Math.max(0,1/(e*e)-.1)))}}),[m,j,C]),S?Object(u.jsxs)(u.Fragment,{children:[Object(u.jsx)("sprite",Object(r.a)(Object(r.a)({},O&&y()),{},{position:f,children:Object(u.jsx)("spriteMaterial",{map:S})})),Object(u.jsx)(b.a,{color:"blue",fontSize:.3,anchorX:"left",anchorY:"top",position:[f[0]-.5,f[1]+.5,f[2]],children:t}),Object(u.jsx)(b.a,{color:"darkgreen",fontSize:.3,anchorX:"left",anchorY:"middle",font:"https://fonts.gstatic.com/ea/notosansjapanese/v6/NotoSansJP-Bold.woff",position:[f[0]-.5,f[1],f[2]],children:a}),null!==A&&Object(u.jsx)(b.a,{color:"red",fontSize:.3,anchorX:"left",anchorY:"bottom",position:[f[0]-.5,f[1]-.5,f[2]],children:A.toFixed(2)})]}):null})),k=f.a.memo((function(e){var t=e.userId,n=e.nickname,a=e.statusMesg,c=e.faceStream,i=e.nicknameMap,o=e.faceStreamMap,f=e.avatarMap,d=e.myAvatar,l=e.setMyAvatar,b=function(e){var t;return(null===(t=f[e])||void 0===t?void 0:t.statusMesg)||""},p=function(e){var t;return(null===(t=f[e])||void 0===t?void 0:t.position)||[0,0,0]},j=(null===d||void 0===d?void 0:d.position)||[0,0,0];return Object(u.jsx)(v.a,{children:Object(u.jsxs)(s.Suspense,{fallback:null,children:[Object(u.jsx)("ambientLight",{}),Object.keys(o).map((function(e){if(e===t)return null;var n=p(e),r=Math.hypot(n[0]-j[0],n[1]-j[1],n[2]-j[2]);return Object(u.jsx)(x,{nickname:i[e]||"",faceStream:o[e]||null,statusMesg:b(e),position:p(e),distance:r},e)})),Object(u.jsx)(x,{nickname:n,faceStream:c,statusMesg:a,position:j,setPosition:function(e){l((function(t){return Object(r.a)(Object(r.a)({},t),{},{position:e})}))},muted:!0})]})})})),w=f.a.memo((function(e){var t=e.roomId,n=e.userId,a=e.nickname,c=e.statusMesg,i=Object(m.b)(),f=Object(s.useState)(""),d=Object(o.a)(f,2),v=d[0],l=d[1],b=Object(m.a)(),g=Object(s.useState)(""),x=Object(o.a)(g,2),w=x[0],M=x[1],y=Object(O.a)(t,n,!!v,!!w,!!w,v,w,"spatialArea"),S=y.faceStream,E=y.faceStreamMap,I=Object(h.a)(t,n),A=function(e,t,n){var a,c=Object(s.useState)({}),i=Object(o.a)(c,2),u=i[0],f=i[1],d=Object(s.useState)({statusMesg:n,position:(a=t,[parseInt(a.slice(0,2),16)/128-1,parseInt(a.slice(2,4),16)/128-1,0])}),v=Object(o.a)(d,2),l=v[0],b=v[1];Object(s.useEffect)((function(){b((function(e){return e.statusMesg===n?e:Object(r.a)(Object(r.a)({},e),{},{statusMesg:n})}))}),[n]),Object(s.useEffect)((function(){var n=Object(j.a)(e,t),a=n.ydoc.getMap("spatialArea"),c=function(){f((function(e){var c=Object(r.a)({},e),i=!1;return a.forEach((function(e,r){var a,o;r!==t&&function(e){try{var t=e;return"string"===typeof t.statusMesg&&"number"===typeof t.position[0]&&"number"===typeof t.position[1]&&"number"===typeof t.position[2]}catch(n){return!1}}(e)&&(!c[r]&&n.userIdMap[r]||c[r]&&(a=e,o=c[r],a.statusMesg!==o.statusMesg||a.position[0]!==o.position[0]||a.position[1]!==o.position[1]||a.position[2]!==o.position[2]))&&(c[r]=e,i=!0)})),i?c:e}))};a.observe(c),c();var i=Object(p.d)(n.userIdMap,(function(){f((function(e){var t=Object.keys(e),r=t.filter((function(e){return n.userIdMap[e]}));if(t.length!==r.length){var a={};return r.forEach((function(t){a[t]=e[t]})),a}return e}))}));return function(){i(),a.unobserve(c)}}),[e,t]);var m=Object(s.useRef)();return Object(s.useEffect)((function(){l&&(m.current?m.current=l:(m.current=l,setTimeout((function(){Object(j.a)(e,t).ydoc.getMap("spatialArea").set(t,m.current),m.current=void 0}),500)))}),[e,t,l]),{avatarMap:u,myAvatar:l,setMyAvatar:b}}(t,n,c),C=A.avatarMap,L=A.myAvatar,T=A.setMyAvatar;return Object(u.jsxs)("div",{className:"SpatialArea-container",children:[Object(u.jsxs)("div",{children:["Select Camera:"," ",Object(u.jsxs)("select",{value:v,onChange:function(e){return l(e.target.value)},children:[Object(u.jsx)("option",{value:"",children:"None"}),i.map((function(e){return Object(u.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId)}))]})]}),Object(u.jsxs)("div",{children:["Select Mic:"," ",Object(u.jsxs)("select",{value:w,onChange:function(e){M(e.target.value)},children:[Object(u.jsx)("option",{value:"",children:"None"}),b.map((function(e){return Object(u.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId)}))]})]}),Object(u.jsx)("div",{className:"SpatialArea-body",children:Object(u.jsx)(k,{userId:n,nickname:a,statusMesg:c,faceStream:S,nicknameMap:I,faceStreamMap:E,avatarMap:C,myAvatar:L,setMyAvatar:T})})]})}));t.default=w},133:function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return f})),n.d(t,"d",(function(){return d})),n.d(t,"a",(function(){return l}));var r=n(4),a=n(2),c=n.n(a),i=n(3),o=n(109),u=new WeakMap,s=function(e,t){if(u.has(e))return e;u.set(e,!0);var n=function(){var n=Object(i.a)(c.a.mark((function n(){var r;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,Object(o.a)(5e3);case 2:!(r=t.getTransceivers().find((function(t){return t.receiver.track===e})))||"inactive"!==r.currentDirection&&"sendonly"!==r.currentDirection||(e.stop(),e.dispatchEvent(new Event("ended")));case 4:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();return e.addEventListener("mute",n),e},f=function(e){return new Promise(function(){var t=Object(i.a)(c.a.mark((function t(n,r){var a,i,o,u;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=new RTCPeerConnection,i=new RTCPeerConnection,a.addEventListener("icecandidate",(function(e){var t=e.candidate;t&&i.addIceCandidate(t)})),i.addEventListener("icecandidate",(function(e){var t=e.candidate;t&&a.addIceCandidate(t)})),i.addEventListener("track",(function(e){n(e.track)})),e.addEventListener("ended",(function(){a.close(),i.close()})),a.addTrack(e),t.next=10,a.createOffer();case 10:return o=t.sent,t.next=13,a.setLocalDescription(o);case 13:return t.next=15,i.setRemoteDescription(o);case 15:return t.next=17,i.createAnswer();case 17:return u=t.sent,t.next=20,i.setLocalDescription(u);case 20:return t.next=22,a.setRemoteDescription(u);case 22:t.next=27;break;case 24:t.prev=24,t.t0=t.catch(0),r(t.t0);case 27:case"end":return t.stop()}}),t,null,[[0,24]])})));return function(e,n){return t.apply(this,arguments)}}())},d=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,a,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("video"===t.kind){e.next=2;break}throw new Error("track kind is not video");case 2:return n=document.createElement("canvas"),r=n.getContext("2d"),a=new ImageCapture(t),o=function(){var e=Object(i.a)(c.a.mark((function e(){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.grabFrame();case 3:return t=e.sent,n.width=t.width,n.height=t.height,r.drawImage(t,0,0),e.abrupt("return",n.toDataURL("image/jpeg"));case 10:return e.prev=10,e.t0=e.catch(0),console.log("failed to grab frame from viedeo track",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{getImage:o});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),v=function(e){return new Promise((function(t,n){var r=new Image;r.onload=function(){return t(r)},r.onerror=n,r.src=e}))},l=function(){var e=document.createElement("canvas"),t=e.getContext("2d"),n=e.captureStream().getVideoTracks();return{videoTrack:Object(r.a)(n,1)[0],setImage:function(){var n=Object(i.a)(c.a.mark((function n(r){var a;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,v(r);case 2:a=n.sent,e.width=a.width,e.height=a.height,t.drawImage(a,0,0);case 6:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}()}}},202:function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var r=n(103),a=n(4),c=n(1),i=n(106),o=n(110),u=function(e,t){var n=Object(c.useState)({}),u=Object(a.a)(n,2),s=u[0],f=u[1];return Object(c.useEffect)((function(){var n=Object(o.a)(e,t).ydoc.getMap("faceImages"),a=function(){f((function(e){var a=Object(r.a)({},e),c=!1;return n.forEach((function(e,n){var r;n!==t&&(r=e,Object(i.c)(r)&&Object(i.c)(r.info)&&"string"===typeof r.info.nickname&&(a[n]?e.info.nickname!==a[n]&&(a[n]=e.info.nickname,c=!0):(a[n]=e.info.nickname,c=!0)))})),c?a:e}))};return n.observe(a),a(),function(){n.unobserve(a)}}),[e,t]),s}}}]);
//# sourceMappingURL=15.75d567a6.chunk.js.map