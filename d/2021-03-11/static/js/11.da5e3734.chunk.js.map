{"version":3,"sources":["utils/types.ts","utils/sleep.ts","states/roomMap.ts","media/capture.ts","hooks/useFaceImages.ts","components/FaceImages.tsx","components/ControlPanel.tsx","components/SelectivePane.tsx","components/SingleRoom.tsx","media/video.ts","media/audio.ts","hooks/useFaceVideos.ts"],"names":["isObject","x","hasStringProp","prop","hasObjectProp","sleep","ms","Promise","resolve","setTimeout","roomMap","Map","getRoomState","roomId","userId","key","has","state","addMediaType","type","a","acceptingMediaTypes","includes","console","log","push","roomPromise","acceptMediaTypes","snapshot","removeMediaType","index","indexOf","splice","addTrack","track","removeTrack","dispose","proxy","networkStatusList","userIdMap","ydoc","ref","Y","trackMap","on","update","base64","btoa","String","fromCharCode","then","room","broadcastData","ydocUpdate","createRoom","status","unshift","length","pop","Object","entries","forEach","uid","peerIndex","data","sendData","info","binaryString","atob","Uint8Array","map","call","c","charCodeAt","mediaType","createRoomState","set","get","captureImage","stream","ImageCapture","imageCapture","takePhoto","blob","createImageBitmap","srcImg","grabFrame","srcW","width","srcH","height","video","document","createElement","autoplay","setAttribute","style","display","position","bottom","body","appendChild","removeChild","srcObject","videoWidth","videoHeight","deviceId","constraints","navigator","mediaDevices","getUserMedia","getVideoTracks","canvas","ctx","getContext","dstW","dstH","ratio","Math","max","min","y","drawImage","stop","toDataURL","isImageData","image","nickname","message","liveMode","micOn","speakerOn","isFaceInfo","updated","FaceImage","React","memo","statusMesg","obsoleted","muted","className","opacity","videoEle","autoPlay","playsInline","src","BLANK_IMAGE","alt","title","FaceImages","avatar","suspended","videoDeviceId","audioDeviceId","useState","myImage","setMyImage","roomImages","setRoomImages","fatalError","setFatalError","useEffect","roomState","getMap","listener","prev","twoMinAgo","Date","now","copied","changed","findIndex","item","observe","unsub","subscribe","next","filter","unobserve","timer","checkObsoletedImage","tenMinAgo","flatMap","didCleanup","loop","clearTimeout","useFaceImages","useFaceVideos","faceStream","faceStreamMap","undefined","ControlPanel","setSuspended","setLiveMode","setMicOn","setSpeakerOn","secondColumnOpen","setSecondColumnOpen","onClick","onChange","e","target","value","Error","components","Welcome","lazy","SelectivePane","setStatusMesg","activePane","setActivePane","multiple","size","keys","name","idx","fallback","SuspenseFallback","SingleRoom","useProxy","singleRoomState","config","setRoomIdToUrl","getVideoStream","getFaceVideoStream","frameRate","exact","getAudioStream","audio","getAudioTracks","applyConstraints","echoCancellation","echoCancellationType","ideal","noiseSuppression","addTrackToStream","disposeStream","newStream","MediaStream","dispatchEvent","MediaStreamTrackEvent","addEventListener","getTracks","videoEnabled","audioEnabled","uniqueMediaId","videoType","audioType","setFaceStream","setFaceStreamMap","isMounted","useRef","current","onTrack","s","oldStream","rest","videoStream","disposeVideo","videoTrack","Event","audioStream","disposeAudio","audioTrack","enabled","onaddtrack","event","kind","removeEventListener"],"mappings":"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","file":"static/js/11.da5e3734.chunk.js","sourcesContent":["export const isObject = (x: unknown): x is Record<string, unknown> =>\n  typeof x === \"object\" && x !== null;\n\nexport const hasStringProp = <\n  Obj extends Record<string, unknown>,\n  Prop extends string\n>(\n  x: Obj,\n  prop: Prop\n): x is Obj & Record<Prop, string> =>\n  typeof (x as Record<Prop, unknown>)[prop] === \"string\";\n\nexport const hasObjectProp = <\n  Obj extends Record<string, unknown>,\n  Prop extends string\n>(\n  x: Obj,\n  prop: Prop\n): x is Obj & Record<Prop, Record<string, unknown>> =>\n  isObject((x as Record<Prop, unknown>)[prop]);\n\nexport type ReturnPromiseType<\n  F extends (...args: any) => any\n> = ReturnType<F> extends Promise<infer T> ? T : never;\n","export const sleep = (ms: number) =>\n  new Promise((resolve) => setTimeout(resolve, ms));\n","import { proxy, snapshot, ref } from \"valtio\";\nimport * as Y from \"yjs\";\n\nimport { PeerInfo, createRoom, NetworkStatus } from \"../network/room\";\n\ntype RoomState = {\n  networkStatusList: NetworkStatus[];\n  userIdMap: { [userId: string]: number }; // peerIndex\n  ydoc: Y.Doc;\n  acceptingMediaTypes: string[];\n  trackMap: {\n    [mediaType: string]: {\n      [userId: string]: MediaStreamTrack;\n    };\n  };\n  addMediaType: (type: string) => Promise<void>;\n  removeMediaType: (type: string) => Promise<void>;\n  addTrack: (type: string, track: MediaStreamTrack) => Promise<void>;\n  removeTrack: (type: string) => Promise<void>;\n  dispose: () => Promise<void>;\n};\n\nconst createRoomState = (roomId: string, userId: string) => {\n  const addMediaType = async (type: string) => {\n    if (state.acceptingMediaTypes.includes(type)) {\n      console.log(\"media type already added\", type);\n      return;\n    }\n    state.acceptingMediaTypes.push(type);\n    const room = await roomPromise;\n    room.acceptMediaTypes(snapshot(state.acceptingMediaTypes));\n  };\n  const removeMediaType = async (type: string) => {\n    const index = state.acceptingMediaTypes.indexOf(type);\n    if (index === -1) {\n      console.log(\"media type already added\", type);\n      return;\n    }\n    state.acceptingMediaTypes.splice(index, 1);\n    const room = await roomPromise;\n    room.acceptMediaTypes(snapshot(state.acceptingMediaTypes));\n  };\n  const addTrack = async (type: string, track: MediaStreamTrack) => {\n    const room = await roomPromise;\n    room.addTrack(type, track);\n  };\n  const removeTrack = async (type: string) => {\n    const room = await roomPromise;\n    room.removeTrack(type);\n  };\n  const dispose = async () => {\n    const room = await roomPromise;\n    room.dispose();\n  };\n  const state = proxy<RoomState>({\n    networkStatusList: [],\n    userIdMap: {},\n    ydoc: ref(new Y.Doc()),\n    acceptingMediaTypes: [],\n    trackMap: {},\n    addMediaType,\n    removeMediaType,\n    addTrack,\n    removeTrack,\n    dispose,\n  });\n  const updateNetworkStatus = (status: NetworkStatus) => {\n    state.networkStatusList.unshift(status);\n    if (state.networkStatusList.length > 10) {\n      state.networkStatusList.pop();\n    }\n    if (status?.type === \"CONNECTION_CLOSED\") {\n      Object.entries(state.userIdMap).forEach(([uid, idx]) => {\n        if (idx === status.peerIndex) {\n          delete state.userIdMap[uid];\n        }\n      });\n    }\n  };\n  const notifyNewPeer = (peerIndex: number) => {\n    const update = Y.encodeStateAsUpdate(state.ydoc);\n    const base64 = btoa(String.fromCharCode(...update));\n    const data = { ydocUpdate: base64 };\n    roomPromise.then((room) => {\n      room.sendData(data, peerIndex);\n    });\n  };\n  const receiveData = (data: any, info: PeerInfo) => {\n    state.userIdMap[info.userId] = info.peerIndex;\n    if (data?.ydocUpdate) {\n      const binaryString = atob(data.ydocUpdate);\n      const update = new Uint8Array(\n        ([].map.call(binaryString, (c: string) =>\n          c.charCodeAt(0)\n        ) as unknown) as ArrayBufferLike\n      );\n      Y.applyUpdate(state.ydoc, update);\n    }\n  };\n  state.ydoc.on(\"update\", (update: Uint8Array) => {\n    const base64 = btoa(String.fromCharCode(...update));\n    roomPromise.then((room) => {\n      room.broadcastData({ ydocUpdate: base64 });\n    });\n  });\n  const receiveTrack = (\n    mediaType: string,\n    track: MediaStreamTrack,\n    info: PeerInfo\n  ) => {\n    if (!state.trackMap[mediaType]) {\n      state.trackMap[mediaType] = {};\n    }\n    state.trackMap[mediaType][info.userId] = ref(track);\n  };\n  const roomPromise = createRoom(\n    roomId,\n    userId,\n    updateNetworkStatus,\n    notifyNewPeer,\n    receiveData,\n    receiveTrack\n  );\n  return state;\n};\n\nconst roomMap = new Map<string, RoomState>();\n\nexport const getRoomState = (roomId: string, userId: string) => {\n  const key = `${roomId}:${userId}`;\n  if (!roomMap.has(key)) {\n    const state = createRoomState(roomId, userId);\n    roomMap.set(key, state);\n  }\n  return roomMap.get(key) as RoomState;\n};\n\nexport const disposeRoomState = (roomId: string, userId: string) => {\n  const key = `${roomId}:${userId}`;\n  const state = roomMap.get(key);\n  if (state) {\n    roomMap.delete(key);\n    state.dispose();\n  }\n};\n","import { sleep } from \"../utils/sleep\";\n\nconst captureImage = async (stream: MediaStream, track: MediaStreamTrack) => {\n  if (typeof ImageCapture !== \"undefined\") {\n    const imageCapture = new ImageCapture(track);\n    await sleep(2000);\n    let srcImg: ImageBitmap;\n    try {\n      const blob = await imageCapture.takePhoto();\n      srcImg = await createImageBitmap(blob);\n    } catch (e) {\n      srcImg = await imageCapture.grabFrame();\n    }\n    const srcW = srcImg.width;\n    const srcH = srcImg.height;\n    return { srcImg, srcW, srcH };\n  }\n  const video = document.createElement(\"video\");\n  video.autoplay = true;\n  video.setAttribute(\"playsinline\", \"\");\n  video.style.display = \"block\";\n  video.style.width = \"1px\";\n  video.style.height = \"1px\";\n  video.style.position = \"absolute\";\n  video.style.bottom = \"0\";\n  document.body.appendChild(video);\n  const dispose = () => {\n    document.body.removeChild(video);\n  };\n  video.srcObject = stream;\n  await sleep(2000);\n  const srcImg = video;\n  const srcW = video.videoWidth;\n  const srcH = video.videoHeight;\n  return { srcImg, srcW, srcH, dispose };\n};\n\nexport const takePhoto = async (deviceId?: string) => {\n  const constraints = deviceId\n    ? {\n        video: { deviceId },\n      }\n    : { video: true };\n  const stream = await navigator.mediaDevices.getUserMedia(constraints);\n  const [track] = stream.getVideoTracks();\n  const canvas = document.createElement(\"canvas\");\n  const ctx = canvas.getContext(\"2d\") as CanvasRenderingContext2D;\n  const dstW = 72;\n  const dstH = 72;\n  canvas.width = dstW;\n  canvas.height = dstH;\n  const { srcImg, srcW, srcH, dispose } = await captureImage(stream, track);\n  const ratio = Math.max(dstW / srcW, dstH / srcH);\n  const width = Math.min(srcW, dstW / ratio);\n  const height = Math.min(srcH, dstH / ratio);\n  const x = (srcW - width) / 2;\n  const y = (srcH - height) / 2;\n  ctx.drawImage(srcImg, x, y, width, height, 0, 0, dstW, dstH);\n  if (dispose) {\n    dispose();\n  }\n  track.stop();\n  return canvas.toDataURL(\"image/jpeg\");\n};\n","import { useEffect, useState } from \"react\";\nimport { subscribe } from \"valtio\";\n\nimport { isObject } from \"../utils/types\";\nimport { takePhoto } from \"../media/capture\";\nimport { getRoomState } from \"../states/roomMap\";\n\ntype ImageUrl = string;\n\ntype FaceInfo = {\n  nickname: string;\n  message: string;\n  liveMode: boolean;\n  micOn: boolean;\n  speakerOn: boolean;\n};\n\nconst isFaceInfo = (x: unknown): x is FaceInfo =>\n  isObject(x) &&\n  typeof (x as { nickname: unknown }).nickname === \"string\" &&\n  typeof (x as { message: unknown }).message === \"string\" &&\n  typeof (x as { liveMode: unknown }).liveMode === \"boolean\" &&\n  typeof (x as { micOn: unknown }).micOn === \"boolean\" &&\n  typeof (x as { speakerOn: unknown }).speakerOn === \"boolean\";\n\ntype ImageData = {\n  userId: string;\n  image: ImageUrl;\n  info: FaceInfo;\n  updated: number; // in milliseconds\n};\n\nconst isImageData = (x: unknown): x is ImageData =>\n  isObject(x) &&\n  typeof (x as { image: unknown }).image === \"string\" &&\n  isFaceInfo((x as { info: unknown }).info) &&\n  typeof (x as { updated: unknown }).updated === \"number\";\n\nexport const useFaceImages = (\n  roomId: string,\n  userId: string,\n  avatar: string,\n  nickname: string,\n  statusMesg: string,\n  suspended: boolean,\n  liveMode: boolean,\n  micOn: boolean,\n  speakerOn: boolean,\n  deviceId?: string\n) => {\n  const [myImage, setMyImage] = useState<ImageUrl>();\n  const [roomImages, setRoomImages] = useState<ImageData[]>([]);\n\n  const [fatalError, setFatalError] = useState<Error>();\n  if (fatalError) {\n    throw fatalError;\n  }\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(\"faceImages\");\n    const listener = () => {\n      setRoomImages((prev) => {\n        const twoMinAgo = Date.now() - 2 * 60 * 1000;\n        const copied = [...prev];\n        let changed = false;\n        map.forEach((data, uid) => {\n          if (uid === userId) return;\n          if (!isImageData(data)) return;\n          if (data.updated < twoMinAgo) return;\n          const index = copied.findIndex((item) => item.userId === uid);\n          if (index === -1 && roomState.userIdMap[uid]) {\n            copied.push(data);\n            changed = true;\n          } else if (data.updated > copied[index].updated) {\n            copied[index] = data;\n            changed = true;\n          }\n        });\n        if (changed) {\n          return copied;\n        }\n        return prev;\n      });\n    };\n    map.observe(listener);\n    listener();\n    const unsub = subscribe(roomState.userIdMap, () => {\n      setRoomImages((prev) => {\n        const next = prev.filter((item) => roomState.userIdMap[item.userId]);\n        return prev.length !== next.length ? next : prev;\n      });\n    });\n    return () => {\n      unsub();\n      map.unobserve(listener);\n    };\n  }, [roomId, userId]);\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(\"faceImages\");\n    const checkObsoletedImage = () => {\n      const tenMinAgo = Date.now() - 10 * 60 * 1000;\n      setRoomImages((prev) => {\n        const next = prev.flatMap((item) => {\n          if (item.updated < tenMinAgo) {\n            return [];\n          }\n          return [item];\n        });\n        return prev.length !== next.length ? next : prev;\n      });\n    };\n    let didCleanup = false;\n    let timer: NodeJS.Timeout;\n    const loop = async () => {\n      if (didCleanup) return;\n      try {\n        checkObsoletedImage();\n        const image = suspended ? avatar : await takePhoto(deviceId);\n        if (didCleanup) return;\n        setMyImage(image);\n        const info: FaceInfo = {\n          nickname,\n          message: statusMesg,\n          liveMode,\n          micOn,\n          speakerOn,\n        };\n        const data: ImageData = {\n          userId,\n          image,\n          info,\n          updated: Date.now(),\n        };\n        map.set(userId, data);\n      } catch (e) {\n        setFatalError(e);\n      }\n      timer = setTimeout(loop, 2 * 60 * 1000);\n    };\n    loop();\n    return () => {\n      didCleanup = true;\n      clearTimeout(timer);\n    };\n  }, [\n    roomId,\n    userId,\n    deviceId,\n    avatar,\n    nickname,\n    statusMesg,\n    suspended,\n    liveMode,\n    micOn,\n    speakerOn,\n  ]);\n\n  return {\n    myImage,\n    roomImages,\n  };\n};\n","import React from \"react\";\n\nimport \"./FaceImages.css\";\nimport { BLANK_IMAGE } from \"../media/imagePresets\";\nimport { useFaceImages } from \"../hooks/useFaceImages\";\nimport { useFaceVideos } from \"../hooks/useFaceVideos\";\n\nconst FaceImage = React.memo<{\n  image?: string;\n  nickname: string;\n  statusMesg: string;\n  obsoleted?: boolean;\n  liveMode: boolean;\n  stream?: MediaStream;\n  muted: boolean;\n  micOn: boolean;\n  speakerOn: boolean;\n}>(\n  ({\n    image,\n    nickname,\n    statusMesg,\n    obsoleted,\n    liveMode,\n    stream,\n    muted,\n    micOn,\n    speakerOn,\n  }) => (\n    <div className=\"FaceImages-card\" style={{ opacity: obsoleted ? 0.2 : 1 }}>\n      {liveMode && !obsoleted && stream ? (\n        <video\n          className=\"FaceImages-photo\"\n          ref={(videoEle) => {\n            if (videoEle && videoEle.srcObject !== stream) {\n              // eslint-disable-next-line no-param-reassign\n              videoEle.srcObject = stream;\n            }\n          }}\n          autoPlay\n          playsInline\n          muted={muted}\n        />\n      ) : (\n        <img\n          src={image || BLANK_IMAGE}\n          className=\"FaceImages-photo\"\n          alt=\"myself\"\n        />\n      )}\n      <div className=\"FaceImages-name\">{nickname}</div>\n      <div\n        className=\"FaceImages-mesg\"\n        title={[...statusMesg][1] ? statusMesg : \"(No status message)\"}\n      >\n        {[...statusMesg][0]}\n      </div>\n      {liveMode && !obsoleted && stream && (\n        <div className=\"FaceImages-live-indicator\" title=\"Live Mode On\">\n          &#9673;\n        </div>\n      )}\n      {liveMode && !obsoleted && !stream && (\n        <div className=\"FaceImages-live-indicator\" title=\"Live Mode Available\">\n          &#9678;\n        </div>\n      )}\n      {liveMode && !obsoleted && (\n        <div className=\"FaceImages-mic-speaker-icons\">\n          {micOn && <span title=\"Mic On\">&#x1F3A4;</span>}\n          {speakerOn && <span title=\"Speaker On\">&#x1F508;</span>}\n        </div>\n      )}\n    </div>\n  )\n);\n\nexport const FaceImages = React.memo<{\n  roomId: string;\n  userId: string;\n  avatar: string;\n  nickname: string;\n  statusMesg: string;\n  suspended: boolean;\n  liveMode: boolean;\n  micOn: boolean;\n  speakerOn: boolean;\n  videoDeviceId?: string;\n  audioDeviceId?: string;\n}>(\n  ({\n    roomId,\n    userId,\n    avatar,\n    nickname,\n    statusMesg,\n    suspended,\n    liveMode,\n    micOn,\n    speakerOn,\n    videoDeviceId,\n    audioDeviceId,\n  }) => {\n    const { myImage, roomImages } = useFaceImages(\n      roomId,\n      userId,\n      avatar,\n      nickname,\n      statusMesg,\n      suspended,\n      liveMode,\n      micOn,\n      speakerOn,\n      videoDeviceId\n    );\n    const { faceStream, faceStreamMap } = useFaceVideos(\n      roomId,\n      userId,\n      liveMode,\n      liveMode,\n      micOn,\n      videoDeviceId,\n      audioDeviceId\n    );\n    const twoMinAgo = Date.now() - 2 * 60 * 1000;\n\n    return (\n      <>\n        <FaceImage\n          image={myImage}\n          nickname={nickname}\n          statusMesg={statusMesg}\n          liveMode={liveMode}\n          stream={faceStream || undefined}\n          muted\n          micOn={micOn}\n          speakerOn={speakerOn}\n        />\n        {roomImages.map((item) => (\n          <FaceImage\n            key={item.userId}\n            image={item.image}\n            nickname={item.info.nickname}\n            statusMesg={item.info.message}\n            obsoleted={item.updated < twoMinAgo}\n            liveMode={item.info.liveMode}\n            stream={(liveMode && faceStreamMap[item.userId]) || undefined}\n            muted={!speakerOn}\n            micOn={item.info.micOn}\n            speakerOn={item.info.speakerOn}\n          />\n        ))}\n      </>\n    );\n  }\n);\n","import React, { Dispatch, SetStateAction } from \"react\";\n\nimport \"./ControlPanel.css\";\n\nexport const ControlPanel = React.memo<{\n  suspended: boolean;\n  setSuspended: Dispatch<SetStateAction<boolean>>;\n  liveMode: boolean;\n  setLiveMode: Dispatch<SetStateAction<boolean>>;\n  micOn: boolean;\n  setMicOn: Dispatch<SetStateAction<boolean>>;\n  speakerOn: boolean;\n  setSpeakerOn: Dispatch<SetStateAction<boolean>>;\n  secondColumnOpen: boolean;\n  setSecondColumnOpen: Dispatch<SetStateAction<boolean>>;\n}>(\n  ({\n    suspended,\n    setSuspended,\n    liveMode,\n    setLiveMode,\n    setMicOn,\n    setSpeakerOn,\n    secondColumnOpen,\n    setSecondColumnOpen,\n  }) => (\n    <div className=\"ControlPanel-container\">\n      <button\n        type=\"button\"\n        onClick={() => setSuspended((x) => !x)}\n        title={suspended ? \"Enable Camera\" : \"Disable Camera\"}\n      >\n        &#x1F4F7;\n        {suspended && <span className=\"ControlPanel-disabled\">&#10060;</span>}\n      </button>\n      <button\n        type=\"button\"\n        onClick={() => setSecondColumnOpen((x) => !x)}\n        title={secondColumnOpen ? \"Close Right Pane\" : \"Open Right Pane\"}\n      >\n        {secondColumnOpen ? <>&#9664;</> : <>&#9654;</>}\n      </button>\n      <button\n        type=\"button\"\n        onClick={() => setLiveMode((x) => !x)}\n        title={liveMode ? \"Disable Live Mode\" : \"Enable Live Mode\"}\n      >\n        &#x1F3A5;\n        {!liveMode && <span className=\"ControlPanel-disabled\">&#10060;</span>}\n      </button>\n      <div className=\"ControlPanel-select\">\n        &#x1F39B;\n        <select\n          onChange={(e) => {\n            switch (e.target.value) {\n              case \"off\":\n                setSpeakerOn(false);\n                setMicOn(false);\n                break;\n              case \"speaker\":\n                setSpeakerOn(true);\n                setMicOn(false);\n                break;\n              case \"mic\":\n                setSpeakerOn(true);\n                setMicOn(true);\n                break;\n              default:\n                throw new Error(\"no option\");\n            }\n          }}\n        >\n          <option value=\"off\">Audio Off</option>\n          <option value=\"speaker\">Speaker Only</option>\n          <option value=\"mic\">Mic + Speaker</option>\n        </select>\n      </div>\n    </div>\n  )\n);\n","import React, { Suspense, createElement, useState } from \"react\";\n\nimport { SuspenseFallback } from \"./SuspenseFallback\";\nimport \"./SelectivePane.css\";\n\nconst components = {\n  Welcome: React.lazy(() => import(\"./Welcome\")),\n  \"Momentary Chat\": React.lazy(() => import(\"./MomentaryChat\")),\n  \"Spatial Area\": React.lazy(() => import(\"./SpatialArea\")),\n  \"Screen Share\": React.lazy(() => import(\"./ScreenShare\")),\n  \"White Board\": React.lazy(() => import(\"./CollabWhiteBoard\")),\n  \"Video Share\": React.lazy(() => import(\"./VideoShare\")),\n  \"Go Board\": React.lazy(() => import(\"./GoBoard\")),\n};\n\nexport const SelectivePane = React.memo<{\n  roomId: string;\n  userId: string;\n  nickname: string;\n  statusMesg: string;\n  setStatusMesg: (mesg: string) => void;\n}>(({ roomId, userId, nickname, statusMesg, setStatusMesg }) => {\n  const [activePane, setActivePane] = useState<string[]>([\n    \"Welcome\",\n    \"Momentary Chat\",\n  ]);\n  const togglePane = (name: string) => {\n    setActivePane((prev) => {\n      if (prev.includes(name)) {\n        return prev.filter((item) => item !== name);\n      }\n      return [...prev, name];\n    });\n  };\n  return (\n    <div className=\"SelectivePane-container\">\n      <div className=\"SelectivePane-select\">\n        &#9776;\n        <select\n          multiple\n          size={Object.keys(components).length}\n          value={activePane}\n          onChange={(e) => togglePane(e.target.value)}\n        >\n          {Object.keys(components).map((name) => {\n            const idx = activePane.indexOf(name);\n            if (idx >= 0) {\n              return (\n                <option key={name} value={name}>\n                  {`[${idx + 1}] ${name}`}\n                </option>\n              );\n            }\n            return (\n              <option key={name} value={name}>\n                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{name}\n              </option>\n            );\n          })}\n        </select>\n      </div>\n      <div className=\"SelectivePane-body\">\n        {activePane.map((name) => (\n          <Suspense key={name} fallback={<SuspenseFallback />}>\n            {createElement(components[name as keyof typeof components], {\n              roomId,\n              userId,\n              nickname,\n              statusMesg,\n              setStatusMesg,\n            })}\n          </Suspense>\n        ))}\n      </div>\n    </div>\n  );\n});\n","import React, { useEffect, useState } from \"react\";\nimport { useProxy } from \"valtio\";\n\nimport \"./SingleRoom.css\";\nimport { singleRoomState } from \"../states/singleRoom\";\nimport { setRoomIdToUrl } from \"../utils/url\";\nimport { FaceImages } from \"./FaceImages\";\nimport { ControlPanel } from \"./ControlPanel\";\nimport { SelectivePane } from \"./SelectivePane\";\n\nexport const SingleRoom = React.memo(() => {\n  const { roomId, userId, config } = useProxy(singleRoomState);\n  const [statusMesg, setStatusMesg] = useState(\"\");\n  useEffect(() => {\n    setRoomIdToUrl(roomId);\n  }, [roomId]);\n\n  const [suspended, setSuspended] = useState(true);\n  const [liveMode, setLiveMode] = useState(false);\n  const [micOn, setMicOn] = useState(false);\n  const [speakerOn, setSpeakerOn] = useState(false);\n  const [secondColumnOpen, setSecondColumnOpen] = useState(true);\n\n  return (\n    <div className=\"SingleRoom-container\">\n      <div className=\"SingleRoom-1st-column\">\n        <ControlPanel\n          suspended={suspended}\n          setSuspended={setSuspended}\n          liveMode={liveMode}\n          setLiveMode={setLiveMode}\n          micOn={micOn}\n          setMicOn={setMicOn}\n          speakerOn={speakerOn}\n          setSpeakerOn={setSpeakerOn}\n          secondColumnOpen={secondColumnOpen}\n          setSecondColumnOpen={setSecondColumnOpen}\n        />\n        <FaceImages\n          roomId={roomId}\n          userId={userId}\n          videoDeviceId={config.videoDeviceId}\n          audioDeviceId={config.audioDeviceId}\n          avatar={config.avatar}\n          nickname={config.nickname}\n          statusMesg={statusMesg}\n          suspended={suspended}\n          liveMode={liveMode}\n          micOn={micOn}\n          speakerOn={speakerOn}\n        />\n      </div>\n      <div\n        className=\"SingleRoom-2nd-column\"\n        style={{ display: secondColumnOpen ? \"inherit\" : \"none\" }}\n      >\n        <SelectivePane\n          roomId={roomId}\n          userId={userId}\n          nickname={config.nickname}\n          statusMesg={statusMesg}\n          setStatusMesg={setStatusMesg}\n        />\n      </div>\n    </div>\n  );\n});\n\nexport default SingleRoom;\n","export const getVideoStream = async (deviceId?: string) => {\n  const constraints = deviceId\n    ? {\n        video: { deviceId },\n      }\n    : { video: true };\n  const stream = await navigator.mediaDevices.getUserMedia(constraints);\n  const [track] = stream.getVideoTracks();\n  const dispose = () => {\n    track.stop();\n  };\n  return {\n    stream,\n    dispose,\n  };\n};\n\nexport const getFaceVideoStream = async (deviceId?: string) => {\n  const constraints = {\n    video: {\n      deviceId,\n      frameRate: { max: 5 },\n      width: { exact: 72 },\n      height: { exact: 72 },\n    },\n  };\n  const stream = await navigator.mediaDevices.getUserMedia(constraints);\n  const [track] = stream.getVideoTracks();\n  const dispose = () => {\n    track.stop();\n  };\n  return {\n    stream,\n    dispose,\n  };\n};\n","export const getAudioStream = async (deviceId?: string) => {\n  const constraints = deviceId\n    ? {\n        audio: { deviceId },\n      }\n    : { audio: true };\n  const stream = await navigator.mediaDevices.getUserMedia(constraints);\n  const [track] = stream.getAudioTracks();\n  await track.applyConstraints({\n    echoCancellation: true,\n    echoCancellationType: { ideal: \"system\" },\n    noiseSuppression: { ideal: true },\n  } as MediaTrackConstraints);\n  const dispose = () => {\n    track.stop();\n  };\n  return {\n    stream,\n    dispose,\n  };\n};\n","import { useEffect, useState, useRef } from \"react\";\nimport { useProxy } from \"valtio\";\n\nimport { getFaceVideoStream } from \"../media/video\";\nimport { getAudioStream } from \"../media/audio\";\nimport { getRoomState } from \"../states/roomMap\";\n\nconst addTrackToStream = (\n  track: MediaStreamTrack,\n  stream: MediaStream | null,\n  disposeStream: (s: MediaStream) => void\n) => {\n  const newStream = stream || new MediaStream();\n  newStream.addTrack(track);\n  newStream.dispatchEvent(new MediaStreamTrackEvent(\"addtrack\", { track }));\n  track.addEventListener(\"ended\", () => {\n    newStream.removeTrack(track);\n    if (newStream.getTracks().length === 0) {\n      disposeStream(newStream);\n    }\n  });\n  return newStream;\n};\n\nexport const useFaceVideos = (\n  roomId: string,\n  userId: string,\n  videoEnabled: boolean,\n  audioEnabled: boolean,\n  micOn: boolean,\n  videoDeviceId?: string,\n  audioDeviceId?: string,\n  uniqueMediaId?: string\n) => {\n  const videoType = `${uniqueMediaId || \"face\"}Video`;\n  const audioType = `${uniqueMediaId || \"face\"}Audio`;\n  const [faceStream, setFaceStream] = useState<MediaStream | null>(null);\n  const [faceStreamMap, setFaceStreamMap] = useState<{\n    [userId: string]: MediaStream;\n  }>({});\n\n  const isMounted = useRef(true);\n  useEffect(() => {\n    const cleanup = () => {\n      isMounted.current = false;\n    };\n    return cleanup;\n  }, []);\n\n  const onTrack = ([uid, track]: [string, MediaStreamTrack]) => {\n    if (faceStreamMap[uid]?.getTracks().includes(track)) return;\n    const disposeStream = (s: MediaStream) => {\n      if (isMounted.current) {\n        setFaceStreamMap((prev) => {\n          const { [uid]: oldStream, ...rest } = prev;\n          if (oldStream === s) {\n            return rest;\n          }\n          return prev;\n        });\n      }\n    };\n    setFaceStreamMap((prev) => {\n      const stream = prev[uid];\n      const newStream = addTrackToStream(track, stream, disposeStream);\n      if (stream === newStream) {\n        return prev;\n      }\n      return { ...prev, [uid]: newStream };\n    });\n  };\n\n  const trackMap = useProxy(getRoomState(roomId, userId).trackMap);\n  Object.entries(trackMap[videoType] || {}).forEach(onTrack);\n  Object.entries(trackMap[audioType] || {}).forEach(onTrack);\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    let dispose: (() => void) | null = null;\n    if (videoEnabled) {\n      (async () => {\n        const {\n          stream: videoStream,\n          dispose: disposeVideo,\n        } = await getFaceVideoStream(videoDeviceId);\n        const [videoTrack] = videoStream.getVideoTracks();\n        roomState.addMediaType(videoType);\n        roomState.addTrack(videoType, videoTrack);\n        const disposeStream = (s: MediaStream) => {\n          if (isMounted.current) {\n            setFaceStream((prev) => (prev === s ? null : prev));\n          }\n        };\n        setFaceStream((prev) =>\n          addTrackToStream(videoTrack, prev, disposeStream)\n        );\n        dispose = () => {\n          roomState.removeMediaType(videoType);\n          roomState.removeTrack(videoType);\n          disposeVideo();\n          // XXX we need to manually dispatch ended event, why?\n          videoTrack.dispatchEvent(new Event(\"ended\"));\n        };\n      })();\n    }\n    return () => {\n      if (dispose) dispose();\n    };\n  }, [roomId, userId, videoEnabled, videoDeviceId, videoType]);\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    let dispose: (() => void) | null = null;\n    if (audioEnabled) {\n      (async () => {\n        const {\n          stream: audioStream,\n          dispose: disposeAudio,\n        } = await getAudioStream(audioDeviceId);\n        const [audioTrack] = audioStream.getAudioTracks();\n        roomState.addMediaType(audioType);\n        roomState.addTrack(audioType, audioTrack);\n        const disposeStream = (s: MediaStream) => {\n          if (isMounted.current) {\n            setFaceStream((prev) => (prev === s ? null : prev));\n          }\n        };\n        setFaceStream((prev) =>\n          addTrackToStream(audioTrack, prev, disposeStream)\n        );\n        dispose = () => {\n          roomState.removeMediaType(audioType);\n          roomState.removeTrack(audioType);\n          disposeAudio();\n          // XXX we need to manually dispatch ended event, why?\n          audioTrack.dispatchEvent(new Event(\"ended\"));\n        };\n      })();\n    }\n    return () => {\n      if (dispose) dispose();\n    };\n  }, [roomId, userId, audioEnabled, audioDeviceId, audioType]);\n  useEffect(() => {\n    if (faceStream) {\n      faceStream.getAudioTracks().forEach((track) => {\n        const audioTrack = track;\n        audioTrack.enabled = micOn;\n      });\n      const onaddtrack = (event: MediaStreamTrackEvent) => {\n        const { track } = event;\n        if (track.kind === \"audio\") {\n          track.enabled = micOn;\n        }\n      };\n      faceStream.addEventListener(\"addtrack\", onaddtrack);\n      return () => {\n        faceStream.removeEventListener(\"addtrack\", onaddtrack);\n      };\n    }\n    return undefined;\n  }, [faceStream, micOn]);\n\n  return { faceStream, faceStreamMap };\n};\n"],"sourceRoot":""}