(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[11],{1232:function(e,t,n){},1252:function(e,t,n){"use strict";n.r(t),n.d(t,"SpatialArea",(function(){return y}));var a=n(97),r=n(1),c=n.n(r),i=n(3),s=n(5),u=n(0),o=n(2),d=n.n(o),f=n(190),l=n(514),v=n(1240),b=n(1246),p=(n(1232),n(98)),j=n(95),m=n(111),O=function(e,t,n){var r,c=Object(o.useState)({}),i=Object(s.a)(c,2),u=i[0],d=i[1],f=Object(o.useState)({statusMesg:n,position:(r=t,[parseInt(r.slice(0,2),16)/128-1,parseInt(r.slice(2,4),16)/128-1,0])}),l=Object(s.a)(f,2),v=l[0],b=l[1];Object(o.useEffect)((function(){b((function(e){return e.statusMesg===n?e:Object(a.a)(Object(a.a)({},e),{},{statusMesg:n})}))}),[n]);var O=Object(o.useRef)();Object(o.useEffect)((function(){O.current=v}),[v]);var h=Object(m.a)(e,t),x=Object(o.useRef)();return Object(o.useEffect)((function(){if(v){var e={spatialArea:"avatar",userId:t,avatarData:v};x.current?x.current=e:(x.current=e,setTimeout((function(){h(x.current),x.current=void 0}),500))}}),[h,t,v]),Object(m.b)(e,t,Object(o.useCallback)((function(e){var t;if(t=e,Object(j.c)(t)&&("init"===t.spatialArea||"avatar"===t.spatialArea&&function(e){try{var t=e;return"string"===typeof t.statusMesg&&"number"===typeof t.position[0]&&"number"===typeof t.position[1]&&"number"===typeof t.position[2]}catch(n){return!1}}(t.avatarData)))if("init"===e.spatialArea)O.current&&h({spatialArea:"avatar",avatarData:O.current});else if("avatar"===e.spatialArea){var n=e.userId,r=e.avatarData;d((function(e){return Object(a.a)(Object(a.a)({},e),{},Object(p.a)({},n,r))}))}}),[h])),Object(o.useEffect)((function(){h({spatialArea:"init"})}),[h]),{avatarMap:u,myAvatar:v,setMyAvatar:b}},h=n(317),x=n(515),g=n(191),w=n(126),k=d.a.memo((function(e){var t=e.nickname,n=e.faceStream,r=e.statusMesg,d=e.position,p=e.setPosition,j=e.distance,m=e.muted,O=!!p,h=Object(l.b)(),x=h.size,g=h.viewport,k=x.width/g.width,M=Object(o.useRef)(),y=Object(v.a)((function(e){var t=e.first,n=Object(s.a)(e.initial,2),a=n[0],r=n[1],c=Object(s.a)(e.xy,2),i=c[0],u=c[1];t&&(M.current=d);var o=M.current,f=Object(s.a)(o,2),l=f[0],v=f[1];p&&p([l+(i-a)/k,v-(u-r)/k,0])})),S=function(e){var t=Object(o.useState)(),n=Object(s.a)(t,2),a=n[0],r=n[1];Object(o.useEffect)((function(){if(e){var t=e,n=function(){r(t.getVideoTracks()[0])};return e.addEventListener("addtrack",n),n(),function(){return e.removeEventListener("addtrack",n)}}}),[e]),Object(o.useEffect)((function(){a&&a.addEventListener("ended",(function(){r(void 0)}))}),[a]);var c=Object(o.useState)(),i=Object(s.a)(c,2),u=i[0],d=i[1];return Object(o.useEffect)((function(){if(a){var e=document.createElement("video");e.autoplay=!0,e.srcObject=new MediaStream([a]);var t=new f.VideoTexture(e);d(t)}}),[a]),u}(n),E=function(e,t){var n=Object(o.useState)(),a=Object(s.a)(n,2),r=a[0],u=a[1];Object(o.useEffect)((function(){if(e){var t=e,n=function(){u(t.getAudioTracks()[0])};return e.addEventListener("addtrack",n),n(),function(){return e.removeEventListener("addtrack",n)}}}),[e]),Object(o.useEffect)((function(){r&&r.addEventListener("ended",(function(){u(void 0)}))}),[r]);var d=Object(o.useRef)(null),f=Object(o.useState)(null),l=Object(s.a)(f,2),v=l[0],b=l[1],p=Object(o.useCallback)((function(e){d.current?(b(e),d.current(e)):b(null)}),[]);return Object(o.useEffect)((function(){if(!t&&r){var e=new AudioContext,n=e.createMediaStreamDestination(),a=e.createMediaStreamSource(new MediaStream([r])),s=e.createGain();s.gain.value=.5,b(.5),d.current=function(t){s.gain.setValueAtTime(t,e.currentTime)},a.connect(s),s.connect(n);var u=n.stream.getAudioTracks()[0],o=document.createElement("video");return o.autoplay=!0,o.setAttribute("playsinline",""),o.style.display="block",o.style.width="1px",o.style.height="1px",o.style.position="absolute",o.style.bottom="0px",document.body.appendChild(o),Object(i.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=MediaStream,e.next=3,Object(w.b)(u);case 3:e.t1=e.sent,e.t2=[e.t1],o.srcObject=new e.t0(e.t2);case 6:case"end":return e.stop()}}),e)})))(),function(){d.current=null,e.close(),u.dispatchEvent(new Event("ended")),document.body.removeChild(o)}}}),[t,r]),[v,p]}(n,O),A=Object(s.a)(E,2),I=A[0],C=A[1];return Object(o.useEffect)((function(){C(void 0===j||m?0:Math.min(1,Math.max(0,(5-j)/4)))}),[m,j,C]),S?Object(u.jsxs)(u.Fragment,{children:[Object(u.jsx)("sprite",Object(a.a)(Object(a.a)({},O&&y()),{},{position:d,children:Object(u.jsx)("spriteMaterial",{map:S})})),Object(u.jsx)(b.a,{color:"blue",fontSize:.3,anchorX:"left",anchorY:"top",position:[d[0]-.5,d[1]+.5,d[2]],children:t}),Object(u.jsx)(b.a,{color:"darkgreen",fontSize:.3,anchorX:"left",anchorY:"middle",font:"https://fonts.gstatic.com/ea/notosansjapanese/v6/NotoSansJP-Bold.woff",position:[d[0]-.5,d[1],d[2]],children:r}),null!==I&&Object(u.jsx)(b.a,{color:"red",fontSize:.3,anchorX:"left",anchorY:"bottom",position:[d[0]-.5,d[1]-.5,d[2]],children:I.toFixed(2)})]}):null})),M=d.a.memo((function(e){var t=e.userId,n=e.nickname,r=e.statusMesg,c=e.faceStream,i=e.nicknameMap,s=e.faceStreamMap,d=e.avatarMap,f=e.myAvatar,v=e.setMyAvatar,b=function(e){var t;return(null===(t=d[e])||void 0===t?void 0:t.statusMesg)||""},p=function(e){var t;return(null===(t=d[e])||void 0===t?void 0:t.position)||[0,0,0]},j=(null===f||void 0===f?void 0:f.position)||[0,0,0];return Object(u.jsx)(l.a,{children:Object(u.jsxs)(o.Suspense,{fallback:null,children:[Object(u.jsx)("ambientLight",{}),Object.keys(s).map((function(e){if(e===t)return null;var n=p(e),a=Math.hypot(n[0]-j[0],n[1]-j[1],n[2]-j[2]);return Object(u.jsx)(k,{nickname:i[e]||"",faceStream:s[e]||null,statusMesg:b(e),position:p(e),distance:a},e)})),Object(u.jsx)(k,{nickname:n,faceStream:c,statusMesg:r,position:j,setPosition:function(e){v((function(t){return Object(a.a)(Object(a.a)({},t),{},{position:e})}))},muted:!0})]})})})),y=d.a.memo((function(e){var t=e.roomId,n=e.userId,a=e.nickname,r=e.statusMesg,c=Object(h.b)(),i=Object(o.useState)(""),d=Object(s.a)(i,2),f=d[0],l=d[1],v=Object(h.a)(),b=Object(o.useState)(""),p=Object(s.a)(b,2),j=p[0],m=p[1],w=Object(x.a)(t,n,!!f,!!j,!!j,f,j,"spatialArea"),k=w.faceStream,y=w.faceStreamMap,S=Object(g.a)(t,n),E=O(t,n,r),A=E.avatarMap,I=E.myAvatar,C=E.setMyAvatar;return Object(u.jsxs)("div",{className:"SpatialArea-container",children:[Object(u.jsxs)("div",{children:["Select Camera:"," ",Object(u.jsxs)("select",{value:f,onChange:function(e){return l(e.target.value)},children:[Object(u.jsx)("option",{value:"",children:"None"}),c.map((function(e){return Object(u.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId)}))]})]}),Object(u.jsxs)("div",{children:["Select Mic:"," ",Object(u.jsxs)("select",{value:j,onChange:function(e){m(e.target.value)},children:[Object(u.jsx)("option",{value:"",children:"None"}),v.map((function(e){return Object(u.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId)}))]})]}),Object(u.jsx)("div",{className:"SpatialArea-body",children:Object(u.jsx)(M,{userId:n,nickname:a,statusMesg:r,faceStream:k,nicknameMap:S,faceStreamMap:y,avatarMap:A,myAvatar:I,setMyAvatar:C})})]})}));t.default=y},126:function(e,t,n){"use strict";n.d(t,"c",(function(){return o})),n.d(t,"b",(function(){return d})),n.d(t,"d",(function(){return f})),n.d(t,"a",(function(){return v}));var a=n(5),r=n(1),c=n.n(r),i=n(3),s=n(100),u=new WeakMap,o=function(e,t){if(u.has(e))return e;u.set(e,!0);var n=function(){var n=Object(i.a)(c.a.mark((function n(){var a;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,Object(s.a)(5e3);case 2:!(a=t.getTransceivers().find((function(t){return t.receiver.track===e})))||"inactive"!==a.currentDirection&&"sendonly"!==a.currentDirection||(e.stop(),e.dispatchEvent(new Event("ended")));case 4:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();return e.addEventListener("mute",n),e},d=function(e){return new Promise(function(){var t=Object(i.a)(c.a.mark((function t(n,a){var r,i,s,u;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=new RTCPeerConnection,i=new RTCPeerConnection,r.addEventListener("icecandidate",(function(e){var t=e.candidate;t&&i.addIceCandidate(t)})),i.addEventListener("icecandidate",(function(e){var t=e.candidate;t&&r.addIceCandidate(t)})),i.addEventListener("track",(function(e){n(e.track)})),e.addEventListener("ended",(function(){r.close(),i.close()})),r.addTrack(e),t.next=10,r.createOffer();case 10:return s=t.sent,t.next=13,r.setLocalDescription(s);case 13:return t.next=15,i.setRemoteDescription(s);case 15:return t.next=17,i.createAnswer();case 17:return u=t.sent,t.next=20,i.setLocalDescription(u);case 20:return t.next=22,r.setRemoteDescription(u);case 22:t.next=27;break;case 24:t.prev=24,t.t0=t.catch(0),a(t.t0);case 27:case"end":return t.stop()}}),t,null,[[0,24]])})));return function(e,n){return t.apply(this,arguments)}}())},f=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,a,r,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("video"===t.kind){e.next=2;break}throw new Error("track kind is not video");case 2:return n=document.createElement("canvas"),a=n.getContext("2d"),r=new ImageCapture(t),s=function(){var e=Object(i.a)(c.a.mark((function e(){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.grabFrame();case 3:return t=e.sent,n.width=t.width,n.height=t.height,a.drawImage(t,0,0),e.abrupt("return",n.toDataURL("image/jpeg"));case 10:return e.prev=10,e.t0=e.catch(0),console.log("failed to grab frame from viedeo track",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{getImage:s});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),l=function(e){return new Promise((function(t,n){var a=new Image;a.onload=function(){return t(a)},a.onerror=n,a.src=e}))},v=function(){var e=document.createElement("canvas"),t=e.getContext("2d"),n=e.captureStream().getVideoTracks();return{videoTrack:Object(a.a)(n,1)[0],setImage:function(){var n=Object(i.a)(c.a.mark((function n(a){var r;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,l(a);case 2:r=n.sent,e.width=r.width,e.height=r.height,t.drawImage(r,0,0);case 6:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}()}}}}]);
//# sourceMappingURL=11.f91714d0.chunk.js.map