{"version":3,"sources":["components/RegionEditor.tsx","components/GatherArea.tsx","hooks/useGatherArea.ts"],"names":["RegionEditor","React","memo","roomId","userId","useState","regionId","setRegionId","type","setType","left","setLeft","top","setTop","width","setWidth","height","setHeight","zIndex","setZIndex","background","setBackground","iframe","setIframe","className","value","onChange","e","target","Number","max","onClick","data","position","size","getRoomState","ydoc","getMap","set","addRegion","disabled","MomentaryChat","lazy","Region","nickname","id","highlight","boxShadow","undefined","style","title","src","frameBorder","fallback","SuspenseFallback","uniqueId","Avatar","statusMesg","image","setPosition","registerOnMouseDrag","stream","muted","isMyself","onMouseDown","preventDefault","currentTarget","offset","clientX","clientY","FaceCard","obsoleted","liveMode","micOn","speakerOn","GatherArea","avatar","suspended","videoDeviceId","audioDeviceId","useFaceImages","myImage","roomImages","uid","avatarMap","setAvatarMap","parseInt","slice","myAvatar","setMyAvatar","useEffect","roomState","map","listener","prev","copied","changed","forEach","a","b","userIdMap","x","obj","isAvatarData","Object","keys","observe","unsub","subscribe","unobserve","dataToBroadcast","useRef","current","setTimeout","regionMap","setRegionMap","next","includes","isRegionData","updateRegion","useCallback","useGatherArea","onMouseDragRef","onMouseMove","activeMeetingRegionId","sort","find","useFaceVideos","faceStream","faceStreamMap","showRegionEditor","setShowRegionEditor","onMouseUp","entries","regionData","avatarData","imageData","info","message","p"],"mappings":"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","file":"static/js/20.b203a223.chunk.js","sourcesContent":["import React, { useState } from \"react\";\n\nimport { getRoomState } from \"../states/roomMap\";\nimport { RegionData } from \"../hooks/useGatherArea\";\n\nexport const RegionEditor = React.memo<{\n  roomId: string;\n  userId: string;\n}>(({ roomId, userId }) => {\n  const [regionId, setRegionId] = useState(\"\");\n  const [type, setType] = useState<RegionData[\"type\"]>(\"background\");\n  const [left, setLeft] = useState(100);\n  const [top, setTop] = useState(100);\n  const [width, setWidth] = useState(100);\n  const [height, setHeight] = useState(100);\n  const [zIndex, setZIndex] = useState(0);\n  const [background, setBackground] = useState(\"\");\n  const [iframe, setIframe] = useState(\"\");\n\n  const addRegion = () => {\n    const data: RegionData = {\n      type,\n      position: [left, top],\n      size: [width, height],\n      zIndex,\n      background,\n      iframe,\n    };\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(\"gatherRegionMap\");\n    map.set(regionId, data);\n  };\n\n  return (\n    <div className=\"RegionEditor-container\">\n      <h3>Region Editor</h3>\n      <label>\n        Region ID:{\" \"}\n        <input value={regionId} onChange={(e) => setRegionId(e.target.value)} />\n      </label>\n      <hr />\n      <label>\n        Type:{\" \"}\n        <select\n          value={type}\n          onChange={(e) => setType(e.target.value as RegionData[\"type\"])}\n        >\n          <option value=\"background\">Background</option>\n          <option value=\"meeting\">Meeting</option>\n          <option value=\"chat\">Chat</option>\n        </select>\n      </label>\n      <hr />\n      <label>\n        Left:{\" \"}\n        <input\n          type=\"number\"\n          value={left}\n          onChange={(e) => setLeft(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        Top:{\" \"}\n        <input\n          type=\"number\"\n          value={top}\n          onChange={(e) => setTop(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        Width:{\" \"}\n        <input\n          type=\"number\"\n          value={width}\n          onChange={(e) => setWidth(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        Height:{\" \"}\n        <input\n          type=\"number\"\n          value={height}\n          onChange={(e) => setHeight(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        zIndex:{\" \"}\n        <input\n          type=\"number\"\n          value={zIndex}\n          max={0}\n          onChange={(e) => setZIndex(Number(e.target.value))}\n        />\n      </label>\n      <hr />\n      <label>\n        Background:{\" \"}\n        <input\n          value={background}\n          onChange={(e) => setBackground(e.target.value)}\n        />\n      </label>\n      <hr />\n      <label>\n        Iframe:{\" \"}\n        <input value={iframe} onChange={(e) => setIframe(e.target.value)} />\n      </label>\n      <hr />\n      <button type=\"button\" onClick={() => addRegion()} disabled={!regionId}>\n        Add Region\n      </button>\n    </div>\n  );\n});\n","/* eslint jsx-a11y/no-static-element-interactions: off */\n\nimport React, { Suspense, useCallback, useRef, useState } from \"react\";\n\nimport \"./GatherArea.css\";\nimport { useGatherArea, RegionData } from \"../hooks/useGatherArea\";\nimport { useFaceImages } from \"../hooks/useFaceImages\";\nimport { useFaceVideos } from \"../hooks/useFaceVideos\";\nimport { RegionEditor } from \"./RegionEditor\";\nimport { FaceCard } from \"./FaceCard\";\nimport { SuspenseFallback } from \"./SuspenseFallback\";\n\nconst MomentaryChat = React.lazy(() => import(\"./MomentaryChat\"));\n\ntype OnMouseMove = (e: React.MouseEvent<HTMLDivElement, MouseEvent>) => void;\n\nconst Region = React.memo<{\n  roomId: string;\n  userId: string;\n  nickname: string;\n  id: string;\n  data: RegionData;\n  highlight?: boolean;\n}>(({ roomId, userId, nickname, id, data, highlight }) => {\n  const boxShadow =\n    (data.type === \"meeting\" &&\n      (highlight ? \"0 0 0 5px pink\" : \"0 0 0 1px pink\")) ||\n    undefined;\n  return (\n    <div\n      className=\"GatherArea-region\"\n      style={{\n        left: `${data.position[0]}px`,\n        top: `${data.position[1]}px`,\n        width: `${data.size[0]}px`,\n        height: `${data.size[1]}px`,\n        boxShadow,\n        zIndex: data.type !== \"chat\" ? data.zIndex : undefined,\n        background: data.background,\n      }}\n    >\n      {data.iframe && <iframe title={id} src={data.iframe} frameBorder=\"0\" />}\n      {data.type === \"chat\" && (\n        <Suspense fallback={<SuspenseFallback />}>\n          <MomentaryChat\n            roomId={roomId}\n            userId={userId}\n            nickname={nickname}\n            uniqueId={id}\n          />\n        </Suspense>\n      )}\n    </div>\n  );\n});\n\nconst Avatar = React.memo<{\n  nickname: string;\n  statusMesg: string;\n  image?: string;\n  position: [left: number, top: number];\n  setPosition?: (nextPosition: [number, number]) => void;\n  registerOnMouseDrag: (onMouseMove?: OnMouseMove) => void;\n  stream?: MediaStream;\n  muted?: boolean;\n}>(\n  ({\n    nickname,\n    statusMesg,\n    image,\n    position,\n    setPosition,\n    registerOnMouseDrag,\n    stream,\n    muted,\n  }) => {\n    const isMyself = !!setPosition;\n    return (\n      <div\n        className=\"GatherArea-avatar\"\n        style={{\n          left: `${position[0]}px`,\n          top: `${position[1]}px`,\n        }}\n        onMouseDown={(e) => {\n          e.preventDefault();\n          if (isMyself) {\n            const target = e.currentTarget;\n            const offset = [e.clientX - position[0], e.clientY - position[1]];\n            registerOnMouseDrag((e) => {\n              const left = e.clientX - offset[0];\n              const top = e.clientY - offset[1];\n              target.style.left = `${left}px`;\n              target.style.top = `${top}px`;\n              setPosition?.([left, top]);\n            });\n          }\n        }}\n      >\n        <FaceCard\n          image={image}\n          nickname={nickname}\n          statusMesg={statusMesg}\n          obsoleted={false}\n          liveMode={!!stream}\n          stream={stream}\n          muted={!!muted}\n          micOn={!!stream}\n          speakerOn={!!stream}\n        />\n      </div>\n    );\n  }\n);\n\nexport const GatherArea = React.memo<{\n  roomId: string;\n  userId: string;\n  avatar: string;\n  nickname: string;\n  statusMesg: string;\n  suspended: boolean;\n  videoDeviceId?: string;\n  audioDeviceId?: string;\n}>(\n  ({\n    roomId,\n    userId,\n    avatar,\n    nickname,\n    statusMesg,\n    suspended,\n    videoDeviceId,\n    audioDeviceId,\n  }) => {\n    const { myImage, roomImages } = useFaceImages(\n      roomId,\n      userId,\n      avatar,\n      nickname,\n      statusMesg,\n      suspended,\n      false,\n      false,\n      false,\n      videoDeviceId\n    );\n    const { avatarMap, myAvatar, setMyAvatar, regionMap } = useGatherArea(\n      roomId,\n      userId\n    );\n\n    const onMouseDragRef = useRef<OnMouseMove>();\n    const registerOnMouseDrag = useCallback((onMouseMove?: OnMouseMove) => {\n      onMouseDragRef.current = onMouseMove;\n    }, []);\n\n    const regionIdList = Object.keys(regionMap).sort(\n      (a, b) => (regionMap[b].zIndex ?? 0) - (regionMap[a].zIndex ?? 0)\n    );\n    const activeMeetingRegionId = regionIdList.find((id) => {\n      const { type, position, size } = regionMap[id] as RegionData;\n      return (\n        type === \"meeting\" &&\n        position[0] <= myAvatar.position[0] &&\n        position[1] <= myAvatar.position[1] &&\n        myAvatar.position[0] + 36 <= position[0] + size[0] &&\n        myAvatar.position[1] + 36 <= position[1] + size[1]\n      );\n    });\n\n    const { faceStream, faceStreamMap } = useFaceVideos(\n      roomId,\n      userId,\n      !!activeMeetingRegionId,\n      !!activeMeetingRegionId,\n      true,\n      videoDeviceId,\n      audioDeviceId,\n      `gatherArea/meeting/${activeMeetingRegionId}/`\n    );\n\n    const [showRegionEditor, setShowRegionEditor] = useState(false);\n\n    return (\n      <div className=\"GatherArea-container\">\n        <div\n          className=\"GatherArea-body\"\n          onMouseMove={(e) => {\n            if (onMouseDragRef.current) {\n              onMouseDragRef.current(e);\n            }\n          }}\n          onMouseUp={() => {\n            registerOnMouseDrag();\n          }}\n        >\n          {Object.entries(regionMap).map(([regionId, regionData]) => (\n            <Region\n              key={regionId}\n              roomId={roomId}\n              userId={userId}\n              nickname={nickname}\n              id={regionId}\n              data={regionData}\n              highlight={regionId === activeMeetingRegionId}\n            />\n          ))}\n          {Object.entries(avatarMap).map(([uid, avatarData]) => {\n            if (uid === userId) {\n              return null;\n            }\n            const imageData = roomImages.find((data) => data.userId === uid);\n            if (!imageData) {\n              return null;\n            }\n            return (\n              <Avatar\n                key={uid}\n                nickname={imageData.info.nickname}\n                statusMesg={imageData.info.message}\n                image={imageData.image}\n                position={avatarData.position}\n                registerOnMouseDrag={registerOnMouseDrag}\n                stream={faceStreamMap[uid]}\n              />\n            );\n          })}\n          <Avatar\n            nickname={nickname}\n            statusMesg={statusMesg}\n            image={myImage}\n            position={myAvatar.position}\n            setPosition={(position) =>\n              setMyAvatar((prev) => ({ ...prev, position }))\n            }\n            registerOnMouseDrag={registerOnMouseDrag}\n            stream={faceStream || undefined}\n            muted\n          />\n        </div>\n        <div className=\"GatherArea-toolbar\">\n          <div>\n            <button\n              type=\"button\"\n              onClick={() => setShowRegionEditor((p) => !p)}\n            >\n              {showRegionEditor ? \"Close Region Editor\" : \"Open Region Editor\"}\n            </button>\n            {showRegionEditor && (\n              <div className=\"GatherArea-region-editor\">\n                <RegionEditor roomId={roomId} userId={userId} />\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    );\n  }\n);\n\nexport default GatherArea;\n","import { useCallback, useState, useRef, useEffect } from \"react\";\nimport { subscribe } from \"valtio\";\n\nimport { getRoomState } from \"../states/roomMap\";\n\nconst getInitialPosition = (uid: string): [number, number] => [\n  parseInt(uid.slice(0, 2), 16) / 2 + 20,\n  parseInt(uid.slice(2, 4), 16) / 2 + 20,\n];\n\nexport type AvatarData = {\n  position: [left: number, top: number];\n};\n\nconst isAvatarData = (x: unknown): x is AvatarData => {\n  try {\n    const obj = x as AvatarData;\n    if (\n      typeof obj.position[0] === \"number\" &&\n      typeof obj.position[1] === \"number\"\n    ) {\n      return true;\n    }\n    return false;\n  } catch (e) {\n    return false;\n  }\n};\n\nconst isEqualAvatarData = (a: AvatarData, b: AvatarData) =>\n  a.position[0] === b.position[0] && a.position[1] === b.position[1];\n\nexport type RegionData = {\n  type: \"background\" | \"meeting\" | \"chat\";\n  position: [left: number, top: number];\n  size: [width: number, height: number];\n  zIndex?: number;\n  background?: string;\n  iframe?: string;\n};\n\nconst isRegionData = (x: unknown): x is RegionData => {\n  try {\n    const obj = x as RegionData;\n    if (\n      [\"background\", \"meeting\", \"chat\"].includes(obj.type) &&\n      typeof obj.position[0] === \"number\" &&\n      typeof obj.position[1] === \"number\" &&\n      typeof obj.size[0] === \"number\" &&\n      typeof obj.size[1] === \"number\" &&\n      (typeof obj.zIndex === \"undefined\" || typeof obj.zIndex === \"number\") &&\n      (typeof obj.background === \"undefined\" ||\n        typeof obj.background === \"string\") &&\n      (typeof obj.iframe === \"undefined\" || typeof obj.iframe === \"string\")\n    ) {\n      return true;\n    }\n    return false;\n  } catch (e) {\n    return false;\n  }\n};\n\nconst isEqualRegionData = (a: RegionData, b: RegionData) =>\n  a.type === b.type &&\n  a.position[0] === b.position[0] &&\n  a.position[1] === b.position[1] &&\n  a.size[0] === b.size[0] &&\n  a.size[1] === b.size[1] &&\n  a.zIndex === b.zIndex &&\n  a.background === b.background &&\n  a.iframe === b.iframe;\n\nexport type AvatarMap = {\n  [userId: string]: AvatarData;\n};\n\nexport type RegionMap = {\n  [regionId: string]: RegionData;\n};\n\nexport const useGatherArea = (roomId: string, userId: string) => {\n  const [avatarMap, setAvatarMap] = useState<AvatarMap>({});\n  const [myAvatar, setMyAvatar] = useState<AvatarData>({\n    position: getInitialPosition(userId),\n  });\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(\"gatherAvatarMap\");\n    const listener = () => {\n      setAvatarMap((prev) => {\n        const copied = { ...prev };\n        let changed = false;\n        map.forEach((data, uid) => {\n          if (uid === userId) return;\n          if (!roomState.userIdMap[uid]) return;\n          if (!isAvatarData(data)) return;\n          if (!copied[uid]) {\n            copied[uid] = data;\n            changed = true;\n          } else if (!isEqualAvatarData(data, copied[uid])) {\n            copied[uid] = data;\n            changed = true;\n          }\n        });\n        Object.keys(copied).forEach((uid) => {\n          if (!roomState.userIdMap[uid]) {\n            delete copied[uid];\n            changed = true;\n          }\n        });\n        if (changed) {\n          return copied;\n        }\n        return prev;\n      });\n    };\n    map.observe(listener);\n    const unsub = subscribe(roomState.userIdMap, listener);\n    listener();\n    return () => {\n      unsub();\n      map.unobserve(listener);\n    };\n  }, [roomId, userId]);\n\n  const dataToBroadcast = useRef<AvatarData>();\n  useEffect(() => {\n    if (!myAvatar) return;\n    if (dataToBroadcast.current) {\n      dataToBroadcast.current = myAvatar;\n    } else {\n      dataToBroadcast.current = myAvatar;\n      setTimeout(() => {\n        const roomState = getRoomState(roomId, userId);\n        const map = roomState.ydoc.getMap(\"gatherAvatarMap\");\n        map.set(userId, dataToBroadcast.current);\n        dataToBroadcast.current = undefined;\n      }, 500);\n    }\n  }, [roomId, userId, myAvatar]);\n\n  const [regionMap, setRegionMap] = useState<RegionMap>({});\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    const map = roomState.ydoc.getMap(\"gatherRegionMap\");\n    const listener = () => {\n      setRegionMap((prev) => {\n        const next: RegionMap = {};\n        map.forEach((data, id) => {\n          if (!isRegionData(data)) return;\n          if (prev[id] && isEqualRegionData(prev[id], data)) {\n            next[id] = prev[id];\n          } else {\n            next[id] = data;\n          }\n        });\n        return next;\n      });\n    };\n    map.observe(listener);\n    listener();\n    return () => {\n      map.unobserve(listener);\n    };\n  }, [roomId, userId]);\n\n  const updateRegion = useCallback(\n    (id: string, data: RegionData) => {\n      const roomState = getRoomState(roomId, userId);\n      const map = roomState.ydoc.getMap(\"gatherRegionMap\");\n      map.set(id, data);\n    },\n    [roomId, userId]\n  );\n\n  return {\n    avatarMap,\n    myAvatar,\n    setMyAvatar,\n    regionMap,\n    updateRegion,\n  };\n};\n"],"sourceRoot":""}