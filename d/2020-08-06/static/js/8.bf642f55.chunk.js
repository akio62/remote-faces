(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[8],{100:function(e,n,t){"use strict";t.d(n,"a",(function(){return r}));var r=function(e){return new Promise((function(n){return setTimeout(n,e)}))}},104:function(e,n,t){"use strict";t.d(n,"c",(function(){return r})),t.d(n,"b",(function(){return c})),t.d(n,"a",(function(){return o}));var r=function(e){return"object"===typeof e&&null!==e},c=function(e,n){return"string"===typeof e[n]},o=function(e,n){return r(e[n])}},158:function(e,n,t){"use strict";t.d(n,"b",(function(){return s})),t.d(n,"a",(function(){return u}));var r=t(1),c=t.n(r),o=t(2),a=t(100),i=new WeakMap,s=function(e,n){if(i.has(e))return e;i.set(e,!0);var t=function(){var t=Object(o.a)(c.a.mark((function t(){var r;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Object(a.a)(5e3);case 2:!(r=n.getTransceivers().find((function(n){return n.receiver.track===e})))||"inactive"!==r.currentDirection&&"sendonly"!==r.currentDirection||(e.stop(),e.dispatchEvent(new Event("ended")));case 4:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();return e.addEventListener("mute",t),e},u=function(e){return new Promise(function(){var n=Object(o.a)(c.a.mark((function n(t,r){var o,a,i,s;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,o=new RTCPeerConnection,a=new RTCPeerConnection,o.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&a.addIceCandidate(n)})),a.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&o.addIceCandidate(n)})),a.addEventListener("track",(function(e){t(e.track)})),e.addEventListener("ended",(function(){o.close(),a.close()})),o.addTrack(e),n.next=10,o.createOffer();case 10:return i=n.sent,n.next=13,o.setLocalDescription(i);case 13:return n.next=15,a.setRemoteDescription(i);case 15:return n.next=17,a.createAnswer();case 17:return s=n.sent,n.next=20,a.setLocalDescription(s);case 20:return n.next=22,o.setRemoteDescription(s);case 22:n.next=27;break;case 24:n.prev=24,n.t0=n.catch(0),r(n.t0);case 27:case"end":return n.stop()}}),n,null,[[0,24]])})));return function(e,t){return n.apply(this,arguments)}}())}},481:function(e,n){function t(e){var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}t.keys=function(){return[]},t.resolve=t,e.exports=t,t.id=481},51:function(e,n,t){"use strict";t.r(n),t.d(n,"createRoom",(function(){return b}));var r=t(1),c=t.n(r),o=t(2),a=t(480),i=t.n(a),s=t(100),u=t(6),d=t(4),f=t(104),p=t(13),l=function(e,n){return"string"===typeof n&&n.startsWith("".concat(e.slice(0,p.a)," "))},v=function(e,n){return"".concat(e.slice(0,p.a)," ").concat(n)},y=function(e){return Number(e.split(" ")[1])},g=function(e){return y(e.peer)},C=function(){var e=new Map;return{addConn:function(n){var t=e.get(n.peer);t&&t.conn.close(),e.set(n.peer,{conn:n,mediaTypes:[]})},markConnected:function(n){var t=e.get(n.peer);t&&(t.connected=!0)},isConnected:function(n){var t=e.get(n);return t&&t.connected||!1},setUserId:function(n,t){var r=e.get(n.peer);r&&(r.userId=t)},getUserId:function(n){var t=e.get(n.peer);return t&&t.userId},setMediaTypes:function(n,t){var r=e.get(n.peer);r&&(r.mediaTypes=t)},getMediaTypes:function(n){var t=e.get(n.peer);return t&&t.mediaTypes||[]},hasConn:function(n){return e.has(n)},getConn:function(n){var t=e.get(n);return t?t.conn:null},delConn:function(n){var t=e.get(n.peer);t&&t.conn===n&&e.delete(n.peer)},getConnectedPeerIds:function(){return Array.from(e.keys()).filter((function(n){var t;return null===(t=e.get(n))||void 0===t?void 0:t.connected}))},forEachConnectedConns:function(n){Array.from(e.values()).forEach((function(e){e.connected&&n(e.conn)}))},forEachConnsAcceptingMedia:function(n,t){Array.from(e.values()).forEach((function(e){e.connected&&e.mediaTypes&&e.mediaTypes.includes(n)&&t(e.conn)}))},clearAll:function(){e.size&&console.log("connectionMap garbage:",e),e.clear()}}},k=t(158),h=function(e){var n=y(e);return 10<=n&&n<=14},b=function(){var e=Object(o.a)(c.a.mark((function e(n,t,r,a,b,m){var x,E,w,T,O,I,M,P,N,j,D,R,S,A,L,_,U,W,G,J,z,F,K,V,Z,q,B,H,Q;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return x=!1,E=null,w=C(),T=[],O=null,e.next=7,Object(u.f)(n.slice(p.a));case 7:return I=e.sent,M=function(){if(!x){var e=w.getConnectedPeerIds().map(y);r({type:"CONNECTED_PEERS",peerIndexList:e})}},P=function(e){if(!x&&E&&E.id!==e&&!E.disconnected&&!w.hasConn(e)){console.log("connectPeer",e);var n=E.connect(e);J(n)}},N=function(e){if(!x){var n=w.getConnectedPeerIds();w.forEachConnectedConns((function(r){W(r,{userId:t,data:e,peers:n,mediaTypes:T})}))}},j=function(e,r){if(!x){var c=w.getConn(v(n,r));if(c){var o=w.getConnectedPeerIds();W(c,{userId:t,data:e,peers:o,mediaTypes:T})}}},D=function(e,n){W(e,{SDP:n})},R=function(){var e=Object(o.a)(c.a.mark((function e(n,t){var r,o,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(f.c)(t)){e.next=2;break}return e.abrupt("return");case 2:if(!Object(f.c)(t.offer)){e.next=21;break}return r=t.offer,e.prev=4,e.next=7,n.peerConnection.setRemoteDescription(r);case 7:return B(n),e.next=10,n.peerConnection.createAnswer();case 10:return o=e.sent,e.next=13,n.peerConnection.setLocalDescription(o);case 13:D(n,{answer:o}),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(4),console.info("handleSDP offer failed",e.t0);case 19:e.next=38;break;case 21:if(!Object(f.c)(t.answer)){e.next=37;break}return a=t.answer,e.prev=23,e.next=26,n.peerConnection.setRemoteDescription(a);case 26:e.next=35;break;case 28:return e.prev=28,e.t1=e.catch(23),console.info("handleSDP answer failed",e.t1),e.next=33,Object(s.a)(30*Math.random()*1e3);case 33:H(n),B(n);case 35:e.next=38;break;case 37:console.warn("unknown SDP",t);case 38:case"end":return e.stop()}}),e,null,[[4,16],[23,28]])})));return function(n,t){return e.apply(this,arguments)}}(),S=function(e,n){"string"===typeof n&&w.setUserId(e,n)},A=function(){var e=Object(o.a)(c.a.mark((function e(n,t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(t)||!t.every((function(e){return"string"===typeof e}))){e.next=5;break}return w.setMediaTypes(n,t),e.next=4,Object(s.a)(5e3);case 4:B(n);case 5:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),L=function(e){Array.isArray(e)&&e.forEach((function(e){l(n,e)&&P(e)}))},_=function(e,n){var t=w.getUserId(e);if(t){var r={userId:t,peerIndex:g(e),mediaTypes:w.getMediaTypes(e)};try{b(n,r)}catch(c){console.warn("receiveData",c)}}},U=function(){var e=Object(o.a)(c.a.mark((function e(n,t){var r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!x){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.t0=JSON,e.next=6,Object(u.a)(t,I);case 6:if(e.t1=e.sent,r=e.t0.parse.call(e.t0,e.t1),console.log("decrypted payload",n.peer,r),Object(f.c)(r)){e.next=11;break}return e.abrupt("return");case 11:R(n,r.SDP),S(n,r.userId),A(n,r.mediaTypes),L(r.peers),_(n,r.data),e.next=21;break;case 18:e.prev=18,e.t2=e.catch(2),console.info("Error in handlePayload",e.t2,t);case 21:case"end":return e.stop()}}),e,null,[[2,18]])})));return function(n,t){return e.apply(this,arguments)}}(),W=function(){var e=Object(o.a)(c.a.mark((function e(n,t){var r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(u.c)(JSON.stringify(t),I);case 3:r=e.sent,n.send(r),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),console.error("sendPayload",e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(n,t){return e.apply(this,arguments)}}(),G=new WeakMap,J=function(e){w.isConnected(e.peer)?e.close():(w.addConn(e),e.on("open",(function(){w.markConnected(e),console.log("dataConnection open",e),M();var n=y(e.peer);a(n)})),e.on("data",(function(n){return U(e,n)})),e.peerConnection.addEventListener("icegatheringstatechange",(function(){var n=e.peerConnection;"complete"===n.iceGatheringState&&(n.onicecandidate=function(){})})),e.peerConnection.addEventListener("negotiationneeded",Object(o.a)(c.a.mark((function n(){var t;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!G.has(e)){n.next=2;break}return n.abrupt("return");case 2:return G.set(e,!0),n.next=5,Object(s.a)(2e3);case 5:if(G.delete(e),w.isConnected(e.peer)){n.next=8;break}return n.abrupt("return");case 8:return n.next=10,e.peerConnection.createOffer();case 10:return t=n.sent,n.next=13,e.peerConnection.setLocalDescription(t);case 13:D(e,{offer:t});case 14:case"end":return n.stop()}}),n)})))),e.peerConnection.addEventListener("track",(function(n){var t=w.getUserId(e);if(t){var r={userId:t,peerIndex:y(e.peer),mediaTypes:w.getMediaTypes(e)};m(Object(k.b)(n.track,e.peerConnection),r)}})),e.on("close",(function(){if(w.delConn(e),console.log("dataConnection closed",e),r({type:"CONNECTION_CLOSED",peerIndex:g(e)}),M(),0===w.getConnectedPeerIds().length)F(!0);else if(h(e.peer)&&E&&!E.disconnected&&!h(E.id)){var n=30+Math.floor(60*Math.random());console.log("Disconnected seed peer: ".concat(y(e.peer),", reinit in ").concat(n,"sec...")),setTimeout(F,1e3*n)}})))},(z=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;if(!x&&!E){w.clearAll();var c=10<=t&&t<=14,o=c?t:Object(u.g)();r({type:"INITIALIZING_PEER",peerIndex:o});var a=v(n,o);console.log("initMyPeer start",t,a);var s=new i.a(a,Object(d.c)());E=s,s.on("open",(function(){E=s,r({type:"CONNECTING_SEED_PEERS"});for(var e=10;e<=14;e+=1){var t=v(n,e);P(t)}})),s.on("error",(function(n){"unavailable-id"===n.type?(E=null,s.destroy(),e(t+1)):"peer-unavailable"===n.type||("disconnected"===n.type?(console.log("initMyPeer disconnected error",t,n),s.destroy()):"network"===n.type?console.log("initMyPeer network error",t,n):"server-error"===n.type?(console.log("initMyPeer server error",t,n),r({type:"SERVER_ERROR"})):(console.error("initMyPeer unknown error",t,n.type,n),r({type:"UNKNOWN_ERROR",err:n})))})),s.on("connection",(function(e){E===s?(console.log("new connection received",e),r({type:"NEW_CONNECTION",peerIndex:g(e)}),J(e)):e.close()})),s.on("disconnected",(function(){console.log("initMyPeer disconnected",t),setTimeout((function(){E!==s||s.destroyed||(console.log("initMyPeer reconnecting",t),r({type:"RECONNECTING"}),s.reconnect())}),5e3)})),s.on("close",(function(){E===s?(console.log("initMyPeer closed, re-initializing",t),E=null,setTimeout(e,2e4)):console.log("initMyPeer closed, ignoring",t)}))}})(),F=function(e){if(E&&!E.disconnected){if(!e){if(h(E.id))return;for(var t=!0,r=10;r<=14;r+=1){var c=v(n,r);if(!w.isConnected(c)){t=!1;break}}if(t)return void M()}var o=E;E=null,o.destroy(),z()}},K=function(e){(T=e).length?O||(O=new MediaStream,w.forEachConnectedConns((function(e){var n=w.getUserId(e);if(n){var t={userId:n,peerIndex:y(e.peer),mediaTypes:w.getMediaTypes(e)};e.peerConnection.getReceivers().forEach((function(n){"live"===n.track.readyState&&m(Object(k.b)(n.track,e.peerConnection),t)}))}}))):O=null,N(null)},V=new WeakMap,Z=function(e,n){O&&(V.set(n,e),O.addTrack(n),w.forEachConnsAcceptingMedia(e,(function(e){try{if(!O)return;e.peerConnection.addTrack(n,O)}catch(t){if("InvalidAccessError"!==t.name)throw t}})))},q=function(e,n){O&&O.removeTrack(n),w.forEachConnsAcceptingMedia(e,(function(e){var t=e.peerConnection.getSenders().find((function(e){return e.track===n}));t&&e.peerConnection.removeTrack(t)}))},B=function(e){var n=e.peerConnection.getSenders(),t=w.getMediaTypes(e);O&&O.getTracks().forEach((function(r){var c=V.get(r);O&&c&&t.includes(c)&&n.every((function(e){return e.track!==r}))&&e.peerConnection.addTrack(r,O)})),n.forEach((function(n){if(n.track){var r=V.get(n.track);r&&t.includes(r)||e.peerConnection.removeTrack(n)}})),n.some((function(e){return e.track&&!e.transport}))&&e.peerConnection.dispatchEvent(new Event("negotiationneeded"))},H=function(e){e.peerConnection.getSenders().forEach((function(n){n.track&&e.peerConnection.removeTrack(n)}))},Q=function(){x=!0,E&&E.destroy()},e.abrupt("return",{broadcastData:N,sendData:j,acceptMediaTypes:K,addTrack:Z,removeTrack:q,dispose:Q});case 33:case"end":return e.stop()}}),e)})));return function(n,t,r,c,o,a){return e.apply(this,arguments)}}()}}]);
//# sourceMappingURL=8.bf642f55.chunk.js.map