(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[16],{1232:function(e,t,a){},1255:function(e,t,a){"use strict";a.r(t),a.d(t,"SpatialArea",(function(){return A}));var n=a(1),r=a.n(n),c=a(2),i=a(5),o=a(0),u=a.n(o),s=a(332),l=a(1246),p=a(1244),v=(a(1232),a(112)),f=a(119),m=a(108),b=a(125),d=function(e){try{var t=e;return"number"===typeof t.position[0]&&"number"===typeof t.position[1]&&"number"===typeof t.position[2]}catch(a){return!1}},O=function(e){return Object(m.c)(e)&&function(e){return Object(m.c)(e)&&Object.values(e).every(d)}(e.avatarMap)&&"number"===typeof e.updatedAt},j=function(e,t){var a=Object(o.useState)({}),n=Object(i.a)(a,2),r=n[0],c=n[1],u=Object(o.useRef)(),s=Object(b.a)(e,t),l=Object(o.useRef)(),p=Object(o.useCallback)((function(e,t){var a,n=Object(f.a)(Object(f.a)({},null===(a=u.current)||void 0===a?void 0:a.avatarMap),{},Object(v.a)({},e,t));c(n),u.current={avatarMap:n,updatedAt:Date.now()};var r={spatialArea:"sync",areaData:u.current};l.current?l.current=r:(l.current=r,setTimeout((function(){s(r),l.current=void 0}),200))}),[s]);return Object(b.b)(e,t,Object(o.useCallback)((function(e){var t;if(t=e,Object(m.c)(t)&&("init"===t.spatialArea||"sync"===t.spatialArea&&O(t.areaData)))if("init"!==e.spatialArea){var a=e.areaData;u.current&&u.current.updatedAt>a.updatedAt||c((function(e){var t=Object.keys(e),n=Object.keys(a.avatarMap);return t.length===n.length&&t.every((function(t){return n=e[t],r=a.avatarMap[t],n.position[0]===r.position[0]&&n.position[1]===r.position[1]&&n.position[2]===r.position[2];var n,r}))?e:Object(f.a)(Object(f.a)({},e),a.avatarMap)}))}else u.current&&s({spatialArea:"sync",areaData:u.current})}),[s])),Object(o.useEffect)((function(){s({spatialArea:"init"})}),[s]),{avatarMap:r,setAvatar:p}},k=a(333),E=a(523),S=a(206),h=u.a.memo((function(e){var t=e.nickname,a=e.faceStream,n=e.position,v=e.setPosition,f=Object(l.b)(),m=f.size,b=f.viewport,d=m.width/b.width,O=Object(o.useRef)(),j=Object(p.a)((function(e){var t=e.first,a=Object(i.a)(e.initial,2),r=a[0],c=a[1],o=Object(i.a)(e.xy,2),u=o[0],s=o[1];t&&(O.current=n);var l=O.current,p=Object(i.a)(l,2),f=p[0],m=p[1];v([f+(u-r)/d,m-(s-c)/d,0]),console.log("set pos")}),{eventOptions:{pointer:!0}}),k=Object(o.useState)(),E=Object(i.a)(k,2),S=E[0],h=E[1];return Object(o.useEffect)((function(){var e=null===a||void 0===a?void 0:a.getVideoTracks()[0];if(e){var n=document.createElement("canvas"),i=new s.CanvasTexture(n);h(i);var o=new ImageCapture(e),u=n.getContext("2d"),l=setInterval(Object(c.a)(r.a.mark((function e(){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,o.grabFrame();case 3:a=e.sent,n.width=a.width,n.height=a.height,u.drawImage(a,0,0),u.font="18px selif",u.textBaseline="top",u.fillStyle="blue",u.fillText(t,2,2),i.needsUpdate=!0,e.next=16;break;case 14:e.prev=14,e.t0=e.catch(0);case 16:case"end":return e.stop()}}),e,null,[[0,14]])}))),1e3/7.5);return function(){clearInterval(l)}}}),[t,a]),S?u.a.createElement("sprite",Object.assign({},j(),{position:n}),u.a.createElement("spriteMaterial",{map:S})):null})),y=u.a.memo((function(e){var t=e.userId,a=e.nickname,n=e.faceStream,r=e.nicknameMap,c=e.faceStreamMap,i=e.avatarMap,s=e.setAvatar,p=function(e){var t;return(null===(t=i[e])||void 0===t?void 0:t.position)||function(e){return[parseInt(e.slice(0,2),16)/128-1,parseInt(e.slice(2,4),16)/128-1,0]}(e)},v=function(e){return function(t){s(e,{position:t})}};return u.a.createElement(l.a,null,u.a.createElement(o.Suspense,{fallback:null},u.a.createElement("ambientLight",null),Object.keys(c).map((function(e){return e!==t&&u.a.createElement(h,{key:e,nickname:r[e]||"",faceStream:c[e]||null,position:p(e),setPosition:v(e)})})),u.a.createElement(h,{nickname:a,faceStream:n,position:p(t),setPosition:v(t)})))})),A=u.a.memo((function(e){var t=e.roomId,a=e.userId,n=e.nickname,r=Object(k.b)(),c=Object(o.useState)(""),s=Object(i.a)(c,2),l=s[0],p=s[1],v=Object(k.a)(),f=Object(o.useState)(""),m=Object(i.a)(f,2),b=m[0],d=m[1],O=Object(E.a)(t,a,!!l,!!b,!!b,l,b,"spatialArea"),h=O.faceStream,A=O.faceStreamMap,M=Object(S.a)(t,a),g=j(t,a),w=g.avatarMap,I=g.setAvatar;return u.a.createElement("div",{className:"SpatialArea-container"},u.a.createElement("div",null,"Select Camera:"," ",u.a.createElement("select",{value:l,onChange:function(e){return p(e.target.value)}},u.a.createElement("option",{value:""},"None"),r.map((function(e){return u.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),u.a.createElement("div",null,"Select Mic:"," ",u.a.createElement("select",{value:b,onChange:function(e){d(e.target.value)}},u.a.createElement("option",{value:""},"None"),v.map((function(e){return u.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),u.a.createElement("div",{className:"SpatialArea-body"},u.a.createElement(y,{userId:a,nickname:n,faceStream:h,nicknameMap:M,faceStreamMap:A,avatarMap:w,setAvatar:I})))}));t.default=A}}]);
//# sourceMappingURL=16.ce90424f.chunk.js.map