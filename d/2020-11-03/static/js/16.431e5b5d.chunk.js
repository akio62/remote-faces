(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[16],{1232:function(e,t,a){},1255:function(e,t,a){"use strict";a.r(t),a.d(t,"SpatialArea",(function(){return A}));var n=a(1),r=a.n(n),c=a(2),i=a(5),u=a(0),o=a.n(u),s=a(332),l=a(1246),p=a(1244),v=(a(1232),a(112)),f=a(119),m=a(108),b=a(125),d=function(e){try{var t=e;return"number"===typeof t.position[0]&&"number"===typeof t.position[1]&&"number"===typeof t.position[2]}catch(a){return!1}},j=function(e){return Object(m.c)(e)&&function(e){return Object(m.c)(e)&&Object.values(e).every(d)}(e.avatarMap)&&"number"===typeof e.updatedAt},O=function(e,t){var a=Object(u.useState)({}),n=Object(i.a)(a,2),r=n[0],c=n[1],o=Object(u.useRef)(),s=Object(b.a)(e,t),l=Object(u.useRef)(),p=Object(u.useCallback)((function(e,t){var a,n=Object(f.a)(Object(f.a)({},null===(a=o.current)||void 0===a?void 0:a.avatarMap),{},Object(v.a)({},e,t));c(n),o.current={avatarMap:n,updatedAt:Date.now()};var r={spatialArea:"sync",areaData:o.current};l.current?l.current=r:(l.current=r,setTimeout((function(){s(r),l.current=void 0}),200))}),[s]);return Object(b.b)(e,t,Object(u.useCallback)((function(e){var t;if(t=e,Object(m.c)(t)&&("init"===t.spatialArea||"sync"===t.spatialArea&&j(t.areaData)))if("init"!==e.spatialArea){var a=e.areaData;o.current&&o.current.updatedAt>a.updatedAt||c((function(e){var t=Object.keys(e),n=Object.keys(a.avatarMap);return t.length===n.length&&t.every((function(t){return n=e[t],r=a.avatarMap[t],n.position[0]===r.position[0]&&n.position[1]===r.position[1]&&n.position[2]===r.position[2];var n,r}))?e:Object(f.a)(Object(f.a)({},e),a.avatarMap)}))}else o.current&&s({spatialArea:"sync",areaData:o.current})}),[s])),Object(u.useEffect)((function(){s({spatialArea:"init"})}),[s]),{avatarMap:r,setAvatar:p}},k=a(333),E=a(523),S=a(206),h=o.a.memo((function(e){var t=e.nickname,a=e.faceStream,n=e.position,v=e.setPosition,f=Object(l.b)(),m=f.size,b=f.viewport,d=m.width/b.width,j=Object(u.useRef)(),O=Object(p.a)((function(e){var t=e.first,a=Object(i.a)(e.initial,2),r=a[0],c=a[1],u=Object(i.a)(e.xy,2),o=u[0],s=u[1];t&&(j.current=n);var l=j.current,p=Object(i.a)(l,2),f=p[0],m=p[1];v([f+(o-r)/d,m-(s-c)/d,0])})),k=Object(u.useState)(),E=Object(i.a)(k,2),S=E[0],h=E[1];return Object(u.useEffect)((function(){var e=null===a||void 0===a?void 0:a.getVideoTracks()[0];if(e){var n=document.createElement("canvas"),i=new s.CanvasTexture(n);h(i);var u=new ImageCapture(e),o=n.getContext("2d"),l=setInterval(Object(c.a)(r.a.mark((function e(){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u.grabFrame();case 3:a=e.sent,n.width=a.width,n.height=a.height,o.drawImage(a,0,0),o.font="18px selif",o.textBaseline="top",o.fillStyle="blue",o.fillText(t,2,2),i.needsUpdate=!0,e.next=16;break;case 14:e.prev=14,e.t0=e.catch(0);case 16:case"end":return e.stop()}}),e,null,[[0,14]])}))),1e3/7.5);return function(){clearInterval(l)}}}),[t,a]),S?o.a.createElement("sprite",Object.assign({},O(),{position:n}),o.a.createElement("spriteMaterial",{map:S})):null})),y=o.a.memo((function(e){var t=e.userId,a=e.nickname,n=e.faceStream,r=e.nicknameMap,c=e.faceStreamMap,i=e.avatarMap,s=e.setAvatar,p=function(e){var t;return(null===(t=i[e])||void 0===t?void 0:t.position)||function(e){return[parseInt(e.slice(0,2),16)/128-1,parseInt(e.slice(2,4),16)/128-1,0]}(e)},v=function(e){return function(t){s(e,{position:t})}};return o.a.createElement(l.a,null,o.a.createElement(u.Suspense,{fallback:null},o.a.createElement("ambientLight",null),Object.keys(c).map((function(e){return e!==t&&o.a.createElement(h,{key:e,nickname:r[e]||"",faceStream:c[e]||null,position:p(e),setPosition:v(e)})})),o.a.createElement(h,{nickname:a,faceStream:n,position:p(t),setPosition:v(t)})))})),A=o.a.memo((function(e){var t=e.roomId,a=e.userId,n=e.nickname,r=Object(k.b)(),c=Object(u.useState)(""),s=Object(i.a)(c,2),l=s[0],p=s[1],v=Object(k.a)(),f=Object(u.useState)(""),m=Object(i.a)(f,2),b=m[0],d=m[1],j=Object(E.a)(t,a,!!l,!!b,!!b,l,b,"spatialArea"),h=j.faceStream,A=j.faceStreamMap,M=Object(S.a)(t,a),g=O(t,a),w=g.avatarMap,I=g.setAvatar;return o.a.createElement("div",{className:"SpatialArea-container"},o.a.createElement("div",null,"Select Camera:"," ",o.a.createElement("select",{value:l,onChange:function(e){return p(e.target.value)}},o.a.createElement("option",{value:""},"None"),r.map((function(e){return o.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),o.a.createElement("div",null,"Select Mic:"," ",o.a.createElement("select",{value:b,onChange:function(e){d(e.target.value)}},o.a.createElement("option",{value:""},"None"),v.map((function(e){return o.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),o.a.createElement("div",{className:"SpatialArea-body"},o.a.createElement(y,{userId:a,nickname:n,faceStream:h,nicknameMap:M,faceStreamMap:A,avatarMap:w,setAvatar:I})))}));t.default=A}}]);
//# sourceMappingURL=16.431e5b5d.chunk.js.map